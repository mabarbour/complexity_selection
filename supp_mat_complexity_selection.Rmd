---
title: "Supplementary Material for Food-web complexity alters the fitness landscape of an insect herbivore"
author: Matt Barbour
output: html_notebook
---

Load dataset. This dataset is a subset that only includes larva that survive to pupation or turned into parasitoids. We omitted any data where larva mortality was unclear. This enabled us to focus on the selection pressures imposed by insect parasitoids rather than other sources.
```{r Preliminaries, message=FALSE, warning=FALSE, include=FALSE}
## LOAD REQUIRED LIBRARIES & SET OPTIONS ----
library(tidyverse)
library(cowplot) # pretty default ggplots
library(broom) # for tidying multiple linear models
library(mgcv) # generalized additive models
library(gamm4) # generalized additive mixed-models
library(gsg) # calculating selection gradients
library(visreg)
library(viridis) # for color palette

## LOAD & MANAGE DATASET ----

gall_selection.df <- read_csv("gall_selection_data.csv") %>%
  # convert appropriate variables to characters instead of integers
  mutate(Plant_Position = as.character(Plant_Position),
         Gall_Number = as.character(Gall_Number)) %>%
  unite(Gall_ID, Gall_Number, Gall_Letter, remove = FALSE) %>%
  
  # subset data for analysis
  filter(phenology == "early", Location == "tree",
         platy > 0 | ectos > 0 | pupa > 0) %>%                  # eliminate unknown sources of mortality
  mutate(gall_survival = as.numeric(ifelse(pupa > 0, 1, 0)),
         egg_parasitoid = as.numeric(ifelse(platy > 0, 1, 0))) 

## CREATE SEPARATE DATASETS FOR SELECTION ANALYSES ----
control_df <- gall_selection.df %>%
  filter(Treatment.focus == "Control") %>%
  mutate(c.Gall_Height_mm = Gall_Height_mm - mean(Gall_Height_mm),
         c.gall_individuals = gall_individuals - mean(gall_individuals),
         c.Density_per_100_shoots = Density_per_100_shoots - mean(Density_per_100_shoots))

treatment_df <- gall_selection.df %>%
  filter(Treatment.focus == "Ectoparasitoid exclusion") %>%
  mutate(c.Gall_Height_mm = Gall_Height_mm - mean(Gall_Height_mm),
         c.gall_individuals = gall_individuals - mean(gall_individuals),
         c.Density_per_100_shoots = Density_per_100_shoots - mean(Density_per_100_shoots))
```

```{r FUNCTIONS}
gamm.model <- function(formula, data) {
  gamm4(formula, data, 
        random = ~(1|Plant_Position/Gall_Number), # Genotype/
        family = binomial(link = logit))
}

gam.plot <- function(gam.model, ...) {
  plot(gam.model, seWithMean = T, shift = mean(predict(gam.model)), trans = function(x) {exp(x)/(1+exp(x))}, ...)
}

# experimenting with boot.case gave bootstrapped distributions that weren't centered near the model mean estimate.
# also, using 'refit.smooth = T' also generated some very skewed distributions
# the recipe below provided the most sensible estimates for my data
gradient.calc <- function(mod, phenotype, covariates = NULL) {
  gam.gradients(mod, phenotype, covariates, parallel = 'multicore', ncpus = 32, 
                refit.smooth = F, 
                n.boot = 1000,
                se.method = 'boot.para',
                standardized = T)
} 

insect_FL <- function(mod, phenotype, covariates = NULL) {
  fitness.landscape(mod, phenotype, covariates, parallel = 'multicore', ncpus = 32,
                    PI.method = 'boot.para',
                    refit.smooth = F,
                    PI.interval = c(0.025,0.975),
                    plt.density = 100)
}

get_insect_FL.df <- function(FL){
  data.frame(mean_fitness = FL$Wbar, FL$points, t(FL$WbarPI)) %>%
    mutate(lower_2.5 = X2.5., upper_97.5 = X97.5.)
}

ggplot_uniFL <- function(FL.df) {
  ggplot(FL.df, aes(x = Var1, y = mean_fitness)) +
    geom_line() + 
    geom_ribbon(aes(ymin = lower_2.5, ymax = upper_97.5), alpha = 0.5)
}
```

Choosing the level of model complexity. We used AIC to pair down the complexity of the model. For both the control and treatment plants, there is support for maintaing the linear interaction between gall size and the number of individuals per gall. In both cases, AIC suggest that the models lacking linear interaction terms were more parsimonious, so we subsequently analyzed selection gradients with these models.

```{r AIC MODEL COMPLEXITY}

## CONTROL PLANTS ----
gamm_full.control <- gamm.model(gall_survival ~ 
                                  s(c.Gall_Height_mm) + 
                                  s(c.gall_individuals, k=9) + 
                                  s(c.Density_per_100_shoots) +
                                  c.Gall_Height_mm:c.gall_individuals + 
                                  c.Gall_Height_mm:c.Density_per_100_shoots + 
                                  c.gall_individuals:c.Density_per_100_shoots,
                                data = control_df)
summary(gamm_full.control$gam)
summary(gamm_full.control$mer)

gamm_red.control <- gamm.model(gall_survival ~ 
                                  s(c.Gall_Height_mm) + 
                                  s(c.gall_individuals, k=9) + 
                                  s(c.Density_per_100_shoots),
                                data = control_df)
summary(gamm_red.control$gam)
summary(gamm_red.control$mer)

AIC(gamm_full.control$mer, gamm_red.control$mer)

## TREATMENT PLANTS ----
gamm_full.treatment <- gamm.model(gall_survival ~ 
                                  s(c.Gall_Height_mm) + 
                                  s(c.gall_individuals, k=9) + 
                                  s(c.Density_per_100_shoots) +
                                  c.Gall_Height_mm:c.gall_individuals + 
                                  c.Gall_Height_mm:c.Density_per_100_shoots + 
                                  c.gall_individuals:c.Density_per_100_shoots,
                                data = treatment_df)
summary(gamm_full.treatment$gam)
summary(gamm_full.treatment$mer)

gamm_red.treatment <- gamm.model(gall_survival ~ 
                                  s(c.Gall_Height_mm) + 
                                  s(c.gall_individuals, k=9) + 
                                  s(c.Density_per_100_shoots),
                                data = treatment_df)
summary(gamm_red.treatment$gam)
summary(gamm_red.treatment$mer)

AIC(gamm_full.treatment$mer, gamm_red.treatment$mer)
```

```{r SELECTION GRADIENTS}

## GALL SIZE ----
sg.size_control <- gradient.calc(mod = gamm_red.control$gam, 
                                 phenotype = "c.Gall_Height_mm", 
                                 covariates = c("c.gall_individuals","c.Density_per_100_shoots"))
sg.size_treatment <- gradient.calc(mod = gamm_red.treatment$gam, 
                                   phenotype = "c.Gall_Height_mm", 
                                   covariates = c("c.gall_individuals","c.Density_per_100_shoots"))

## GALL INDIVIDUALS ----
sg.individuals_control <- gradient.calc(mod = gamm_red.control$gam, 
                                        phenotype = "c.gall_individuals", 
                                        covariates = c("c.Gall_Height_mm","c.Density_per_100_shoots"))
sg.individuals_treatment <- gradient.calc(mod = gamm_red.treatment$gam, 
                                          phenotype = "c.gall_individuals", 
                                          covariates = c("c.Gall_Height_mm","c.Density_per_100_shoots"))

## GALL DENSITY ----
sg.density_control <- gradient.calc(mod = gamm_red.control$gam, 
                                    phenotype = "c.Density_per_100_shoots", 
                                    covariates = c("c.gall_individuals","c.Gall_Height_mm"))
sg.density_treatment <- gradient.calc(mod = gamm_red.treatment$gam, 
                                      phenotype = "c.Density_per_100_shoots", 
                                      covariates = c("c.gall_individuals","c.Gall_Height_mm"))

## PRINT TABLE ----
rbind(
  mutate(sg.size_control$ests, Food_Web_Treatment = "Complex"),
  mutate(sg.size_treatment$ests, Food_Web_Treatment = "Simple"),
  mutate(sg.individuals_control$ests, Food_Web_Treatment = "Complex"),
  mutate(sg.individuals_treatment$ests, Food_Web_Treatment = "Simple"),
  mutate(sg.density_control$ests, Food_Web_Treatment = "Complex"),
  mutate(sg.density_treatment$ests, Food_Web_Treatment = "Simple")
)

round(rbind(
  sg.size_control$ests,
  sg.size_treatment$ests,
  sg.individuals_control$ests,
  sg.individuals_treatment$ests,
  sg.density_control$ests,
  sg.density_treatment$ests
),3)

## BOOTSTRAPPED INTERVALS ----
bootstrap_df <- bind_rows(
  data.frame(Bootstrap_Estimates = sg.size_control$boot[ ,1], Phenotype = "c.Gall_Height_mm", Selection_Type = "Beta", Food_Web_Treatment = "Complex"),
  data.frame(Bootstrap_Estimates = sg.size_control$boot[ ,2], Phenotype = "c.Gall_Height_mm", Selection_Type = "Gamma", Food_Web_Treatment = "Complex"),
  data.frame(Bootstrap_Estimates = sg.size_treatment$boot[ ,1], Phenotype = "c.Gall_Height_mm", Selection_Type = "Beta", Food_Web_Treatment = "Simple"),
  data.frame(Bootstrap_Estimates = sg.size_treatment$boot[ ,2], Phenotype = "c.Gall_Height_mm", Selection_Type = "Gamma", Food_Web_Treatment = "Simple"),
  data.frame(Bootstrap_Estimates = sg.individuals_control$boot[ ,1], Phenotype = "c.gall_individuals", Selection_Type = "Beta", Food_Web_Treatment = "Complex"),
  data.frame(Bootstrap_Estimates = sg.individuals_control$boot[ ,2], Phenotype = "c.gall_individuals", Selection_Type = "Gamma", Food_Web_Treatment = "Complex"),
  data.frame(Bootstrap_Estimates = sg.individuals_treatment$boot[ ,1], Phenotype = "c.gall_individuals", Selection_Type = "Beta", Food_Web_Treatment = "Simple"),
  data.frame(Bootstrap_Estimates = sg.individuals_treatment$boot[ ,2], Phenotype = "c.gall_individuals", Selection_Type = "Gamma", Food_Web_Treatment = "Simple"),
  data.frame(Bootstrap_Estimates = sg.density_control$boot[ ,1], Phenotype = "c.Density_per_100_shoots", Selection_Type = "Beta", Food_Web_Treatment = "Complex"),
  data.frame(Bootstrap_Estimates = sg.density_control$boot[ ,2], Phenotype = "c.Density_per_100_shoots", Selection_Type = "Gamma", Food_Web_Treatment = "Complex"),
  data.frame(Bootstrap_Estimates = sg.density_treatment$boot[ ,1], Phenotype = "c.Density_per_100_shoots", Selection_Type = "Beta", Food_Web_Treatment = "Simple"),
  data.frame(Bootstrap_Estimates = sg.density_treatment$boot[ ,2], Phenotype = "c.Density_per_100_shoots", Selection_Type = "Gamma", Food_Web_Treatment = "Simple")
)

bootstrap_df %>%
  ggplot(., aes(x=Phenotype, y=Bootstrap_Estimates, fill=Food_Web_Treatment)) +
  geom_boxplot() +
  geom_hline(yintercept=0, linetype="dotted") +
  facet_wrap(~Selection_Type) +
  coord_flip() 
```

```{r}
sg.size.x.individuals_control <- gradient.calc(mod = gamm_red.control$gam, 
                                               phenotype = c("c.Gall_Height_mm", "c.gall_individuals"),
                                               covariates = c("c.Density_per_100_shoots"))
sg.size.x.individuals_treatment <- gradient.calc(mod = gamm_red.treatment$gam, 
                                                 phenotype = c("c.Gall_Height_mm", "c.gall_individuals"),
                                                 covariates = c("c.Density_per_100_shoots"))
sg.size.x.density_control <- gradient.calc(mod = gamm_red.control$gam, 
                                               phenotype = c("c.Gall_Height_mm", "c.Density_per_100_shoots"),
                                               covariates = c("c.gall_individuals"))
sg.size.x.density_treatment <- gradient.calc(mod = gamm_red.treatment$gam, 
                                                 phenotype = c("c.Gall_Height_mm","c.Density_per_100_shoots"),
                                                 covariates = c("c.gall_individuals"))
sg.density.x.individuals_control <- gradient.calc(mod = gamm_red.control$gam, 
                                                  phenotype = c("c.Density_per_100_shoots", "c.gall_individuals"),
                                                  covariates = c("c.Gall_Height_mm"))
sg.density.x.individuals_treatment <- gradient.calc(mod = gamm_red.treatment$gam, 
                                                    phenotype = c("c.Density_per_100_shoots", "c.gall_individuals"),
                                                    covariates = c("c.Gall_Height_mm"))

# note that while the means are always the same for each gradient calculation, the SE and p-values can be slightly different. I always reported the highest SE and highest P-value to be conservative
bind_rows(data.frame(round(sg.size.x.individuals_control$ests,3), 
                     gradients = rownames(sg.size.x.individuals_control$ests),
                     treatment = "Complex"),
          data.frame(round(sg.size.x.individuals_treatment$ests,3), 
                     gradients = rownames(sg.size.x.individuals_treatment$ests),
                     treatment = "Simple"),
          data.frame(round(sg.size.x.density_control$ests,3), 
                     gradients = rownames(sg.size.x.density_control$ests),
                     treatment = "Complex"),
          data.frame(round(sg.size.x.density_treatment$ests,3), 
                     gradients = rownames(sg.size.x.density_treatment$ests),
                     treatment = "Simple"),
          data.frame(round(sg.density.x.individuals_control$ests,3), 
                     gradients = rownames(sg.density.x.individuals_control$ests),
                     treatment = "Complex"),
          data.frame(round(sg.density.x.individuals_treatment$ests,3), 
                     gradients = rownames(sg.density.x.individuals_treatment$ests),
                     treatment = "Simple")) %>%
  distinct %>%
  arrange(gradients)

```

Another decision we had to make was whether to calculate selection gradients with GAM or GAMMs. The problem with calculating selection gradients with GAMM is that the selection gradients can vary among environmental contexts that are being modelled by random intercepts. Since we did not alter random slopes, this would just cause variation in the selection gradients around the mean value, which is what our model tries to estimate. Therefore, we felt our GAMM model accurately reflects the selection that is happening at the population-level.


Now we plot the fitness landscapes associated with different combinations of gall phenotypes. We restrict these plots to 1 SD above and below the mean trait value, as this contains the majority of phenotypes under selection. Therefore, this fitness landscape integrates information from the fitness function with information about distributions of phenotype, and has been suggested to be a more informative way to visualize the magnitude of natural selection.
```{r Fitness Landscapes}

#### ESTIMATE FITNESS LANDSCAPES ----

## GALL SIZE
fl.size_control <- insect_FL(mod = gamm_red.control$gam, 
                                 phenotype = "c.Gall_Height_mm", 
                                 covariates = c("c.gall_individuals","c.Density_per_100_shoots"))
fl.size_treatment <- insect_FL(mod = gamm_red.treatment$gam, 
                                   phenotype = "c.Gall_Height_mm", 
                                   covariates = c("c.gall_individuals","c.Density_per_100_shoots"))

## GALL INDIVIDUALS
fl.individuals_control <- insect_FL(mod = gamm_red.control$gam, 
                                        phenotype = "c.gall_individuals", 
                                        covariates = c("c.Gall_Height_mm","c.Density_per_100_shoots"))
fl.individuals_treatment <- insect_FL(mod = gamm_red.treatment$gam, 
                                          phenotype = "c.gall_individuals", 
                                          covariates = c("c.Gall_Height_mm","c.Density_per_100_shoots"))

## GALL DENSITY 
fl.density_control <- insect_FL(mod = gamm_red.control$gam, 
                                    phenotype = "c.Density_per_100_shoots", 
                                    covariates = c("c.gall_individuals","c.Gall_Height_mm"))
fl.density_treatment <- insect_FL(mod = gamm_red.treatment$gam, 
                                      phenotype = "c.Density_per_100_shoots", 
                                      covariates = c("c.gall_individuals","c.Gall_Height_mm"))

## GALL INDIVIDUALS X DENSITY
fl.individuals.x.density_control <- insect_FL(mod = gamm_red.control$gam, 
                                              phenotype = c("c.Density_per_100_shoots","c.gall_individuals"), 
                                              covariates = c("c.Gall_Height_mm"))
fl.individuals.x.density_treatment <- insect_FL(mod = gamm_red.treatment$gam, 
                                                phenotype = c("c.Density_per_100_shoots","c.gall_individuals"), 
                                                covariates = c("c.Gall_Height_mm"))

## GALL INDIVIDUALS x SIZE
fl.individuals.x.size_control <- insect_FL(mod = gamm_red.control$gam, 
                                            phenotype = c("c.Gall_Height_mm","c.gall_individuals"), 
                                            covariates = c("c.Density_per_100_shoots"))
fl.individuals.x.size_treatment <- insect_FL(mod = gamm_red.treatment$gam, 
                                             phenotype = c("c.Gall_Height_mm","c.gall_individuals"), 
                                             covariates = c("c.Density_per_100_shoots"))

## GALL DENSITY X SIZE
fl.size.x.density_control <- insect_FL(mod = gamm_red.control$gam, 
                                       phenotype = c("c.Density_per_100_shoots","c.Gall_Height_mm"), 
                                       covariates = c("c.gall_individuals"))
fl.size.x.density_treatment <- insect_FL(mod = gamm_red.treatment$gam, 
                                         phenotype = c("c.Density_per_100_shoots","c.Gall_Height_mm"), 
                                         covariates = c("c.gall_individuals"))

#### PLOT FITNESS LANDSCAPES ----

# Order: orange, light blue, green, yellow, dark blue, red, pink
cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000", "#999999")
complex_color <- cbPalette[6]
simple_color <- cbPalette[5]
treatmeant_colors <- c(complex_color, simple_color)

## 1-DIMENSIONAL
uni_size <- bind_rows(mutate(get_insect_FL.df(fl.size_control), Treatment = "Complex"),
          mutate(get_insect_FL.df(fl.size_treatment), Treatment = "Simple")) %>%
  ggplot(.) +
  geom_line(aes(x = Var1, y = mean_fitness, color=Treatment)) + 
  geom_ribbon(aes(x = Var1, ymin = lower_2.5, ymax = upper_97.5, fill=Treatment), alpha = 0.25) +
  ylab("Mean fitness") +
  xlab("Mean gall size") +
  scale_color_manual(values = treatmeant_colors) +
  scale_fill_manual(values = treatmeant_colors) +
  scale_y_continuous(breaks=c(0,0.25,0.5,0.75,1), limits = c(0,1))

uni_clutch <- bind_rows(mutate(get_insect_FL.df(fl.individuals_control), Treatment = "Complex"),
          mutate(get_insect_FL.df(fl.individuals_treatment), Treatment = "Simple")) %>%
  ggplot(.) +
  geom_line(aes(x = Var1, y = mean_fitness, color=Treatment)) + 
  geom_ribbon(aes(x = Var1, ymin = lower_2.5, ymax = upper_97.5, fill=Treatment), alpha = 0.25) +
  ylab("Mean fitness") +
  xlab("Mean clutch size") +
  scale_color_manual(values = treatmeant_colors) +
  scale_fill_manual(values = treatmeant_colors) +
  scale_y_continuous(breaks=c(0,0.25,0.5,0.75,1), limits = c(0,1))

uni_pref <- bind_rows(mutate(get_insect_FL.df(fl.density_control), Treatment = "Complex"),
          mutate(get_insect_FL.df(fl.density_treatment), Treatment = "Simple")) %>%
  ggplot(.) +
  geom_line(aes(x = Var1, y = mean_fitness, color=Treatment)) + 
  geom_ribbon(aes(x = Var1, ymin = lower_2.5, ymax = upper_97.5, fill=Treatment), alpha = 0.25) +
  ylab("Mean fitness") +
  xlab("Mean female preference") +
  scale_color_manual(values = treatmeant_colors) +
  scale_fill_manual(values = treatmeant_colors) +
  scale_y_continuous(breaks=c(0,0.25,0.5,0.75,1), limits = c(0,1))
  
uni_legend <- get_legend(uni_size)

uni_plots <- plot_grid(uni_size + theme(legend.position = "none"), 
                       uni_clutch + theme(legend.position = "none", 
                                          axis.title.y = element_blank(), axis.text.y = element_blank()),
                       uni_pref + theme(legend.position = "none", 
                                        axis.title.y = element_blank(), axis.text.y = element_blank()),
                       labels = "AUTO", nrow = 1, align='hv')
plot_grid(uni_plots, uni_legend, ncol=2, rel_widths = c(3,0.3))

## 2-DIMENSIONAL

bind_rows(mutate(get_insect_FL.df(fl.individuals.x.density_treatment), Treatment="Simple"),
          mutate(get_insect_FL.df(fl.individuals.x.density_control), Treatment="Complex")) %>%
  ggplot(., aes(x=Var1, y=Var2, fill=mean_fitness)) +
  geom_raster() + 
  facet_wrap(~Treatment) +
  scale_fill_viridis() +
  xlab("Female preference") +
  ylab("Clutch size")

bind_rows(mutate(get_insect_FL.df(fl.individuals.x.size_treatment), Treatment="Simple"),
          mutate(get_insect_FL.df(fl.individuals.x.size_control), Treatment="Complex")) %>%
  ggplot(., aes(x=Var1, y=Var2, fill=mean_fitness)) +
  geom_raster() + 
  facet_wrap(~Treatment) +
  scale_fill_viridis() +
  xlab("Clutch size") +
  ylab("Gall size")

bind_rows(mutate(get_insect_FL.df(fl.size.x.density_treatment), Treatment="Simple"),
          mutate(get_insect_FL.df(fl.size.x.density_control), Treatment="Complex")) %>%
  ggplot(., aes(x=Var1, y=Var2, fill=mean_fitness)) +
  geom_raster() + 
  facet_wrap(~Treatment) +
  scale_fill_viridis() +
  xlab("Gall size") +
  ylab("Female preference")
```

