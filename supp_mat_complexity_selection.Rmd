---
title: "Supplementary Material for Food-web complexity alters the fitness landscape of an insect herbivore"
author: Matt Barbour
output: html_notebook
---

Load dataset. This dataset is a subset that only includes larva that survive to pupation or turned into parasitoids. We omitted any data where larva mortality was unclear. This enabled us to focus on the selection pressures imposed by insect parasitoids rather than other sources.
```{r Preliminaries, message=FALSE, warning=FALSE, include=FALSE}

## LOAD REQUIRED LIBRARIES & SET OPTIONS ----
library(tidyverse)
library(cowplot) # pretty default ggplots
library(broom) # for tidying multiple linear models
library(mgcv) # generalized additive models
library(gamm4) # generalized additive mixed-models
library(gsg) # calculating selection gradients
library(visreg)
library(viridis) # for color palette

## LOAD & MANAGE DATASET ----

gall_selection.df <- read_csv("gall_selection_data.csv") %>%
  # convert appropriate variables to characters instead of integers
  mutate(Plant_Position = as.character(Plant_Position),
         Gall_Number = as.character(Gall_Number)) %>%
  unite(Gall_ID, Gall_Number, Gall_Letter, remove = FALSE) %>%
  
  # subset data for analysis
  filter(phenology == "early", Location == "tree",
         platy > 0 | ectos > 0 | pupa > 0) %>%                  # eliminate unknown sources of mortality
  mutate(gall_survival = as.numeric(ifelse(pupa > 0, 1, 0)),
         egg_parasitoid = as.numeric(ifelse(platy > 0, 1, 0))) 

## CREATE SEPARATE DATASETS FOR SELECTION ANALYSES ----
control_df <- gall_selection.df %>%
  filter(Treatment.focus == "Control") #%>%
  #mutate(Gall_Height_mm = Gall_Height_mm - mean(Gall_Height_mm),
  #       gall_individuals = gall_individuals - mean(gall_individuals),
  #       Density_per_100_shoots = Density_per_100_shoots - mean(Density_per_100_shoots))

treatment_df <- gall_selection.df %>%
  filter(Treatment.focus == "Ectoparasitoid exclusion") #%>%
  #mutate(Gall_Height_mm = Gall_Height_mm - mean(Gall_Height_mm),
  #       gall_individuals = gall_individuals - mean(gall_individuals),
  #       Density_per_100_shoots = Density_per_100_shoots - mean(Density_per_100_shoots))
```

Custom functions to avoid repetitive code
```{r FUNCTIONS}
gamm.model <- function(formula, data) {
  gamm4(formula, data, 
        random = ~(1|Genotype/Plant_Position/Gall_Number), 
        family = binomial(link = logit))
}

gam.plot <- function(gam.model, ...) {
  plot(gam.model, se = TRUE, seWithMean = T, shift = mean(predict(gam.model)), trans = function(x) {exp(x)/(1+exp(x))}, ...)
}

# experimenting with boot.case gave bootstrapped distributions that weren't centered near the model mean estimate.
# also, using 'refit.smooth = T' also generated some very skewed distributions
# the recipe below provided the most sensible estimates for my data
gradient.calc <- function(mod, phenotype, covariates = NULL) {
  gam.gradients(mod, phenotype, covariates, parallel = 'multicore', ncpus = 32, 
                refit.smooth = F,
                n.boot = 1000,
                se.method = 'boot.para', #'posterior', #'boot.para', #'permute', 'boot.case'#  
                standardized = T)
} 

insect_FL <- function(mod, phenotype, covariates = NULL) {
  fitness.landscape(mod, phenotype, covariates, parallel = 'multicore', ncpus = 32,
                    PI.method = 'boot.para',
                    refit.smooth = F,
                    PI.interval = c(0.025,0.975),
                    plt.density = 100)
}

get_insect_FL.df <- function(FL){
  data.frame(mean_fitness = FL$Wbar, FL$points, t(FL$WbarPI)) %>%
    mutate(lower_2.5 = X2.5., upper_97.5 = X97.5.)
}
```

Choosing the level of model complexity. We used AIC to pair down the complexity of the model. For both the control and treatment plants, there is support for maintaing the linear interaction between gall size and the number of individuals per gall. In both cases, AIC suggest that the models lacking linear interaction terms were more parsimonious, so we subsequently analyzed selection gradients with these models.

```{r AIC MODEL COMPLEXITY}

## CONTROL PLANTS ----
gamm_full.control <- gamm.model(gall_survival ~ s(Gall_Height_mm) + s(gall_individuals, k=9) + s(Density_per_100_shoots) +
                                  Gall_Height_mm:gall_individuals + Gall_Height_mm:Density_per_100_shoots + gall_individuals:Density_per_100_shoots,
                                data = control_df)
summary(gamm_full.control$gam); summary(gamm_full.control$mer)

glmm_full.control <- gamm.model(gall_survival ~ Gall_Height_mm + gall_individuals + Density_per_100_shoots +
                                  I(Gall_Height_mm^2) + I(gall_individuals^2) + I(Density_per_100_shoots^2) +
                                  Gall_Height_mm:gall_individuals + Gall_Height_mm:Density_per_100_shoots + gall_individuals:Density_per_100_shoots,
                                data = control_df)
summary(glmm_full.control$gam); summary(glmm_full.control$mer)

gamm_red.control <- gamm.model(gall_survival ~ s(Gall_Height_mm) + s(gall_individuals, k=9) + s(Density_per_100_shoots),
                                data = control_df)
summary(gamm_red.control$gam); summary(gamm_red.control$mer)

glmm_quad.control <- gamm.model(gall_survival ~ Gall_Height_mm + gall_individuals + Density_per_100_shoots +
                                  I(Gall_Height_mm^2) + I(gall_individuals^2) + I(Density_per_100_shoots^2),
                                data = control_df)
summary(glmm_quad.control$gam); summary(glmm_quad.control$mer)

glmm_lin.control <- gamm.model(gall_survival ~ Gall_Height_mm + gall_individuals + Density_per_100_shoots,
                                data = control_df)
summary(glmm_lin.control$gam); summary(glmm_lin.control$mer)

lmm_lin.control <- gamm4(gall_survival ~ Gall_Height_mm + gall_individuals + Density_per_100_shoots,
                          data = control_df,
                          random = ~(1|Genotype/Plant_Position/Gall_Number), 
                          family = gaussian(link = identity))
summary(lmm_lin.control$gam); summary(lmm_lin.control$mer)

glmm_lin.red.control <- gamm.model(gall_survival ~ Gall_Height_mm,
                                data = control_df)
summary(glmm_lin.red.control$gam); summary(glmm_lin.red.control$mer)

glmm_null.control <- gamm.model(gall_survival ~ 1,
                                data = control_df)
summary(glmm_null.control$gam); summary(glmm_null.control$mer)

glmm_lin.red.noRE.control <- gamm4(gall_survival ~ Gall_Height_mm,
                          data = control_df,
                          random = ~(1|Gall_Number), 
                          family = binomial(link = logit))
summary(glmm_lin.red.noRE.control$gam); summary(glmm_lin.red.noRE.control$mer)

AIC(gamm_full.control$mer, glmm_full.control$mer, gamm_red.control$mer, glmm_quad.control$mer, glmm_lin.control$mer, lmm_lin.control$mer, glmm_lin.red.control$mer, glmm_null.control$mer, glmm_lin.red.noRE.control$mer)

## TREATMENT PLANTS ----
gamm_full.treatment <- gamm.model(gall_survival ~ s(Gall_Height_mm) + s(gall_individuals, k=9) + s(Density_per_100_shoots) +
                                  Gall_Height_mm:gall_individuals + Gall_Height_mm:Density_per_100_shoots + gall_individuals:Density_per_100_shoots,
                                data = treatment_df)
summary(gamm_full.treatment$gam); summary(gamm_full.treatment$mer)

glmm_full.treatment <- gamm.model(gall_survival ~ Gall_Height_mm + gall_individuals + Density_per_100_shoots +
                                  I(Gall_Height_mm^2) + I(gall_individuals^2) + I(Density_per_100_shoots^2) +
                                  Gall_Height_mm:gall_individuals + Gall_Height_mm:Density_per_100_shoots + gall_individuals:Density_per_100_shoots,
                                data = treatment_df)
summary(glmm_full.treatment$gam); summary(glmm_full.treatment$mer)

gamm_red.treatment <- gamm.model(gall_survival ~ s(Gall_Height_mm) + s(gall_individuals, k=9) + s(Density_per_100_shoots),
                                data = treatment_df)
summary(gamm_red.treatment$gam); summary(gamm_red.treatment$mer)

glmm_quad.treatment <- gamm.model(gall_survival ~ Gall_Height_mm + gall_individuals + Density_per_100_shoots +
                                  I(Gall_Height_mm^2) + I(gall_individuals^2) + I(Density_per_100_shoots^2),
                                data = treatment_df)
summary(glmm_quad.treatment$gam); summary(glmm_quad.treatment$mer)

glmm_lin.treatment <- gamm.model(gall_survival ~ Gall_Height_mm + gall_individuals + Density_per_100_shoots,
                                data = treatment_df)
summary(glmm_lin.treatment$gam); summary(glmm_lin.treatment$mer)

lmm_lin.treatment <- gamm4(gall_survival ~ Gall_Height_mm + gall_individuals + Density_per_100_shoots,
                          data = treatment_df,
                          random = ~(1|Genotype/Plant_Position/Gall_Number), 
                          family = gaussian(link = identity))
summary(lmm_lin.treatment$gam); summary(lmm_lin.treatment$mer)

glmm_quad.red.treatment <- gamm.model(gall_survival ~ Gall_Height_mm + gall_individuals + Density_per_100_shoots + I(Density_per_100_shoots^2),
                                data = treatment_df)
summary(glmm_quad.red.treatment$gam); summary(glmm_quad.red.treatment$mer)

glmm_null.treatment <- gamm.model(gall_survival ~ 1,
                                data = treatment_df)
summary(glmm_null.treatment$gam); summary(glmm_null.treatment$mer)

glmm_lin.red.noRE.treatment <- gamm4(gall_survival ~ Gall_Height_mm,
                          data = treatment_df,
                          random = ~(1|Gall_Number), 
                          family = binomial(link = logit))
summary(glmm_lin.red.noRE.treatment$gam); summary(glmm_lin.red.noRE.treatment$mer)

AIC(gamm_full.treatment$mer, glmm_full.treatment$mer, gamm_red.treatment$mer, glmm_quad.treatment$mer, glmm_lin.treatment$mer, lmm_lin.treatment$mer, glmm_lin.red.treatment$mer, glmm_null.treatment$mer, glmm_lin.red.noRE.treatment$mer, glmm_quad.red.treatment$mer)
```

```{r}
library(schoenberg)
pointwise <- confint(gamm_red.control$gam, parm = "Gall_Height_mm", trans = function(x) {exp(x)/(1+exp(x))})
simultaneous <- confint(gamm_red.control$gam, parm = "Gall_Height_mm", trans = function(x) {exp(x)/(1+exp(x))}, type = "simultaneous", seWithMean=TRUE)

compare.confint <- bind_rows(mutate(pointwise, confint = "pointwise"), mutate(simultaneous, confint = "simultaneous")) 
compare.confint$confint <- relevel(factor(compare.confint$confint), ref = "simultaneous")

ggplot(compare.confint, aes(x=Gall_Height_mm)) +
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.25) +
  geom_line(aes(y=est), color="black") +
  facet_wrap(~confint)

schluter <- gam.plot(gamm_red.control$gam)
schluter

gam.plot(glmm_lin.red.control$gam, all.terms=TRUE)
test <- plot(glmm_lin.red.control$gam, all.terms=TRUE)
gam.gradients(mod = glmm_lin.red.control$gam, phenotype = "Gall_Height_mm", se.method = "n")
coef(glmm_lin.red.control$gam)

# test derivative calculations
control_df$Genotype <- factor(control_df$Genotype)
control_df$Plant_Position <- factor(control_df$Plant_Position)
control_df$Gall_Number <- factor(control_df$Gall_Number)
A <- gam(gall_survival ~ s(Gall_Height_mm) + s(Plant_Position, bs="re") + s(Gall_Number, bs="re"), data = control_df, family=binomial(link=logit)) # random=~(1|Genotype/Plant_Position/Gall_Number),
summary(A)

head(control_df)
A_withMean <- plot(A, se = TRUE, seWithMean = T, shift = mean(predict(A)), trans = function(x) {exp(x)/(1+exp(x))}); A_withMean
A_only <- plot(A, se = TRUE, shift = mean(predict(A)), trans = function(x) {exp(x)/(1+exp(x))}); A_only
draw(A)


# new data for prediction
newDF <- with(control_df, data.frame(Gall_Height_mm = seq(min(Gall_Height_mm),max(Gall_Height_mm),length.out = 100)))
# prediction of smoothed estimates at each unique year value
# with standard error    
B <- predict(A$gam,  newDF, type="response", se.fit=TRUE)
B

# finite difference approach to derivatives following
# example from ?predict.gam

eps <- 1e-7
X0 <- predict(A, newDF, type = 'lpmatrix')
X0 <- exp(X0)/(1+exp(X0))

newDFeps_p <- newDF + eps

X1 <- predict(A, newDFeps_p, type = 'lpmatrix')
X1 <- exp(X1)/(1+exp(X1))
# finite difference approximation of first derivative
# the design matrix
Xp <- (X0 - X1) / eps
Xp
# first derivative
fd_d1 <- Xp %*% coef(A)
fd_d1/mean_fit
# second derivative
newDFeps_m <- newDF - eps

X_1 <- predict(A$gam, newDFeps_m, type = 'lpmatrix')
# design matrix for second derivative
Xpp <- (X1 + X_1 - 2*X0)  / eps^2
# second derivative
fd_d2 <- Xpp %*% coef(A$gam)

exp(fd_d1) / ( 1+exp(fd_d1))  # type = "response"
exp(fd_d2) / ( 1+exp(fd_d2))  # type = "response"

mean(fd_d1)/mean_fit
mean(fd_d2)/mean_fit

gam.gradients(A, phenotype = "Gall_Height_mm", se.method="n", standardized = FALSE)

coef(A)
mean_fit <- mean(control_df$gall_survival)
fderiv_size <- fderiv(A, newdata = data.frame(Gall_Height_mm = mean(control_df$Gall_Height_mm)), offset = mean_fit)
test <- fderiv_size$derivatives$`s(Gall_Height_mm)`$deriv
exp(test)/(1+exp(test))

plot(A, se = TRUE, seWithMean = T, shift = mean(predict(A)), trans = function(x) {exp(x)/(1+exp(x))})
diff <- .Machine$double.eps^(1/3)
predicts <- predict(A, newdata = data.frame(Gall_Height_mm = c(mean(control_df$Gall_Height_mm)-diff,mean(control_df$Gall_Height_mm)+diff)), type="lpmatrix")
tests <- predicts %*% coef(A)
exp(tests)/(1+exp(tests))
t1 <- exp(predicts[2])/(1+exp(predicts[2]));t1
t2 <- exp(predicts[1])/(1+exp(predicts[1]));t2
((t1-t2)/(diff*2))/mean(control_df$gall_survival)
gam.gradients(A, phenotype = "Gall_Height_mm", se.method="n", standardized = FALSE)

	Wbar <- function(x, mod, phenotype,covariates) {
    		new.d <- as.data.frame(mod$model[,c(phenotype,covariates)])
    		names(new.d)<-c(phenotype,covariates)
    		new.d2<-new.d
    		for (i in 1:length(x)) {
    		    new.d[,as.character(phenotype[i])] <-
    		    new.d[,as.character(phenotype[i])]+x[i]
    		}
    
    		p <- predict.gam(
			   object=mod,
    	 	   newdata=new.d,
    	 	   newdata.guaranteed=TRUE,
    	 	   type="response"
    		)
    	return(mean(p))
	}
	as.data.frame(A$model[ ,"Gall_Height_mm"])
	#mean(control_df$gall_survival)
	Wbar(x=0, mod=A, phenotype="Gall_Height_mm", covariates=NULL)
first.derivatives <- grad(f=Wbar, x=rep(0, 1), mod=A, phenotype="Gall_Height_mm", covariates=NULL); first.derivatives
denom <- Wbar(x=rep(0,1), mod=A, phenotype="Gall_Height_mm", covariates=NULL); denom
first.derivatives/denom
pracma:::grad
A$Vp
A$coefficients
A_withMean
```

Parametric bootstrapping: Currently reported results

Case-wise bootstrapping: qualitative results match parametric bootstrapping.

Posterior: qualitative results match parametric bootstrapping, except that non-linear selection on gall size in the complex food-web is no longer significant.

Permutation: qualtiative results are consistent with parametric bootstrapping. Exceptions include: in the simple food-web, there is no evidence of non-linear selection for gall density or gall individuals. In the complex food-web, there is only marginal evidence for non-linear selection acting on gall size, but there is evidence for correlational selection between gall size and the number of individuals per gall.
```{r SELECTION GRADIENTS, echo=TRUE, warning=FALSE}

## Estimate directional, nonlinear, and correlational selection gradients
sg.size_control <- gradient.calc(mod = gamm_red.control$gam, 
                                 phenotype = "Gall_Height_mm", 
                                 covariates = c("gall_individuals","Density_per_100_shoots"))
sg.size_treatment <- gradient.calc(mod = gamm_red.treatment$gam, 
                                   phenotype = "Gall_Height_mm", 
                                   covariates = c("gall_individuals","Density_per_100_shoots"))
sg.individuals_control <- gradient.calc(mod = gamm_red.control$gam, 
                                        phenotype = "gall_individuals", 
                                        covariates = c("Gall_Height_mm","Density_per_100_shoots"))
sg.individuals_treatment <- gradient.calc(mod = gamm_red.treatment$gam, 
                                          phenotype = "gall_individuals", 
                                          covariates = c("Gall_Height_mm","Density_per_100_shoots"))
sg.density_control <- gradient.calc(mod = gamm_red.control$gam, 
                                    phenotype = "Density_per_100_shoots", 
                                    covariates = c("gall_individuals","Gall_Height_mm"))
sg.density_treatment <- gradient.calc(mod = gamm_red.treatment$gam, 
                                      phenotype = "Density_per_100_shoots", 
                                      covariates = c("gall_individuals","Gall_Height_mm"))
sg.size.x.individuals_control <- gradient.calc(mod = gamm_red.control$gam, 
                                               phenotype = c("Gall_Height_mm", "gall_individuals"),
                                               covariates = c("Density_per_100_shoots"))
sg.size.x.individuals_treatment <- gradient.calc(mod = gamm_red.treatment$gam, 
                                                 phenotype = c("Gall_Height_mm", "gall_individuals"),
                                                 covariates = c("Density_per_100_shoots"))
sg.size.x.density_control <- gradient.calc(mod = gamm_red.control$gam, 
                                               phenotype = c("Gall_Height_mm", "Density_per_100_shoots"),
                                               covariates = c("gall_individuals"))
sg.size.x.density_treatment <- gradient.calc(mod = gamm_red.treatment$gam, 
                                                 phenotype = c("Gall_Height_mm","Density_per_100_shoots"),
                                                 covariates = c("gall_individuals"))
sg.density.x.individuals_control <- gradient.calc(mod = gamm_red.control$gam, 
                                                  phenotype = c("Density_per_100_shoots", "gall_individuals"),
                                                  covariates = c("Gall_Height_mm"))
sg.density.x.individuals_treatment <- gradient.calc(mod = gamm_red.treatment$gam, 
                                                    phenotype = c("Density_per_100_shoots", "gall_individuals"),
                                                    covariates = c("Gall_Height_mm"))

## Summarise the results
sg.summary <- bind_rows(
          data.frame(sg.size_control$ests,  
                     gradients = rownames(sg.size_control$ests),
                     treatment = "Complex"),
          data.frame(sg.size_treatment$ests, 
                     gradients = rownames(sg.size_treatment$ests),
                     treatment = "Simple"),
          data.frame(sg.individuals_control$ests,  
                     gradients = rownames(sg.individuals_control$ests),
                     treatment = "Complex"),
          data.frame(sg.individuals_treatment$ests,  
                     gradients = rownames(sg.individuals_treatment$ests),
                     treatment = "Simple"),
          data.frame(sg.density_control$ests, 
                     gradients = rownames(sg.density_control$ests),
                     treatment = "Complex"),
          data.frame(sg.density_treatment$ests, 
                     gradients = rownames(sg.density_treatment$ests),
                     treatment = "Simple"),
          data.frame(sg.size.x.individuals_control$ests,  
                     gradients = rownames(sg.size.x.individuals_control$ests),
                     treatment = "Complex")[5,],
          data.frame(sg.size.x.individuals_treatment$ests,  
                     gradients = rownames(sg.size.x.individuals_treatment$ests),
                     treatment = "Simple")[5,],
          data.frame(sg.size.x.density_control$ests,  
                     gradients = rownames(sg.size.x.density_control$ests),
                     treatment = "Complex")[5,],
          data.frame(sg.size.x.density_treatment$ests,  
                     gradients = rownames(sg.size.x.density_treatment$ests),
                     treatment = "Simple")[5,],
          data.frame(sg.density.x.individuals_control$ests, 
                     gradients = rownames(sg.density.x.individuals_control$ests),
                     treatment = "Complex")[5,],
          data.frame(sg.density.x.individuals_treatment$ests, 
                     gradients = rownames(sg.density.x.individuals_treatment$ests),
                     treatment = "Simple")[5,]) 

## Table of Estimates
sg.table <- sg.summary %>%
  mutate(plus_minus = "\u00B1", estimates = round(estimates, 4), SE = round(SE, 4)) %>%
  unite(col = estimate_SE, from = c("estimates", "plus_minus", "SE"), sep="") %>%
  select(-P.value) %>%
  spread(treatment, estimate_SE)
sg.table
write_csv(sg.table, "sg.table.csv")

## Table of P-values
sg.summary %>%
  select(-estimates, -SE) %>%
  spread(treatment, P.value)
```

```{r}

## BOOTSTRAPPED INTERVALS ----
bootstrap_df <- bind_rows(
  data.frame(Bootstrap_Estimates = sg.size_control$boot[ ,1], Phenotype = "Gall size", Selection_Type = "Beta", Food_Web_Treatment = "Complex"),
  data.frame(Bootstrap_Estimates = sg.size_control$boot[ ,2], Phenotype = "Gall size", Selection_Type = "Gamma", Food_Web_Treatment = "Complex"),
  data.frame(Bootstrap_Estimates = sg.size_treatment$boot[ ,1], Phenotype = "Gall size", Selection_Type = "Beta", Food_Web_Treatment = "Simple"),
  data.frame(Bootstrap_Estimates = sg.size_treatment$boot[ ,2], Phenotype = "Gall size", Selection_Type = "Gamma", Food_Web_Treatment = "Simple"),
  data.frame(Bootstrap_Estimates = sg.individuals_control$boot[ ,1], Phenotype = "Clutch size", Selection_Type = "Beta", Food_Web_Treatment = "Complex"),
  data.frame(Bootstrap_Estimates = sg.individuals_control$boot[ ,2], Phenotype = "Clutch size", Selection_Type = "Gamma", Food_Web_Treatment = "Complex"),
  data.frame(Bootstrap_Estimates = sg.individuals_treatment$boot[ ,1], Phenotype = "Clutch size", Selection_Type = "Beta", Food_Web_Treatment = "Simple"),
  data.frame(Bootstrap_Estimates = sg.individuals_treatment$boot[ ,2], Phenotype = "Clutch size", Selection_Type = "Gamma", Food_Web_Treatment = "Simple"),
  data.frame(Bootstrap_Estimates = sg.density_control$boot[ ,1], Phenotype = "Oviposition preference", Selection_Type = "Beta", Food_Web_Treatment = "Complex"),
  data.frame(Bootstrap_Estimates = sg.density_control$boot[ ,2], Phenotype = "Oviposition preference", Selection_Type = "Gamma", Food_Web_Treatment = "Complex"),
  data.frame(Bootstrap_Estimates = sg.density_treatment$boot[ ,1], Phenotype = "Oviposition preference", Selection_Type = "Beta", Food_Web_Treatment = "Simple"),
  data.frame(Bootstrap_Estimates = sg.density_treatment$boot[ ,2], Phenotype = "Oviposition preference", Selection_Type = "Gamma", Food_Web_Treatment = "Simple"),
  # correlational
  data.frame(Bootstrap_Estimates = sg.size.x.individuals_control$boot[ ,5], Phenotype = "Size,Clutch", Selection_Type = "Correlational", Food_Web_Treatment = "Complex"),
  data.frame(Bootstrap_Estimates = sg.size.x.individuals_treatment$boot[ ,5], Phenotype = "Size,Clutch", Selection_Type = "Correlational", Food_Web_Treatment = "Simple"),
    data.frame(Bootstrap_Estimates = sg.size.x.density_control$boot[ ,5], Phenotype = "Size,Pref.", Selection_Type = "Correlational", Food_Web_Treatment = "Complex"),
  data.frame(Bootstrap_Estimates = sg.size.x.density_treatment$boot[ ,5], Phenotype = "Size,Pref.", Selection_Type = "Correlational", Food_Web_Treatment = "Simple"),
  data.frame(Bootstrap_Estimates = sg.density.x.individuals_control$boot[ ,5], Phenotype = "Pref.,Clutch", Selection_Type = "Correlational", Food_Web_Treatment = "Complex"),
  data.frame(Bootstrap_Estimates = sg.density.x.individuals_treatment$boot[ ,5], Phenotype = "Pref.,Clutch", Selection_Type = "Correlational", Food_Web_Treatment = "Simple")
)

bootstrap_df %>%
  #filter(Selection_Type == "Gamma") %>%
  ggplot(., aes(x=Phenotype, y=Bootstrap_Estimates, fill=Food_Web_Treatment)) +
  geom_boxplot() +
  geom_hline(yintercept=0, linetype="dotted") +
  facet_wrap(~Selection_Type, scales = "free_x") +
  coord_flip() 
```

Compare bootstrapped replicates across treatments, rather than comparing to zero.
```{r}
bootstrap_df %>%
  filter(Phenotype == "Gall size", Selection_Type == "Beta") %>%
  mutate(ID = rep(1:1000,2)) %>%
  spread(Food_Web_Treatment, Bootstrap_Estimates) %>%
  mutate(diff_gradient = Complex - Simple) %>%
  summarise(p_value = sum(diff_gradient < 0)/1000)

bootstrap_df %>%
  filter(Phenotype == "Gall size", Selection_Type == "Gamma") %>%
  mutate(ID = rep(1:1000,2)) %>%
  spread(Food_Web_Treatment, Bootstrap_Estimates) %>%
  mutate(diff_gradient = Complex - Simple) %>%
  summarise(p_value = sum(diff_gradient < 0)/1000)

bootstrap_df %>%
  filter(Phenotype == "Clutch size", Selection_Type == "Beta") %>%
  mutate(ID = rep(1:1000,2)) %>%
  spread(Food_Web_Treatment, Bootstrap_Estimates) %>%
  mutate(diff_gradient = Complex - Simple) %>%
  summarise(p_value = sum(diff_gradient < 0)/1000)

bootstrap_df %>%
  filter(Phenotype == "Clutch size", Selection_Type == "Gamma") %>%
  mutate(ID = rep(1:1000,2)) %>%
  spread(Food_Web_Treatment, Bootstrap_Estimates) %>%
  mutate(diff_gradient = Complex - Simple) %>%
  summarise(p_value = sum(diff_gradient < 0)/1000)

bootstrap_df %>%
  filter(Phenotype == "Oviposition preference", Selection_Type == "Beta") %>%
  mutate(ID = rep(1:1000,2)) %>%
  spread(Food_Web_Treatment, Bootstrap_Estimates) %>%
  mutate(diff_gradient = Complex - Simple) %>%
  summarise(p_value = sum(diff_gradient < 0)/1000)

bootstrap_df %>%
  filter(Phenotype == "Oviposition preference", Selection_Type == "Gamma") %>%
  mutate(ID = rep(1:1000,2)) %>%
  spread(Food_Web_Treatment, Bootstrap_Estimates) %>%
  mutate(diff_gradient = Complex - Simple) %>%
  summarise(p_value = sum(diff_gradient < 0)/1000)

bootstrap_df %>%
  filter(Phenotype == "Size,Clutch", Selection_Type == "Correlational") %>%
  mutate(ID = rep(1:1000,2)) %>%
  spread(Food_Web_Treatment, Bootstrap_Estimates) %>%
  mutate(diff_gradient = Complex - Simple) %>%
  summarise(p_value = sum(diff_gradient > 0)/1000) # flipped sign

bootstrap_df %>%
  filter(Phenotype == "Size,Pref.", Selection_Type == "Correlational") %>%
  mutate(ID = rep(1:1000,2)) %>%
  spread(Food_Web_Treatment, Bootstrap_Estimates) %>%
  mutate(diff_gradient = Complex - Simple) %>%
  summarise(p_value = sum(diff_gradient > 0)/1000) # flipped sign

bootstrap_df %>%
  filter(Phenotype == "Pref.,Clutch", Selection_Type == "Correlational") %>%
  mutate(ID = rep(1:1000,2)) %>%
  spread(Food_Web_Treatment, Bootstrap_Estimates) %>%
  mutate(diff_gradient = Complex - Simple) %>%
  summarise(p_value = sum(diff_gradient < 0)/1000)
```


Another decision we had to make was whether to calculate selection gradients with GAM or GAMMs. The problem with calculating selection gradients with GAMM is that the selection gradients can vary among environmental contexts that are being modelled by random intercepts. Since we did not alter random slopes, this would just cause variation in the selection gradients around the mean value, which is what our model tries to estimate. Therefore, we felt our GAMM model accurately reflects the selection that is happening at the population-level.


Now we plot the fitness landscapes associated with different combinations of gall phenotypes. We restrict these plots to 1 SD above and below the mean trait value, as this contains the majority of phenotypes under selection. Therefore, this fitness landscape integrates information from the fitness function with information about distributions of phenotype, and has been suggested to be a more informative way to visualize the magnitude of natural selection.
```{r Fitness Landscapes}

#### ESTIMATE FITNESS LANDSCAPES ----

## GALL SIZE
fl.size_control <- insect_FL(mod = gamm_red.control$gam, 
                                 phenotype = "Gall_Height_mm", 
                                 covariates = c("gall_individuals","Density_per_100_shoots"))
fl.size_treatment <- insect_FL(mod = gamm_red.treatment$gam, 
                                   phenotype = "Gall_Height_mm", 
                                   covariates = c("gall_individuals","Density_per_100_shoots"))

## GALL INDIVIDUALS
fl.individuals_control <- insect_FL(mod = gamm_red.control$gam, 
                                        phenotype = "gall_individuals", 
                                        covariates = c("Gall_Height_mm","Density_per_100_shoots"))
fl.individuals_treatment <- insect_FL(mod = gamm_red.treatment$gam, 
                                          phenotype = "gall_individuals", 
                                          covariates = c("Gall_Height_mm","Density_per_100_shoots"))

## GALL DENSITY 
fl.density_control <- insect_FL(mod = gamm_red.control$gam, 
                                    phenotype = "Density_per_100_shoots", 
                                    covariates = c("gall_individuals","Gall_Height_mm"))
fl.density_treatment <- insect_FL(mod = gamm_red.treatment$gam, 
                                      phenotype = "Density_per_100_shoots", 
                                      covariates = c("gall_individuals","Gall_Height_mm"))

## GALL INDIVIDUALS X DENSITY
fl.individuals.x.density_control <- insect_FL(mod = gamm_red.control$gam, 
                                              phenotype = c("Density_per_100_shoots","gall_individuals"), 
                                              covariates = c("Gall_Height_mm"))
fl.individuals.x.density_treatment <- insect_FL(mod = gamm_red.treatment$gam, 
                                                phenotype = c("Density_per_100_shoots","gall_individuals"), 
                                                covariates = c("Gall_Height_mm"))

## GALL INDIVIDUALS x SIZE
fl.individuals.x.size_control <- insect_FL(mod = gamm_red.control$gam, 
                                            phenotype = c("Gall_Height_mm","gall_individuals"), 
                                            covariates = c("Density_per_100_shoots"))
fl.individuals.x.size_treatment <- insect_FL(mod = gamm_red.treatment$gam, 
                                             phenotype = c("Gall_Height_mm","gall_individuals"), 
                                             covariates = c("Density_per_100_shoots"))

## GALL DENSITY X SIZE
fl.size.x.density_control <- insect_FL(mod = gamm_red.control$gam, 
                                       phenotype = c("Density_per_100_shoots","Gall_Height_mm"), 
                                       covariates = c("gall_individuals"))
fl.size.x.density_treatment <- insect_FL(mod = gamm_red.treatment$gam, 
                                         phenotype = c("Density_per_100_shoots","Gall_Height_mm"), 
                                         covariates = c("gall_individuals"))

#### PLOT FITNESS LANDSCAPES ----

# Order: orange, light blue, green, yellow, dark blue, red, pink
cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000", "#999999")
complex_color <- cbPalette[6]
simple_color <- cbPalette[5]
treatmeant_colors <- c(complex_color, simple_color)

## 1-DIMENSIONAL
uni_size <- bind_rows(mutate(get_insect_FL.df(fl.size_control), Treatment = "Complex"),
          mutate(get_insect_FL.df(fl.size_treatment), Treatment = "Simple")) %>%
  ggplot(.) +
  geom_line(aes(x = Var1, y = mean_fitness, color=Treatment)) + 
  geom_ribbon(aes(x = Var1, ymin = lower_2.5, ymax = upper_97.5, fill=Treatment), alpha = 0.25) +
  ylab("Population mean fitness") +
  xlab("Mean gall size\n(mm)") +
  scale_color_manual(values = treatmeant_colors) +
  scale_fill_manual(values = treatmeant_colors) +
  scale_y_continuous(breaks=c(0,0.25,0.5,0.75,1), limits = c(0,1))

uni_clutch <- bind_rows(mutate(get_insect_FL.df(fl.individuals_control), Treatment = "Complex"),
          mutate(get_insect_FL.df(fl.individuals_treatment), Treatment = "Simple")) %>%
  ggplot(.) +
  geom_line(aes(x = Var1, y = mean_fitness, color=Treatment)) + 
  geom_ribbon(aes(x = Var1, ymin = lower_2.5, ymax = upper_97.5, fill=Treatment), alpha = 0.25) +
  ylab("Population mean fitness") +
  xlab("Mean clutch size\n(no. of larva)") +
  scale_color_manual(values = treatmeant_colors) +
  scale_fill_manual(values = treatmeant_colors) +
  scale_y_continuous(breaks=c(0,0.25,0.5,0.75,1), limits = c(0,1))

uni_pref <- bind_rows(mutate(get_insect_FL.df(fl.density_control), Treatment = "Complex"),
          mutate(get_insect_FL.df(fl.density_treatment), Treatment = "Simple")) %>%
  ggplot(.) +
  geom_line(aes(x = Var1, y = mean_fitness, color=Treatment)) + 
  geom_ribbon(aes(x = Var1, ymin = lower_2.5, ymax = upper_97.5, fill=Treatment), alpha = 0.25) +
  ylab("Population mean fitness") +
  xlab("Mean oviposition preference\n(larva per 100 shoots)") +
  scale_color_manual(values = treatmeant_colors) +
  scale_fill_manual(values = treatmeant_colors) +
  scale_y_continuous(breaks=c(0,0.25,0.5,0.75,1), limits = c(0,1))
  
uni_legend <- get_legend(uni_size)

uni_plots <- plot_grid(uni_size + theme(legend.position = "none"), 
                       uni_clutch + theme(legend.position = "none", 
                                          axis.title.y = element_blank(), axis.text.y = element_blank()),
                       uni_pref + theme(legend.position = "none", 
                                        axis.title.y = element_blank(), axis.text.y = element_blank()),
                       labels = "AUTO", ncol = 4, align='hv')

fitness_landscapes_1d <- ggdraw(uni_plots) + draw_grob(uni_legend, x = 0.8, y=0) #plot_grid(uni_plots, uni_legend, ncol=2, rel_widths = c(3,0.3))
fitness_landscapes_1d
save_plot("fitness_landscapes_1d.png", fitness_landscapes_1d, base_height=6, base_width = 8)

## 2-DIMENSIONAL
clutch.x.size_2d <- bind_rows(
  mutate(get_insect_FL.df(fl.individuals.x.size_treatment), Treatment="Simple"),
  mutate(get_insect_FL.df(fl.individuals.x.size_control), Treatment="Complex")) %>%
  ggplot(., aes(x=Var1, y=Var2, fill=mean_fitness)) +
  geom_raster() + 
  facet_wrap(~Treatment) +
  scale_fill_viridis(name = "Population\nmean fitness") +
  xlab("Mean gall size (mm)") +
  ylab("Mean clutch size (no. larva)")

size.x.pref_2d <- bind_rows(
  mutate(get_insect_FL.df(fl.size.x.density_treatment), Treatment="Simple"),
  mutate(get_insect_FL.df(fl.size.x.density_control), Treatment="Complex")) %>%
  ggplot(., aes(x=Var2, y=Var1, fill=mean_fitness)) +
  geom_raster() + 
  facet_wrap(~Treatment) +
  scale_fill_viridis(name = "Population\nmean fitness") +
  xlab("Mean gall size (mm)") +
  ylab("Mean oviposition preference (no. larva per 100 shoots)")

clutch.x.pref_2d <- bind_rows(
  mutate(get_insect_FL.df(fl.individuals.x.density_treatment), Treatment="Simple"),
  mutate(get_insect_FL.df(fl.individuals.x.density_control), Treatment="Complex")) %>%
  ggplot(., aes(x=Var2, y=Var1, fill=mean_fitness)) +
  geom_raster() + 
  facet_wrap(~Treatment) +
  scale_fill_viridis(name = "Population\nmean fitness") +
  xlab("Mean clutch size (no. larva)") +
  ylab("Mean oviposition preference (no. larva per 100 shoots)")

legend_2d <- get_legend(clutch.x.size_2d)

landscape_plots <- plot_grid(size.x.pref_2d + theme(legend.position = "none", axis.title.x = element_blank()),
                             clutch.x.pref_2d + theme(legend.position = "none", axis.title.y = element_blank()),
                             clutch.x.size_2d + theme(legend.position = "none"), nrow=2, align="hv")
fitness_landscapes_2d <- ggdraw(landscape_plots) + draw_grob(legend_2d, x = 0.7, y=-0.2)
save_plot("fitness_landscapes_2d.png", fitness_landscapes_2d, base_height=6, base_width = 8)
```

