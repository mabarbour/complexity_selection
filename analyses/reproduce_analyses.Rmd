---
title: "Reproduce analyses reported in: *Phenotypic evolution is more constrained in simpler food webs*"
author: "Matthew A. Barbour"
date: "`r Sys.Date()`"
output: github_document
fontsize: 12pt
---

```{r setup, include=FALSE}

## Load required libraries ----
library(car)        # for homogeneity of variance test
library(tidyverse)  # for managing data
library(cowplot)    # pretty default ggplots
library(broom)      # for tidying multiple linear models
library(visreg)     # for quick visualizations of model effects
library(viridis)    # for color palette
library(lme4)       # for generalized linear mixed models
library(piecewiseSEM) # for calculating model R-square
library(latex2exp)  # using Latex notation for axes labels
library(stringr)
library(MVN)        # assessing multivariate normality assumption

## Load and manage data ----

gall_selection.df <- read_csv("../data/gall_selection_data.csv") %>%
  # convert appropriate variables to characters instead of integers
  mutate(Plant_Position = as.character(Plant_Position),
         Gall_Number = as.character(Gall_Number)) %>%
  unite(Gall_ID, Gall_Number, Gall_Letter, remove = FALSE) %>%
  
  # subset data for analysis
  filter(phenology == "early", Location == "tree",
         platy > 0 | ectos > 0 | pupa > 0) %>%                  # eliminate unknown sources of mortality
  filter(Treatment.focus == "Ectoparasitoid exclusion" & ectos < 1 | Treatment.focus == "Control") %>% # excluding any larva that were parasitized by an ectoparasitoid in the exclusion experiment.
  mutate(Foodweb = ifelse(Treatment.focus=="Control","Complex","Simple"),
         gall_survival = as.numeric(ifelse(pupa > 0, 1, 0)),
         egg_parasitoid = as.numeric(ifelse(platy > 0, 1, 0)),
         # transform and scale traits to approximate multivariate normal assumption
         sc.Diam = as.numeric(scale(Gall_Height_mm)), 
         sc.log.Clutch = as.numeric(scale(log(gall_individuals))), 
         sc.sqrt.Pref = as.numeric(scale(sqrt(Density_per_100_shoots)))) 

## Custom functions to avoid repetitive code ----

## Transform logit to probability
inverse_logit <- function(x) exp(x)/(1+exp(x))

## Bootstrap fitness estimates
bootstrap_fitness <- function(logistic_model, newdata, bootstraps, intervals=c(0.025,0.975)){
  
  # Absolute fitness
  get_absolute_fitness <- function(.) predict(., newdata=newdata, type="response", re.form=~0) 
  
  if(is.null(bootstraps) == FALSE){
    set.seed(34) # make sure results are reproducible
    get_bootstraps_absolute_fitness <-bootMer(logistic_model, FUN = get_absolute_fitness, nsim=bootstraps, parallel="multicore", ncpus=32)
  
   get_intervals_absolute_fitness <- apply(get_bootstraps_absolute_fitness$t, 2, function(x) x[order(x)][c(round(bootstraps*intervals[1],0),round(bootstraps*intervals[2],0))])
   
  absolute_fitness_df <- data.frame(newdata, 
                    average = get_absolute_fitness(logistic_model), 
                    lower = get_intervals_absolute_fitness[1, ],
                    upper = get_intervals_absolute_fitness[2, ],
                    t(get_bootstraps_absolute_fitness$t))
  } else {
    absolute_fitness_df <- data.frame(newdata, 
                    average = get_absolute_fitness(logistic_model))
  }
  
  
  # Relative fitness
  get_relative_fitness <- function(.) get_absolute_fitness(.)/mean(get_absolute_fitness(.))
  
  if(is.null(bootstraps) == FALSE){
    set.seed(34) # make sure results are reproducible
    get_bootstraps_relative_fitness <-bootMer(logistic_model, FUN = get_relative_fitness, nsim=bootstraps, parallel="multicore", ncpus=32)
  
  get_intervals_relative_fitness <- apply(get_bootstraps_relative_fitness$t, 2, function(x) x[order(x)][c(round(bootstraps*intervals[1],0),round(bootstraps*intervals[2],0))])
    
  relative_fitness_df <- data.frame(newdata, 
                    average = get_relative_fitness(logistic_model), 
                    lower = get_intervals_relative_fitness[1, ],
                    upper = get_intervals_relative_fitness[2, ],
                    t(get_bootstraps_relative_fitness$t))
  } else {
      relative_fitness_df <- data.frame(newdata, 
                    average = get_relative_fitness(logistic_model))
  }
  
  # Organize data
  return(list(absolute_fitness = absolute_fitness_df, relative_fitness = relative_fitness_df))
}


## Number of bootstrap replicates
n_boots_analysis <- 1000
n_boots_plots <- 100


## Get confidence intervals from bootstrapped samples
conf.high <- function(x) quantile(x, probs = 0.975)
conf.low <- function(x) quantile(x, probs = 0.025)

## Color-blind friendly palette: http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/

# order -> orange, light blue, green, yellow, dark blue, red, pink
cbPalette <- c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#000000", "#999999")
complex_color <- cbPalette[6] # 1
simple_color <- cbPalette[5] # 2
treatment_colors <- c(complex_color, simple_color)

```

# Evaluating assumption of multivariate normality

We used graphical checks to evaluate whether our transformations of trait values resulted in a multivariate normal distribution. Figure S\ref{fig:Univariate_histograms} shows that our transformations resulted in approximately normal distributions for each phenotypic trait. Note also that in the multivariate quantile-quantile (Q-Q) plot, most points fall along the expected line (fig. S\ref{fig:Multivariate_QQ}), suggesting that our transformations provide a reasonable approximation of a multivariate normal distribution. 

```{r Univariate_histograms, echo=FALSE, fig.cap="\\label{fig:Univariate_histograms}Histograms of each phenotypic trait after transformation. The red line illustrates a normal distribution."}
mvn_univariate_hist <- mvn(select(gall_selection.df, sc.Diam, sc.log.Clutch, sc.sqrt.Pref), univariatePlot = "histogram")
```

```{r Multivariate_QQ, echo=FALSE, fig.cap="\\label{fig:Multivariate_QQ}Multivariate quantile-quantile (Q-Q) plot to assess deviations from multivariate normality (black line)."}
mvn_multivariate_qq <- mvn(select(gall_selection.df, sc.Diam, sc.log.Clutch, sc.sqrt.Pref), multivariatePlot = "qq")
```

# Effect of food-web treatment on trait-fitness relationships and selection gradients

We write the model in a way that independently estimates the effect of food-web treatment, each trait, and all two-way and three-way statistical interactions, on larval survival. The resulting estimates and confidence intervals are useful for determining whether trait-fitness relationships differ from zero, but not whether they differ between food-web treatments. For the later, we calculate the differences between each food-web treatment from the bootstrapped samples.

```{r Food-web model, cache=TRUE}
foodweb_model <- glmer(
  gall_survival ~ 
    -1 + Foodweb + 
    Foodweb:(sc.Diam + sc.log.Clutch + sc.sqrt.Pref) +
    Foodweb:(I(sc.Diam^2) + I(sc.log.Clutch^2) + I(sc.sqrt.Pref^2)) +
    Foodweb:(sc.Diam:sc.log.Clutch + sc.Diam:sc.sqrt.Pref + sc.log.Clutch:sc.sqrt.Pref) +
    (1|Genotype/Plant_Position/Gall_Number),
  data = gall_selection.df,
  family = binomial(link = logit), control=glmerControl(optimizer = "bobyqa"))
```

We used parametric bootstrapping to calculate 95% confidence intervals of trait-fitness relationships.

```{r Bootstrap food-web model, cache=TRUE}
boot_foodweb_model <- bootMer(foodweb_model, FUN = fixef, nsim=n_boots_analysis, parallel="multicore", ncpus=32)
```

In order to reliably quantify linear trait-fitness relationships, we remove all higher-order terms from the model [Stinchcombe et al. 2008](https://onlinelibrary.wiley.com/doi/full/10.1111/j.1558-5646.2008.00449.x).

```{r Linear food-web model, cache=TRUE}
linear_foodweb_model <- glmer(
  gall_survival ~ 
    -1 + Foodweb + 
    Foodweb:(sc.Diam + sc.log.Clutch + sc.sqrt.Pref) +
    (1|Genotype/Plant_Position/Gall_Number),
  data = gall_selection.df,
  family = binomial(link = logit), control=glmerControl(optimizer = "bobyqa"))
```

And refit using parametric bootstrapping.

```{r Bootstrap linear food-web model, cache=TRUE}
boot_linear_foodweb_model <- bootMer(linear_foodweb_model, FUN = fixef, nsim=n_boots_analysis, parallel="multicore", ncpus=32)
```

Chamber diameter, but not the other phenotypes, could be influenced by parasitism itself rather than being under natural selection. To estimate this potential bias, we subset our data to only include multi-chambered galls where there was variability in larval survival. We then fit a reduced model to estimate the bias in the logistic regression coefficient of chamber diameter in each food web.

```{r Bias in food-web model, cache=TRUE}

# Subset data
biased_foodweb_df <- gall_selection.df %>%
  group_by(Foodweb, Gall_Number) %>%
  mutate(mean_survival = mean(gall_survival)) %>%
  filter(mean_survival > 0, mean_survival < 1) %>%
  ungroup()

# Fit linear model with only chamber diameter 
biased_foodweb_model <- glmer(
  gall_survival ~ -1 + Foodweb + 
    Foodweb:sc.Diam + 
    (1|Genotype/Plant_Position/Gall_Number),
  data = biased_foodweb_df,
  family = binomial(link = logit), control=glmerControl(optimizer = "bobyqa"))

# Accuracy of confidence intervals is not a priority here, so we just use the asymptotic estimates rather than parametric bootstrapping.
biased_foodweb_confint <- tidy(biased_foodweb_model, conf.int=TRUE) %>% filter(group=="fixed")

# Print table
knitr::kable(biased_foodweb_confint)
```

We gather regression coefficients from the full and reduced model to display trait-fitness relationships. For chamber diameter, we subtracted the coefficient due to bias to better approximate the trait-fitness relationship. We also used the bootstrapped samples to calculate the differences in estimates between treatments (labelled **Diff**). The code for tidying this data is not displayed, but is available in the 'reproduce_analyses.Rmd'.

```{r Food-web alpha coefficients}
foodweb_bind <- bind_cols(
  as_tibble(boot_linear_foodweb_model$t),
  select(as_tibble(boot_foodweb_model$t), `FoodwebComplex:I(sc.Diam^2)`:`FoodwebSimple:sc.log.Clutch:sc.sqrt.Pref`) # only retain nonlinear coefficients from full model
)

# Adjust coefficients with chamber diameter
foodweb_adj_Diam <- foodweb_bind %>%
  mutate(`FoodwebComplex:sc.Diam` = `FoodwebComplex:sc.Diam` - fixef(biased_foodweb_model)["FoodwebComplex:sc.Diam"],
         `FoodwebSimple:sc.Diam` = `FoodwebSimple:sc.Diam` - fixef(biased_foodweb_model)["FoodwebSimple:sc.Diam"])

# Calculate differences between food-web treatments, then estimate means and confidence intervals
foodweb_alphas <- foodweb_adj_Diam %>%
  mutate(`FoodwebSimple:(Intercept)`=inverse_logit(FoodwebSimple), `FoodwebComplex:(Intercept)`=inverse_logit(FoodwebComplex)) %>% # logit transform to make intercept interpretable as a probability
  select(-FoodwebSimple, -FoodwebComplex) %>% # translated into (Intercept) terms
  mutate(`FoodwebDiff:(Intercept)` = `FoodwebSimple:(Intercept)` - `FoodwebComplex:(Intercept)`,
         `FoodwebDiff:sc.Diam` = `FoodwebSimple:sc.Diam` - `FoodwebComplex:sc.Diam`,
         `FoodwebDiff:sc.log.Clutch` = `FoodwebSimple:sc.log.Clutch` - `FoodwebComplex:sc.log.Clutch`,
         `FoodwebDiff:sc.sqrt.Pref` = `FoodwebSimple:sc.sqrt.Pref` - `FoodwebComplex:sc.sqrt.Pref`,
         `FoodwebDiff:I(sc.Diam^2)` = `FoodwebSimple:I(sc.Diam^2)` - `FoodwebComplex:I(sc.Diam^2)`,
         `FoodwebDiff:I(sc.log.Clutch^2)` = `FoodwebSimple:I(sc.log.Clutch^2)` - `FoodwebComplex:I(sc.log.Clutch^2)`,
         `FoodwebDiff:I(sc.sqrt.Pref^2)` = `FoodwebSimple:I(sc.sqrt.Pref^2)` - `FoodwebComplex:I(sc.sqrt.Pref^2)`,
         `FoodwebDiff:sc.Diam:sc.log.Clutch` = `FoodwebSimple:sc.Diam:sc.log.Clutch` - `FoodwebComplex:sc.Diam:sc.log.Clutch`,
         `FoodwebDiff:sc.Diam:sc.sqrt.Pref` = `FoodwebSimple:sc.Diam:sc.sqrt.Pref` - `FoodwebComplex:sc.Diam:sc.sqrt.Pref`,
         `FoodwebDiff:sc.log.Clutch:sc.sqrt.Pref` = `FoodwebSimple:sc.log.Clutch:sc.sqrt.Pref` - `FoodwebComplex:sc.log.Clutch:sc.sqrt.Pref`) %>%
  summarise_all(funs(mean, conf.high, conf.low))

# Tidy up estimates
tidy_foodweb_alphas <- foodweb_alphas %>%
  t() %>%
  as.data.frame() %>%
  transmute(rows = rownames(.), value=V1) %>%
  separate(col = rows, into = c("term","estimate"), sep="_") %>%
  separate(col = term, into = c("type","term_1","term_2"), sep=":", extra="drop") %>%
  mutate(term = ifelse(is.na(term_2), term_1, paste(term_1,term_2,sep=":"))) %>%
  separate(col = type, into = c("extra","type"), sep = 7) %>%
  select(type, term, estimate, value) %>%
  spread(estimate, value) %>%
  mutate(P_cutoff = ifelse(conf.high*conf.low < 0, "","*"),
         coefficient_type = ifelse(term=="(Intercept)","Mean fitness",
                                   ifelse(grepl("\\^2", .$term)==TRUE, "Quadratic",
                                          ifelse(grepl(":", .$term)==TRUE, "Correlational","Linear"))))
```

Table of trait-fitness relationships:

```{r Table of food web coefficients}
knitr::kable(tidy_foodweb_alphas)
```

Plot these trait-fitness relationships: 

```{r Plot food-web coefficients}

# Plot helpers
dodge_width <- position_dodge(width=0.5)
y_limits_foodweb_coefs <- c(min(filter(tidy_foodweb_alphas, type!="Diff")$conf.low), 
                            max(filter(tidy_foodweb_alphas, type!="Diff")$conf.high))
P_asterisk_foodweb_coefs <- 1.5
P_size <- 8
legend_foodweb_labels <- c("Complex","Simple")
point.size <- 3

# Plot mean fitness
plot_foodweb_mean_fitness <- tidy_foodweb_alphas %>%
  filter(type!="Diff", term=="(Intercept)") %>%
  ggplot(., aes(x=type)) +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_foodweb_alphas, type=="Diff", term=="(Intercept)"), aes(y=0.8, x=1.5, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="larval survival", limits=c(0,1), breaks=c(0,0.2,0.4,0.6,0.8,1)) +
  xlab("Food web") +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(6,5)], labels=legend_foodweb_labels) +
  scale_color_manual(values=cbPalette[c(6,5)], labels=legend_foodweb_labels) 

# Plot linear trait-fitness relationaships
plot_foodweb_linear_coefs <- tidy_foodweb_alphas %>%
  filter(type!="Diff", term %in% c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_foodweb_alphas, type=="Diff", term %in% c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref")), 
            aes(y=P_asterisk_foodweb_coefs, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Coefficient", limits=y_limits_foodweb_coefs) +
  scale_x_discrete(name="", labels=parse(text=c("alpha[Diam]","alpha[Clutch]","alpha[Pref]"))) +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(6,5)], labels=legend_foodweb_labels) +
  scale_color_manual(values=cbPalette[c(6,5)], labels=legend_foodweb_labels)

# Plot quadratic trait-fitness relationships
plot_foodweb_quadratic_coefs <- tidy_foodweb_alphas %>%
  filter(type!="Diff", term %in% c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_foodweb_alphas, type=="Diff", term %in% c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)")), 
            aes(y=P_asterisk_foodweb_coefs, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Coefficient", limits=y_limits_foodweb_coefs) +
  scale_x_discrete(name="", labels=parse(text=c("alpha[Diam:Diam]","alpha[Clutch:Clutch]","alpha[Pref:Pref]"))) +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(6,5)], labels=legend_foodweb_labels) +
  scale_color_manual(values=cbPalette[c(6,5)], labels=legend_foodweb_labels)

# Plot correlational trait-fitness relationaships
plot_foodweb_correlational_coefs <- tidy_foodweb_alphas %>%
  filter(type!="Diff", term %in% c("sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_foodweb_alphas, type=="Diff", term %in% c("sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref")), 
            aes(y=P_asterisk_foodweb_coefs, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Coefficient", limits=y_limits_foodweb_coefs) +
  scale_x_discrete(name="", labels=parse(text=c("alpha[Diam:Clutch]","alpha[Diam:Pref]","alpha[Clutch:Pref]"))) +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(6,5)], labels=legend_foodweb_labels) +
  scale_color_manual(values=cbPalette[c(6,5)], labels=legend_foodweb_labels) 

# Format plots for manuscript
plot_foodweb_coefs <- plot_grid(
  plot_foodweb_mean_fitness + theme(legend.position = "none"),
  plot_foodweb_linear_coefs + theme(legend.position = "none"),
  plot_foodweb_quadratic_coefs + theme(legend.position = "none"),
  plot_foodweb_correlational_coefs + theme(legend.position = "none"), 
  nrow=2, align="hv", labels = "")

figure_foodweb_coefs <- plot_foodweb_coefs 
figure_foodweb_coefs
```

Using the methods proposed by [Janzen and Stern, 1998](https://onlinelibrary.wiley.com/doi/10.1111/j.1558-5646.1998.tb02237.x), we estimated selection gradients from our trait-fitness relationships.

```{r Food-web selection gradients}

# Estimate mean fitness and mean "brackets" for each food-web treatment (see Janzen and Stern 1998 equation 4 for details about "brackets")
foodweb_complex_predict <- predict(foodweb_model, newdata=filter(gall_selection.df, Foodweb=="Complex"), type="response")
foodweb_complex_mean_brackets <- mean(foodweb_complex_predict * (1 - foodweb_complex_predict))
foodweb_complex_mean_fitness <- mean(foodweb_complex_predict)

foodweb_simple_predict <- predict(foodweb_model, newdata=filter(gall_selection.df, Foodweb=="Simple"), type="response")
foodweb_simple_mean_brackets <- mean(foodweb_simple_predict * (1 - foodweb_simple_predict))
foodweb_simple_mean_fitness <- mean(foodweb_simple_predict)

foodweb_complex_gradient <- function(x) foodweb_complex_mean_brackets * x / foodweb_complex_mean_fitness
foodweb_simple_gradient <- function(x) foodweb_simple_mean_brackets * x / foodweb_simple_mean_fitness

foodweb_complex_raw_gradients <- select(foodweb_adj_Diam, starts_with("FoodwebComplex:")) %>%
  transmute_all(funs(foodweb_complex_gradient))

foodweb_simple_raw_gradients <- select(foodweb_adj_Diam, starts_with("FoodwebSimple:")) %>%
  transmute_all(funs(foodweb_simple_gradient))

# Calculate differences between food-web treatments, then estimate means and confidence intervals
foodweb_grads <- bind_cols(foodweb_complex_raw_gradients, foodweb_simple_raw_gradients) %>%
  mutate(`FoodwebDiff:sc.Diam` = `FoodwebSimple:sc.Diam` - `FoodwebComplex:sc.Diam`,
         `FoodwebDiff:sc.log.Clutch` = `FoodwebSimple:sc.log.Clutch` - `FoodwebComplex:sc.log.Clutch`,
         `FoodwebDiff:sc.sqrt.Pref` = `FoodwebSimple:sc.sqrt.Pref` - `FoodwebComplex:sc.sqrt.Pref`,
         `FoodwebDiff:I(sc.Diam^2)` = `FoodwebSimple:I(sc.Diam^2)` - `FoodwebComplex:I(sc.Diam^2)`,
         `FoodwebDiff:I(sc.log.Clutch^2)` = `FoodwebSimple:I(sc.log.Clutch^2)` - `FoodwebComplex:I(sc.log.Clutch^2)`,
         `FoodwebDiff:I(sc.sqrt.Pref^2)` = `FoodwebSimple:I(sc.sqrt.Pref^2)` - `FoodwebComplex:I(sc.sqrt.Pref^2)`,
         `FoodwebDiff:sc.Diam:sc.log.Clutch` = `FoodwebSimple:sc.Diam:sc.log.Clutch` - `FoodwebComplex:sc.Diam:sc.log.Clutch`,
         `FoodwebDiff:sc.Diam:sc.sqrt.Pref` = `FoodwebSimple:sc.Diam:sc.sqrt.Pref` - `FoodwebComplex:sc.Diam:sc.sqrt.Pref`,
         `FoodwebDiff:sc.log.Clutch:sc.sqrt.Pref` = `FoodwebSimple:sc.log.Clutch:sc.sqrt.Pref` - `FoodwebComplex:sc.log.Clutch:sc.sqrt.Pref`) %>%
  summarise_all(funs(mean, conf.high, conf.low))


# Tidy up estimates
tidy_foodweb_grads <- foodweb_grads %>%
  t() %>%
  as.data.frame() %>%
  transmute(rows = rownames(.), value=V1) %>%
  separate(col = rows, into = c("term","estimate"), sep="_") %>%
  separate(col = term, into = c("type","term_1","term_2"), sep=":", extra="drop") %>%
  mutate(term = ifelse(is.na(term_2), term_1, paste(term_1,term_2,sep=":"))) %>%
  separate(col = type, into = c("extra","type"), sep = 7) %>%
  select(type, term, estimate, value) %>%
  spread(estimate, value) %>%
  mutate(P_cutoff = ifelse(conf.high*conf.low < 0, "","*"),
         gradient_type = ifelse(grepl("\\^2", .$term)==TRUE, "Quadratic",
                                ifelse(grepl(":", .$term)==TRUE, "Correlational","Directional")),
         mean = ifelse(gradient_type=="Quadratic", 2*mean, mean),
         conf.low = ifelse(gradient_type=="Quadratic", 2*conf.low, conf.low),
         conf.high = ifelse(gradient_type=="Quadratic", 2*conf.high, conf.high))
```

Table of selection gradients.

```{r Table of food web selection gradients, echo=F}
knitr::kable(tidy_foodweb_grads)
```

Plot of selection gradients.

```{r Plot food-web gradients}

# Plot helpers
dodge_width <- position_dodge(width=0.5)
y_limits_foodweb_grads <- c(min(filter(tidy_foodweb_grads, type!="Diff")$conf.low), 
                            max(filter(tidy_foodweb_grads, type!="Diff")$conf.high))
P_asterisk_foodweb_grads <- 0.5
P_size <- 8
legend_foodweb_labels <- c("Complex","Simple")
legend_foodweb_title <- "Food web"
point.size <- 3

# Plot directional selection gradients
plot_foodweb_directional_grads <- tidy_foodweb_grads %>%
  filter(type!="Diff", term %in% c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_foodweb_grads, type=="Diff", term %in% c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref")), 
            aes(y=P_asterisk_foodweb_grads, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Gradient", limits=y_limits_foodweb_grads) +
  scale_x_discrete(name="", labels=parse(text=c("beta[Diam]","beta[Clutch]","beta[Pref]"))) +
  facet_wrap(~gradient_type) +
  scale_fill_manual(values=cbPalette[c(6,5)], labels=legend_foodweb_labels, name=legend_foodweb_title) +
  scale_color_manual(values=cbPalette[c(6,5)], labels=legend_foodweb_labels, name=legend_foodweb_title)

# Plot quadratic selection gradients
plot_foodweb_quadratic_grads <- tidy_foodweb_grads %>%
  filter(type!="Diff", term %in% c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_foodweb_grads, type=="Diff", term %in% c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)")), 
            aes(y=P_asterisk_foodweb_grads, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Gradient", limits=y_limits_foodweb_grads) +
  scale_x_discrete(name="", labels=parse(text=c("gamma[Diam:Diam]","gamma[Clutch:Clutch]","gamma[Pref:Pref]"))) +
  facet_wrap(~gradient_type) +
  scale_fill_manual(values=cbPalette[c(6,5)], labels=legend_foodweb_labels, name=legend_foodweb_title) +
  scale_color_manual(values=cbPalette[c(6,5)], labels=legend_foodweb_labels, name=legend_foodweb_title)

# Plot correlational selection gradients
plot_foodweb_correlational_grads <- tidy_foodweb_grads %>%
  filter(type!="Diff", term %in% c("sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_foodweb_grads, type=="Diff", term %in% c("sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref")), 
            aes(y=P_asterisk_foodweb_grads, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Gradient", limits=y_limits_foodweb_grads) +
  scale_x_discrete(name="", labels=parse(text=c("gamma[Diam:Clutch]","gamma[Diam:Pref]","gamma[Clutch:Pref]"))) +
  facet_wrap(~gradient_type) +
  scale_fill_manual(values=cbPalette[c(6,5)], labels=legend_foodweb_labels, name=legend_foodweb_title) +
  scale_color_manual(values=cbPalette[c(6,5)], labels=legend_foodweb_labels, name=legend_foodweb_title) 

# Get legend
legend_foodweb_grads <- get_legend(plot_foodweb_directional_grads)

# Format plots for manuscript
plot_foodweb_grads <- plot_grid(
  plot_foodweb_directional_grads + theme(legend.position = "none", axis.title = element_blank()),
  plot_foodweb_quadratic_grads + theme(legend.position = "none", axis.title = element_blank()),
  plot_foodweb_correlational_grads + theme(legend.position = "none", axis.title = element_blank()), 
  nrow=2, align="hv", labels = "")
plot_legend_foodweb_grads <- ggdraw(plot_foodweb_grads) + draw_grob(legend_foodweb_grads, x = 0.7, y=-0.2)
y_title_foodweb_grads <- ggdraw() + draw_label("Selection gradient (SDs)", angle = 90)

figure_foodweb_grads <- plot_grid(y_title_foodweb_grads, plot_legend_foodweb_grads, ncol=2, rel_widths = c(0.05,1)) 
figure_foodweb_grads
```

# Partitioning the contribution of egg and larval parasitoids to selection gradients

Our simple food-web treatment allows us to estimate the unique contribution of egg parasitoids to selection on *Iteomyia* traits. To estimate the unique contribution of larval parasitoids, we subset our data so that our complex food-web treatment only contained attack by larval parasitoids (and gall survival). We then fit the same models as previously, including one to estimate bias.

```{r Egg vs. larval ptoid model, cache=TRUE}
# excludes cases of egg-parasitism from Complex food web
egglarval_df <- filter(gall_selection.df, Foodweb == "Simple" | Foodweb == "Complex" & platy < 1) 

# fit model with same structure as foodweb_model
egglarval_model <- update(foodweb_model, data=egglarval_df)

# subset data to estimate bias
biased_egglarval_df <- egglarval_df %>%
  group_by(Foodweb, Gall_Number) %>%
  mutate(mean_survival = mean(gall_survival)) %>%
  filter(mean_survival > 0, mean_survival < 1) %>%
  ungroup()

# fit model with same structure as biased_foodweb_model
biased_egglarval_model <- update(biased_foodweb_model, data=biased_egglarval_df)
```

Parametric bootstrapping to estimate confidence intervals

```{r Bootstrap egg vs. larval ptoid model, cache=TRUE}
boot_egglarval_model <- bootMer(egglarval_model, FUN = fixef, nsim=n_boots_analysis, parallel="multicore", ncpus=32)
```

Fit a reduced model to reliably estimate linear trait-fitness relationships.

```{r Linear egg vs. larval ptoid model, cache=TRUE}
linear_egglarval_model <- update(linear_foodweb_model, data=egglarval_df)
```

Parametric bootstrapping to estimate confidence intervals.

```{r Bootstrap linear egg vs. larval model, cache=TRUE}
boot_linear_egglarval_model <- bootMer(linear_egglarval_model, FUN = fixef, nsim=n_boots_analysis, parallel="multicore", ncpus=32)
```

Tidy trait-fitness relationships for egg and larval parasitoids from above models.

```{r Egg vs. larval ptoid alpha coefficients}
egglarval_bind <- bind_cols(
  as_tibble(boot_linear_egglarval_model$t),
  select(as_tibble(boot_egglarval_model$t), `FoodwebComplex:I(sc.Diam^2)`:`FoodwebSimple:sc.log.Clutch:sc.sqrt.Pref`) # only retain nonlinear coefficients from full model
)

# Adjust coefficients with chamber diameter
egglarval_adj_Diam <- as_tibble(boot_egglarval_model$t) %>%
  mutate(`FoodwebComplex:sc.Diam` = `FoodwebComplex:sc.Diam` - fixef(biased_egglarval_model)["FoodwebComplex:sc.Diam"],
         `FoodwebSimple:sc.Diam` = `FoodwebSimple:sc.Diam` - fixef(biased_egglarval_model)["FoodwebSimple:sc.Diam"])

# Calculate differences between food-web treatments, then estimate means and confidence intervals
egglarval_alphas <- egglarval_adj_Diam %>%
  mutate(`FoodwebSimple:(Intercept)`=inverse_logit(FoodwebSimple), `FoodwebComplex:(Intercept)`=inverse_logit(FoodwebComplex)) %>% # logit transform to make intercept interpretable as a probability
  select(-FoodwebSimple, -FoodwebComplex) %>% # translated into (Intercept) terms
  mutate(`FoodwebDiff:(Intercept)` = `FoodwebSimple:(Intercept)` - `FoodwebComplex:(Intercept)`,
         `FoodwebDiff:sc.Diam` = `FoodwebSimple:sc.Diam` - `FoodwebComplex:sc.Diam`,
         `FoodwebDiff:sc.log.Clutch` = `FoodwebSimple:sc.log.Clutch` - `FoodwebComplex:sc.log.Clutch`,
         `FoodwebDiff:sc.sqrt.Pref` = `FoodwebSimple:sc.sqrt.Pref` - `FoodwebComplex:sc.sqrt.Pref`,
         `FoodwebDiff:I(sc.Diam^2)` = `FoodwebSimple:I(sc.Diam^2)` - `FoodwebComplex:I(sc.Diam^2)`,
         `FoodwebDiff:I(sc.log.Clutch^2)` = `FoodwebSimple:I(sc.log.Clutch^2)` - `FoodwebComplex:I(sc.log.Clutch^2)`,
         `FoodwebDiff:I(sc.sqrt.Pref^2)` = `FoodwebSimple:I(sc.sqrt.Pref^2)` - `FoodwebComplex:I(sc.sqrt.Pref^2)`,
         `FoodwebDiff:sc.Diam:sc.log.Clutch` = `FoodwebSimple:sc.Diam:sc.log.Clutch` - `FoodwebComplex:sc.Diam:sc.log.Clutch`,
         `FoodwebDiff:sc.Diam:sc.sqrt.Pref` = `FoodwebSimple:sc.Diam:sc.sqrt.Pref` - `FoodwebComplex:sc.Diam:sc.sqrt.Pref`,
         `FoodwebDiff:sc.log.Clutch:sc.sqrt.Pref` = `FoodwebSimple:sc.log.Clutch:sc.sqrt.Pref` - `FoodwebComplex:sc.log.Clutch:sc.sqrt.Pref`) %>%
  summarise_all(funs(mean, conf.high, conf.low))

# Tidy up estimates
tidy_egglarval_alphas <- egglarval_alphas %>%
  t() %>%
  as.data.frame() %>%
  transmute(rows = rownames(.), value=V1) %>%
  separate(col = rows, into = c("term","estimate"), sep="_") %>%
  separate(col = term, into = c("type","term_1","term_2"), sep=":", extra="drop") %>%
  mutate(term = ifelse(is.na(term_2), term_1, paste(term_1,term_2,sep=":"))) %>%
  separate(col = type, into = c("extra","type"), sep = 7) %>%
  select(type, term, estimate, value) %>%
  spread(estimate, value) %>%
  mutate(P_cutoff = ifelse(conf.high*conf.low < 0, "","*"),
         coefficient_type = ifelse(term=="(Intercept)","Mean fitness",
                                   ifelse(grepl("\\^2", .$term)==TRUE, "Quadratic",
                                          ifelse(grepl(":", .$term)==TRUE, "Correlational","Linear"))))
```

Table of trait-fitness relationships for egg and larval parasitoids.

```{r Tabel of egg vs. larval coefficients}
knitr::kable(tidy_egglarval_alphas)
```

Plot of trait-fitness relationships for egg and larval parasitoids.

```{r Plot egglarval coefficients}

# Plot helpers
dodge_width <- position_dodge(width=0.5)
y_limits_egglarval_coefs <- c(min(filter(tidy_egglarval_alphas, type!="Diff")$conf.low), 
                            max(filter(tidy_egglarval_alphas, type!="Diff")$conf.high))
P_asterisk_egglarval_coefs <- 1.3
P_size <- 8
legend_egglarval_labels <- c("Larval","Egg")
point.size <- 3

# Plot mean fitness
plot_egglarval_mean_fitness <- tidy_egglarval_alphas %>%
  filter(type!="Diff", term=="(Intercept)") %>%
  ggplot(., aes(x=type)) +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_egglarval_alphas, type=="Diff", term=="(Intercept)"), aes(y=0.9, x=1.5, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="larval survival", limits=c(0,1), breaks=c(0,0.2,0.4,0.6,0.8,1)) +
  scale_x_discrete(name="Parasitoid", breaks=c("Complex","Simple"), labels=c("Larval","Egg")) +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(4,5)], labels=legend_egglarval_labels) +
  scale_color_manual(values=cbPalette[c(4,5)], labels=legend_egglarval_labels) 

# Plot linear trait-fitness relationaships
plot_egglarval_linear_coefs <- tidy_egglarval_alphas %>%
  filter(type!="Diff", term %in% c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_egglarval_alphas, type=="Diff", term %in% c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref")), 
            aes(y=P_asterisk_egglarval_coefs, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Coefficient", limits=y_limits_egglarval_coefs) +
  scale_x_discrete(name="", labels=parse(text=c("alpha[Diam]","alpha[Clutch]","alpha[Pref]"))) +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(4,5)], labels=legend_egglarval_labels) +
  scale_color_manual(values=cbPalette[c(4,5)], labels=legend_egglarval_labels)

# Plot quadratic trait-fitness relationships
plot_egglarval_quadratic_coefs <- tidy_egglarval_alphas %>%
  filter(type!="Diff", term %in% c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_egglarval_alphas, type=="Diff", term %in% c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)")), 
            aes(y=P_asterisk_egglarval_coefs, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Coefficient", limits=y_limits_egglarval_coefs) +
  scale_x_discrete(name="", labels=parse(text=c("alpha[Diam:Diam]","alpha[Clutch:Clutch]","alpha[Pref:Pref]"))) +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(4,5)], labels=legend_egglarval_labels) +
  scale_color_manual(values=cbPalette[c(4,5)], labels=legend_egglarval_labels)

# Plot correlational trait-fitness relationaships
plot_egglarval_correlational_coefs <- tidy_egglarval_alphas %>%
  filter(type!="Diff", term %in% c("sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_egglarval_alphas, type=="Diff", term %in% c("sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref")), 
            aes(y=P_asterisk_egglarval_coefs, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Coefficient", limits=y_limits_egglarval_coefs) +
  scale_x_discrete(name="", labels=parse(text=c("alpha[Diam:Clutch]","alpha[Diam:Pref]","alpha[Clutch:Pref]"))) +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(4,5)], labels=legend_egglarval_labels) +
  scale_color_manual(values=cbPalette[c(4,5)], labels=legend_egglarval_labels) 

# Format plots for manuscript
plot_egglarval_coefs <- plot_grid(
  plot_egglarval_mean_fitness + theme(legend.position = "none"),
  plot_egglarval_linear_coefs + theme(legend.position = "none"),
  plot_egglarval_quadratic_coefs + theme(legend.position = "none"),
  plot_egglarval_correlational_coefs + theme(legend.position = "none"), 
  nrow=2, align="hv", labels = "")

figure_egglarval_coefs <- plot_egglarval_coefs 
figure_egglarval_coefs
```

Calculate selection gradients from trait-fitness relationships.

```{r Egg vs. larval ptoid selection gradients}

# Estimate mean fitness and mean "brackets" for each food-web treatment (see Janzen and Stern 1998 equation 4 for details about "brackets")
egglarval_complex_predict <- predict(egglarval_model, newdata=filter(egglarval_df, Foodweb=="Complex"), type="response")
egglarval_complex_mean_brackets <- mean(egglarval_complex_predict * (1 - egglarval_complex_predict))
egglarval_complex_mean_fitness <- mean(egglarval_complex_predict)

egglarval_simple_predict <- predict(egglarval_model, newdata=filter(egglarval_df, Foodweb=="Simple"), type="response")
egglarval_simple_mean_brackets <- mean(egglarval_simple_predict * (1 - egglarval_simple_predict))
egglarval_simple_mean_fitness <- mean(egglarval_simple_predict)

egglarval_complex_gradient <- function(x) egglarval_complex_mean_brackets * x / egglarval_complex_mean_fitness
egglarval_simple_gradient <- function(x) egglarval_simple_mean_brackets * x / egglarval_simple_mean_fitness

egglarval_complex_raw_gradients <- select(egglarval_adj_Diam, starts_with("FoodwebComplex:")) %>%
  transmute_all(funs(egglarval_complex_gradient))

egglarval_simple_raw_gradients <- select(egglarval_adj_Diam, starts_with("FoodwebSimple:")) %>%
  transmute_all(funs(egglarval_simple_gradient))

# Calculate differences between food-web treatments, then estimate means and confidence intervals
egglarval_grads <- bind_cols(egglarval_complex_raw_gradients, egglarval_simple_raw_gradients) %>%
  mutate(`FoodwebDiff:sc.Diam` = `FoodwebSimple:sc.Diam` - `FoodwebComplex:sc.Diam`,
         `FoodwebDiff:sc.log.Clutch` = `FoodwebSimple:sc.log.Clutch` - `FoodwebComplex:sc.log.Clutch`,
         `FoodwebDiff:sc.sqrt.Pref` = `FoodwebSimple:sc.sqrt.Pref` - `FoodwebComplex:sc.sqrt.Pref`,
         `FoodwebDiff:I(sc.Diam^2)` = `FoodwebSimple:I(sc.Diam^2)` - `FoodwebComplex:I(sc.Diam^2)`,
         `FoodwebDiff:I(sc.log.Clutch^2)` = `FoodwebSimple:I(sc.log.Clutch^2)` - `FoodwebComplex:I(sc.log.Clutch^2)`,
         `FoodwebDiff:I(sc.sqrt.Pref^2)` = `FoodwebSimple:I(sc.sqrt.Pref^2)` - `FoodwebComplex:I(sc.sqrt.Pref^2)`,
         `FoodwebDiff:sc.Diam:sc.log.Clutch` = `FoodwebSimple:sc.Diam:sc.log.Clutch` - `FoodwebComplex:sc.Diam:sc.log.Clutch`,
         `FoodwebDiff:sc.Diam:sc.sqrt.Pref` = `FoodwebSimple:sc.Diam:sc.sqrt.Pref` - `FoodwebComplex:sc.Diam:sc.sqrt.Pref`,
         `FoodwebDiff:sc.log.Clutch:sc.sqrt.Pref` = `FoodwebSimple:sc.log.Clutch:sc.sqrt.Pref` - `FoodwebComplex:sc.log.Clutch:sc.sqrt.Pref`) %>%
  summarise_all(funs(mean, conf.high, conf.low))

# Tidy up estimates
tidy_egglarval_grads <- egglarval_grads %>%
  t() %>%
  as.data.frame() %>%
  transmute(rows = rownames(.), value=V1) %>%
  separate(col = rows, into = c("term","estimate"), sep="_") %>%
  separate(col = term, into = c("type","term_1","term_2"), sep=":", extra="drop") %>%
  mutate(term = ifelse(is.na(term_2), term_1, paste(term_1,term_2,sep=":"))) %>%
  separate(col = type, into = c("extra","type"), sep = 7) %>%
  select(type, term, estimate, value) %>%
  spread(estimate, value) %>%
  mutate(P_cutoff = ifelse(conf.high*conf.low < 0, "","*"),
         gradient_type = ifelse(grepl("\\^2", .$term)==TRUE, "Quadratic",
                                ifelse(grepl(":", .$term)==TRUE, "Correlational","Directional")),
         mean = ifelse(gradient_type=="Quadratic", 2*mean, mean),
         conf.low = ifelse(gradient_type=="Quadratic", 2*conf.low, conf.low),
         conf.high = ifelse(gradient_type=="Quadratic", 2*conf.high, conf.high))
```

Table of selection gradients imposed by egg and larval parasitoids.

```{r Egg vs. larval selection gradients, echo=F}
knitr::kable(tidy_egglarval_grads)
```

Plot of selection gradients imposed by egg and larval parasitoids.

```{r Plot egg vs. larval ptoid gradients, echo=FALSE}

# Plot helpers
dodge_width <- position_dodge(width=0.5)
y_limits_egglarval_grads <- c(min(filter(tidy_egglarval_grads, type!="Diff")$conf.low), 
                            max(filter(tidy_egglarval_grads, type!="Diff")$conf.high))
P_asterisk_egglarval_grads <- 0.25
P_size <- 8
legend_egglarval_labels <- c("Larval","Egg")
legend_egglarval_title <- "Parasitoid"
point.size <- 3

# Plot directional selection gradients
plot_egglarval_directional_grads <- tidy_egglarval_grads %>%
  filter(type!="Diff", term %in% c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_egglarval_grads, type=="Diff", term %in% c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref")), 
            aes(y=P_asterisk_egglarval_grads, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Gradient", limits=y_limits_egglarval_grads) +
  scale_x_discrete(name="", labels=parse(text=c("beta[Diam]","beta[Clutch]","beta[Pref]"))) +
  facet_wrap(~gradient_type) +
  scale_fill_manual(values=cbPalette[c(4,5)], labels=legend_egglarval_labels, name=legend_egglarval_title) +
  scale_color_manual(values=cbPalette[c(4,5)], labels=legend_egglarval_labels, name=legend_egglarval_title)

# Plot quadratic selection gradients
plot_egglarval_quadratic_grads <- tidy_egglarval_grads %>%
  filter(type!="Diff", term %in% c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_egglarval_grads, type=="Diff", term %in% c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)")), 
            aes(y=P_asterisk_egglarval_grads, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Gradient", limits=y_limits_egglarval_grads) +
  scale_x_discrete(name="", labels=parse(text=c("gamma[Diam:Diam]","gamma[Clutch:Clutch]","gamma[Pref:Pref]"))) +
  facet_wrap(~gradient_type) +
  scale_fill_manual(values=cbPalette[c(4,5)], labels=legend_egglarval_labels, name=legend_egglarval_title) +
  scale_color_manual(values=cbPalette[c(4,5)], labels=legend_egglarval_labels, name=legend_egglarval_title)

# Plot correlational selection gradients
plot_egglarval_correlational_grads <- tidy_egglarval_grads %>%
  filter(type!="Diff", term %in% c("sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_egglarval_grads, type=="Diff", term %in% c("sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref")), 
            aes(y=P_asterisk_egglarval_grads, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Gradient", limits=y_limits_egglarval_grads) +
  scale_x_discrete(name="", labels=parse(text=c("gamma[Diam:Clutch]","gamma[Diam:Pref]","gamma[Clutch:Pref]"))) +
  facet_wrap(~gradient_type) +
  scale_fill_manual(values=cbPalette[c(4,5)], labels=legend_egglarval_labels, name=legend_egglarval_title) +
  scale_color_manual(values=cbPalette[c(4,5)], labels=legend_egglarval_labels, name=legend_egglarval_title) 

# Get legend
legend_egglarval_grads <- get_legend(plot_egglarval_directional_grads)

# Format plots for manuscript
plot_egglarval_grads <- plot_grid(
  plot_egglarval_directional_grads + theme(legend.position = "none", axis.title = element_blank()),
  plot_egglarval_quadratic_grads + theme(legend.position = "none", axis.title = element_blank()),
  plot_egglarval_correlational_grads + theme(legend.position = "none", axis.title = element_blank()), 
  nrow=2, align="hv", labels = "")
plot_legend_egglarval_grads <- ggdraw(plot_egglarval_grads) + draw_grob(legend_egglarval_grads, x = 0.7, y=-0.2)
y_title_egglarval_grads <- ggdraw() + draw_label("Selection gradient (SDs)", angle = 90)

figure_egglarval_grads <- plot_grid(y_title_egglarval_grads, plot_legend_egglarval_grads, ncol=2, rel_widths = c(0.05,1)) 
figure_egglarval_grads
```


We combine our estimates of selection gradients for each food-web treatment as well as the contribution of larval parasitoids to selection in the complex food web.

```{r Figure-Selection-Gradients, echo=FALSE, fig.cap="**Selection gradients**. Estimates of standardized selection gradients in complex (orange) and simple (blue) food webs. The contribution of larval parasitoids (yellow) was estimated with a subset of the complex food-web data that only contained attacks from larval parasitoids (and gall survival). Points and lines correspond to estimates of the mean and 95% confidence intervals, respectively. Overlapping confidence intervals with zero (dotted line) indicate no strong evidence of selection.", include=FALSE}
tidy_foodwebegglarval_grads <- bind_rows(
  tidy_foodweb_grads, mutate(filter(tidy_egglarval_grads, type=="Complex"), type="Larval")
)
tidy_foodwebegglarval_grads$type <- factor(tidy_foodwebegglarval_grads$type, levels=c("Complex","Simple","Larval","Diff"))

# Plot helpers
dodge_width <- position_dodge(width=0.5)
y_limits_foodwebegglarval_grads <- c(min(filter(tidy_foodwebegglarval_grads, type!="Diff")$conf.low), 
                            max(filter(tidy_foodwebegglarval_grads, type!="Diff")$conf.high))
P_asterisk_foodwebegglarval_grads <- 0.25
P_size <- 8
legend_foodwebegglarval_labels <- c("Egg + Larval (Complex)","Egg (Simple)","Larval")
legend_foodwebegglarval_title <- "Parasitoids"
point.size <- 3

# Plot directional selection gradients
plot_foodwebegglarval_directional_grads <- tidy_foodwebegglarval_grads %>%
  filter(type!="Diff", term %in% c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
 # geom_text(data=filter(tidy_foodwebegglarval_grads, type=="Diff", term %in% c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref")), 
#            aes(y=P_asterisk_foodwebegglarval_grads, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Gradient", limits=y_limits_foodwebegglarval_grads) +
  scale_x_discrete(name="", labels=parse(text=c("beta[Diam]","beta[Clutch]","beta[Pref]"))) +
  facet_wrap(~gradient_type) +
  scale_fill_manual(values=cbPalette[c(6,5,4)], labels=legend_foodwebegglarval_labels, name=legend_foodwebegglarval_title) +
  scale_color_manual(values=cbPalette[c(6,5,4)], labels=legend_foodwebegglarval_labels, name=legend_foodwebegglarval_title)

# Plot quadratic selection gradients
plot_foodwebegglarval_quadratic_grads <- tidy_foodwebegglarval_grads %>%
  filter(type!="Diff", term %in% c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
 # geom_text(data=filter(tidy_foodwebegglarval_grads, type=="Diff", term %in% c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)")), 
#            aes(y=P_asterisk_foodwebegglarval_grads, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Gradient", limits=y_limits_foodwebegglarval_grads) +
  scale_x_discrete(name="", labels=parse(text=c("gamma[Diam:Diam]","gamma[Clutch:Clutch]","gamma[Pref:Pref]"))) +
  facet_wrap(~gradient_type) +
  scale_fill_manual(values=cbPalette[c(6,5,4)], labels=legend_foodwebegglarval_labels, name=legend_foodwebegglarval_title) +
  scale_color_manual(values=cbPalette[c(6,5,4)], labels=legend_foodwebegglarval_labels, name=legend_foodwebegglarval_title)

# Plot correlational selection gradients
plot_foodwebegglarval_correlational_grads <- tidy_foodwebegglarval_grads %>%
  filter(type!="Diff", term %in% c("sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
 # geom_text(data=filter(tidy_foodwebegglarval_grads, type=="Diff", term %in% c("sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref")), 
#            aes(y=P_asterisk_foodwebegglarval_grads, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Gradient", limits=y_limits_foodwebegglarval_grads) +
  scale_x_discrete(name="", labels=parse(text=c("gamma[Diam:Clutch]","gamma[Diam:Pref]","gamma[Clutch:Pref]"))) +
  facet_wrap(~gradient_type) +
  scale_fill_manual(values=cbPalette[c(6,5,4)], labels=legend_foodwebegglarval_labels, name=legend_foodwebegglarval_title) +
  scale_color_manual(values=cbPalette[c(6,5,4)], labels=legend_foodwebegglarval_labels, name=legend_foodwebegglarval_title) 

# Alt format
legend_foodwebegglarval_grads <- get_legend(plot_foodwebegglarval_directional_grads + theme(legend.title.align = 0.5))

plot_foodwebegglarval_grads <- plot_grid(
  NULL, 
  plot_foodwebegglarval_directional_grads + theme(legend.position = "none", axis.title = element_blank()),
  plot_foodwebegglarval_quadratic_grads + theme(legend.position = "none", axis.title = element_blank()),
  plot_foodwebegglarval_correlational_grads + theme(legend.position = "none", axis.title = element_blank()), 
  nrow=2, align="hv", labels = "")
plot_legend_foodwebegglarval_grads <- ggdraw(plot_foodwebegglarval_grads) + draw_grob(legend_foodwebegglarval_grads, x = 0.1, y=0.25)
y_title_foodwebegglarval_grads <- ggdraw() + draw_label("Selection gradient (SDs)", angle = 90)

figure_foodwebegglarval_grads <- plot_grid(y_title_foodwebegglarval_grads, plot_legend_foodwebegglarval_grads, ncol=2, rel_widths = c(0.05,1)) 
figure_foodwebegglarval_grads
```

# Partitioning the components of selection gradients

Selection gradients are influenced by both trait-fitness relationships and population mean fitness. Here, we partition selection gradients into these underlying components.

```{r Plot foodwebegglarval coefficients, echo=FALSE, fig.cap="**Partitioning Selection Gradients.**", include=FALSE}
tidy_foodwebegglarval_alphas <- bind_rows(
  tidy_foodweb_alphas, mutate(filter(tidy_egglarval_alphas, type=="Complex"), type="Larval")
)
tidy_foodwebegglarval_alphas$type <- factor(tidy_foodwebegglarval_alphas$type, levels=c("Complex","Simple","Larval","Diff"))


# Plot helpers
dodge_width <- position_dodge(width=0.5)
y_limits_foodwebegglarval_coefs <- c(min(filter(tidy_foodwebegglarval_alphas, type!="Diff")$conf.low), 
                            max(filter(tidy_foodwebegglarval_alphas, type!="Diff")$conf.high))
P_asterisk_foodwebegglarval_coefs <- 1.3
P_size <- 8
legend_foodwebegglarval_labels <- c("Larval","Egg")
point.size <- 3

# Plot mean fitness
plot_foodwebegglarval_mean_fitness <- tidy_foodwebegglarval_alphas %>%
  filter(type!="Diff", term=="(Intercept)") %>%
  ggplot(., aes(x=type)) +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  scale_y_continuous(name="larval survival", limits=c(0,1), breaks=c(0,0.2,0.4,0.6,0.8,1)) +
  scale_x_discrete(name="Parasitoids", breaks=c("Complex","Simple","Larval"), labels=c("Egg + Larval","Egg","Larval")) +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(6,5,4)], labels=legend_foodwebegglarval_labels) +
  scale_color_manual(values=cbPalette[c(6,5,4)], labels=legend_foodwebegglarval_labels) 

# Plot linear trait-fitness relationaships
plot_foodwebegglarval_linear_coefs <- tidy_foodwebegglarval_alphas %>%
  filter(type!="Diff", term %in% c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  scale_y_continuous(name="Coefficient", limits=y_limits_foodwebegglarval_coefs) +
  scale_x_discrete(name="", labels=parse(text=c("alpha[Diam]","alpha[Clutch]","alpha[Pref]"))) +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(6,5,4)], labels=legend_foodwebegglarval_labels) +
  scale_color_manual(values=cbPalette[c(6,5,4)], labels=legend_foodwebegglarval_labels)

# Plot quadratic trait-fitness relationships
plot_foodwebegglarval_quadratic_coefs <- tidy_foodwebegglarval_alphas %>%
  filter(type!="Diff", term %in% c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  scale_y_continuous(name="Coefficient", limits=y_limits_foodwebegglarval_coefs) +
  scale_x_discrete(name="", labels=parse(text=c("alpha[Diam:Diam]","alpha[Clutch:Clutch]","alpha[Pref:Pref]"))) +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(6,5,4)], labels=legend_foodwebegglarval_labels) +
  scale_color_manual(values=cbPalette[c(6,5,4)], labels=legend_foodwebegglarval_labels)

# Plot correlational trait-fitness relationaships
plot_foodwebegglarval_correlational_coefs <- tidy_foodwebegglarval_alphas %>%
  filter(type!="Diff", term %in% c("sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  scale_y_continuous(name="Coefficient", limits=y_limits_foodwebegglarval_coefs) +
  scale_x_discrete(name="", labels=parse(text=c("alpha[Diam:Clutch]","alpha[Diam:Pref]","alpha[Clutch:Pref]"))) +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(6,5,4)], labels=legend_foodwebegglarval_labels) +
  scale_color_manual(values=cbPalette[c(6,5,4)], labels=legend_foodwebegglarval_labels) 

# Format plots for manuscript
plot_foodwebegglarval_coefs <- plot_grid(
  plot_foodwebegglarval_mean_fitness + theme(legend.position = "none"),
  plot_foodwebegglarval_linear_coefs + theme(legend.position = "none"),
  plot_foodwebegglarval_quadratic_coefs + theme(legend.position = "none"),
  plot_foodwebegglarval_correlational_coefs + theme(legend.position = "none"), 
  nrow=2, align="hv", labels = "")

figure_foodwebegglarval_coefs <- plot_foodwebegglarval_coefs 
figure_foodwebegglarval_coefs
```

# Estimating selection on the egg parasitoid *Platygaster*

```{r Egg vs. egg ptoid model, cache=TRUE}

# convert "gall_survival" to egg parasitoid survival. Note that both Iteomyia pupa and larva parasitoids result in 0. We do not change the name of the response variable to make clear that we are using the same statistical models as for Iteomyia.
eggegg_df <- mutate(gall_selection.df, gall_survival = ifelse(egg_parasitoid==1,1,0))

eggegg_model <- update(foodweb_model, data=eggegg_df)

biased_eggegg_df <- eggegg_df %>%
  group_by(Foodweb, Gall_Number) %>%
  mutate(mean_survival = mean(gall_survival)) %>%
  filter(mean_survival > 0, mean_survival < 1) %>%
  ungroup()

biased_eggegg_model <- update(biased_foodweb_model, data=biased_eggegg_df)
```

```{r Bootstrap egg vs. egg ptoid model, cache=TRUE, include=FALSE}
boot_eggegg_model <- bootMer(eggegg_model, FUN = fixef, nsim=n_boots_analysis, parallel="multicore", ncpus=32)
```

```{r Linear egg vs. egg ptoid model, cache=TRUE}
linear_eggegg_model <- update(linear_foodweb_model, data=eggegg_df)
```

```{r Bootstrap linear egg vs. egg model, cache=TRUE, include=FALSE}
boot_linear_eggegg_model <- bootMer(linear_eggegg_model, FUN = fixef, nsim=n_boots_analysis, parallel="multicore", ncpus=32)
```

```{r Egg vs. egg ptoid alpha coefficients, include=FALSE}
eggegg_bind <- bind_cols(
  as_tibble(boot_linear_eggegg_model$t),
  select(as_tibble(boot_eggegg_model$t), `FoodwebComplex:I(sc.Diam^2)`:`FoodwebSimple:sc.log.Clutch:sc.sqrt.Pref`) # only retain nonlinear coefficients from full model
)

# Adjust coefficients with chamber diameter
eggegg_adj_Diam <- as_tibble(boot_eggegg_model$t) %>%
  mutate(`FoodwebComplex:sc.Diam` = `FoodwebComplex:sc.Diam` - fixef(biased_eggegg_model)["FoodwebComplex:sc.Diam"],
         `FoodwebSimple:sc.Diam` = `FoodwebSimple:sc.Diam` - fixef(biased_eggegg_model)["FoodwebSimple:sc.Diam"])

# Calculate differences between food-web treatments, then estimate means and confidence intervals
eggegg_alphas <- eggegg_adj_Diam %>%
  mutate(`FoodwebSimple:(Intercept)`=inverse_logit(FoodwebSimple), `FoodwebComplex:(Intercept)`=inverse_logit(FoodwebComplex)) %>% # logit transform to make intercept interpretable as a probability
  select(-FoodwebSimple, -FoodwebComplex) %>% # translated into (Intercept) terms
  mutate(`FoodwebDiff:(Intercept)` = `FoodwebSimple:(Intercept)` - `FoodwebComplex:(Intercept)`,
         `FoodwebDiff:sc.Diam` = `FoodwebSimple:sc.Diam` - `FoodwebComplex:sc.Diam`,
         `FoodwebDiff:sc.log.Clutch` = `FoodwebSimple:sc.log.Clutch` - `FoodwebComplex:sc.log.Clutch`,
         `FoodwebDiff:sc.sqrt.Pref` = `FoodwebSimple:sc.sqrt.Pref` - `FoodwebComplex:sc.sqrt.Pref`,
         `FoodwebDiff:I(sc.Diam^2)` = `FoodwebSimple:I(sc.Diam^2)` - `FoodwebComplex:I(sc.Diam^2)`,
         `FoodwebDiff:I(sc.log.Clutch^2)` = `FoodwebSimple:I(sc.log.Clutch^2)` - `FoodwebComplex:I(sc.log.Clutch^2)`,
         `FoodwebDiff:I(sc.sqrt.Pref^2)` = `FoodwebSimple:I(sc.sqrt.Pref^2)` - `FoodwebComplex:I(sc.sqrt.Pref^2)`,
         `FoodwebDiff:sc.Diam:sc.log.Clutch` = `FoodwebSimple:sc.Diam:sc.log.Clutch` - `FoodwebComplex:sc.Diam:sc.log.Clutch`,
         `FoodwebDiff:sc.Diam:sc.sqrt.Pref` = `FoodwebSimple:sc.Diam:sc.sqrt.Pref` - `FoodwebComplex:sc.Diam:sc.sqrt.Pref`,
         `FoodwebDiff:sc.log.Clutch:sc.sqrt.Pref` = `FoodwebSimple:sc.log.Clutch:sc.sqrt.Pref` - `FoodwebComplex:sc.log.Clutch:sc.sqrt.Pref`) %>%
  summarise_all(funs(mean, conf.high, conf.low))

# Tidy up estimates
tidy_eggegg_alphas <- eggegg_alphas %>%
  t() %>%
  as.data.frame() %>%
  transmute(rows = rownames(.), value=V1) %>%
  separate(col = rows, into = c("term","estimate"), sep="_") %>%
  separate(col = term, into = c("type","term_1","term_2"), sep=":", extra="drop") %>%
  mutate(term = ifelse(is.na(term_2), term_1, paste(term_1,term_2,sep=":"))) %>%
  separate(col = type, into = c("extra","type"), sep = 7) %>%
  select(type, term, estimate, value) %>%
  spread(estimate, value) %>%
  mutate(P_cutoff = ifelse(conf.high*conf.low < 0, "","*"),
         coefficient_type = ifelse(term=="(Intercept)","Mean fitness",
                                   ifelse(grepl("\\^2", .$term)==TRUE, "Quadratic",
                                          ifelse(grepl(":", .$term)==TRUE, "Correlational","Linear"))))
```

```{r Egg vs. egg ptoid coefficients, echo=F}
knitr::kable(tidy_eggegg_alphas)
```


```{r Plot egg vs. egg ptoid coefficients, echo=FALSE}

# Plot helpers
dodge_width <- position_dodge(width=0.5)
y_limits_eggegg_coefs <- c(min(filter(tidy_eggegg_alphas, type!="Diff")$conf.low), 
                            max(filter(tidy_eggegg_alphas, type!="Diff")$conf.high))
P_asterisk_eggegg_coefs <- 1.7
P_size <- 8
legend_eggegg_labels <- c("Complex","Simple")
point.size <- 3

# Plot mean fitness
plot_eggegg_mean_fitness <- tidy_eggegg_alphas %>%
  filter(type!="Diff", term=="(Intercept)") %>%
  ggplot(., aes(x=type)) +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_eggegg_alphas, type=="Diff", term=="(Intercept)"), aes(y=0.9, x=1.5, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Probability of observing egg parasitoid", limits=c(0,1), breaks=c(0,0.2,0.4,0.6,0.8,1)) +
  scale_x_discrete(name="") +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(2,5)], labels=legend_eggegg_labels) +
  scale_color_manual(values=cbPalette[c(2,5)], labels=legend_eggegg_labels) 

# Plot linear trait-fitness relationaships
plot_eggegg_linear_coefs <- tidy_eggegg_alphas %>%
  filter(type!="Diff", term %in% c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_eggegg_alphas, type=="Diff", term %in% c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref")), 
            aes(y=P_asterisk_eggegg_coefs, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Coefficient", limits=y_limits_eggegg_coefs) +
  scale_x_discrete(name="", labels=parse(text=c("alpha[Diam]","alpha[Clutch]","alpha[Pref]"))) +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(2,5)], labels=legend_eggegg_labels) +
  scale_color_manual(values=cbPalette[c(2,5)], labels=legend_eggegg_labels)

# Plot quadratic trait-fitness relationships
plot_eggegg_quadratic_coefs <- tidy_eggegg_alphas %>%
  filter(type!="Diff", term %in% c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_eggegg_alphas, type=="Diff", term %in% c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)")), 
            aes(y=P_asterisk_eggegg_coefs, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Coefficient", limits=y_limits_eggegg_coefs) +
  scale_x_discrete(name="", labels=parse(text=c("alpha[Diam:Diam]","alpha[Clutch:Clutch]","alpha[Pref:Pref]"))) +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(2,5)], labels=legend_eggegg_labels) +
  scale_color_manual(values=cbPalette[c(2,5)], labels=legend_eggegg_labels)

# Plot correlational trait-fitness relationaships
plot_eggegg_correlational_coefs <- tidy_eggegg_alphas %>%
  filter(type!="Diff", term %in% c("sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_eggegg_alphas, type=="Diff", term %in% c("sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref")), 
            aes(y=P_asterisk_eggegg_coefs, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Coefficient", limits=y_limits_eggegg_coefs) +
  scale_x_discrete(name="", labels=parse(text=c("alpha[Diam:Clutch]","alpha[Diam:Pref]","alpha[Clutch:Pref]"))) +
  facet_wrap(~coefficient_type) +
  scale_fill_manual(values=cbPalette[c(2,5)], labels=legend_eggegg_labels) +
  scale_color_manual(values=cbPalette[c(2,5)], labels=legend_eggegg_labels) 

# Format plots for manuscript
plot_eggegg_coefs <- plot_grid(
  plot_eggegg_mean_fitness + theme(legend.position = "none"),
  plot_eggegg_linear_coefs + theme(legend.position = "none"),
  plot_eggegg_quadratic_coefs + theme(legend.position = "none"),
  plot_eggegg_correlational_coefs + theme(legend.position = "none"), 
  nrow=2, align="hv", labels = "")

figure_eggegg_coefs <- plot_eggegg_coefs 
figure_eggegg_coefs
```

```{r Egg vs. egg ptoid selection gradients, include=FALSE}

# Estimate mean fitness and mean "brackets" for each food-web treatment (see Janzen and Stern 1998 equation 4 for details about "brackets")
eggegg_complex_predict <- predict(eggegg_model, newdata=filter(eggegg_df, Foodweb=="Complex"), type="response")
eggegg_complex_mean_brackets <- mean(eggegg_complex_predict * (1 - eggegg_complex_predict))
eggegg_complex_mean_fitness <- mean(eggegg_complex_predict)

eggegg_simple_predict <- predict(eggegg_model, newdata=filter(eggegg_df, Foodweb=="Simple"), type="response")
eggegg_simple_mean_brackets <- mean(eggegg_simple_predict * (1 - eggegg_simple_predict))
eggegg_simple_mean_fitness <- mean(eggegg_simple_predict)

eggegg_complex_gradient <- function(x) eggegg_complex_mean_brackets * x / eggegg_complex_mean_fitness
eggegg_simple_gradient <- function(x) eggegg_simple_mean_brackets * x / eggegg_simple_mean_fitness

eggegg_complex_raw_gradients <- select(eggegg_adj_Diam, starts_with("FoodwebComplex:")) %>%
  transmute_all(funs(eggegg_complex_gradient))

eggegg_simple_raw_gradients <- select(eggegg_adj_Diam, starts_with("FoodwebSimple:")) %>%
  transmute_all(funs(eggegg_simple_gradient))

# Calculate differences between food-web treatments, then estimate means and confidence intervals
eggegg_grads <- bind_cols(eggegg_complex_raw_gradients, eggegg_simple_raw_gradients) %>%
  mutate(`FoodwebDiff:sc.Diam` = `FoodwebSimple:sc.Diam` - `FoodwebComplex:sc.Diam`,
         `FoodwebDiff:sc.log.Clutch` = `FoodwebSimple:sc.log.Clutch` - `FoodwebComplex:sc.log.Clutch`,
         `FoodwebDiff:sc.sqrt.Pref` = `FoodwebSimple:sc.sqrt.Pref` - `FoodwebComplex:sc.sqrt.Pref`,
         `FoodwebDiff:I(sc.Diam^2)` = `FoodwebSimple:I(sc.Diam^2)` - `FoodwebComplex:I(sc.Diam^2)`,
         `FoodwebDiff:I(sc.log.Clutch^2)` = `FoodwebSimple:I(sc.log.Clutch^2)` - `FoodwebComplex:I(sc.log.Clutch^2)`,
         `FoodwebDiff:I(sc.sqrt.Pref^2)` = `FoodwebSimple:I(sc.sqrt.Pref^2)` - `FoodwebComplex:I(sc.sqrt.Pref^2)`,
         `FoodwebDiff:sc.Diam:sc.log.Clutch` = `FoodwebSimple:sc.Diam:sc.log.Clutch` - `FoodwebComplex:sc.Diam:sc.log.Clutch`,
         `FoodwebDiff:sc.Diam:sc.sqrt.Pref` = `FoodwebSimple:sc.Diam:sc.sqrt.Pref` - `FoodwebComplex:sc.Diam:sc.sqrt.Pref`,
         `FoodwebDiff:sc.log.Clutch:sc.sqrt.Pref` = `FoodwebSimple:sc.log.Clutch:sc.sqrt.Pref` - `FoodwebComplex:sc.log.Clutch:sc.sqrt.Pref`) %>%
  summarise_all(funs(mean, conf.high, conf.low))

# Tidy up estimates
tidy_eggegg_grads <- eggegg_grads %>%
  t() %>%
  as.data.frame() %>%
  transmute(rows = rownames(.), value=V1) %>%
  separate(col = rows, into = c("term","estimate"), sep="_") %>%
  separate(col = term, into = c("type","term_1","term_2"), sep=":", extra="drop") %>%
  mutate(term = ifelse(is.na(term_2), term_1, paste(term_1,term_2,sep=":"))) %>%
  separate(col = type, into = c("extra","type"), sep = 7) %>%
  select(type, term, estimate, value) %>%
  spread(estimate, value) %>%
  mutate(P_cutoff = ifelse(conf.high*conf.low < 0, "","*"),
         gradient_type = ifelse(grepl("\\^2", .$term)==TRUE, "Quadratic",
                                ifelse(grepl(":", .$term)==TRUE, "Correlational","Directional")),
         mean = ifelse(gradient_type=="Quadratic", 2*mean, mean),
         conf.low = ifelse(gradient_type=="Quadratic", 2*conf.low, conf.low),
         conf.high = ifelse(gradient_type=="Quadratic", 2*conf.high, conf.high))
```

```{r Table of egg vs. egg ptoid gradients, echo=F}
knitr::kable(tidy_eggegg_grads)
```


```{r Plot egg vs. egg ptoid gradients, echo=FALSE}

# Plot helpers
dodge_width <- position_dodge(width=0.5)
y_limits_eggegg_grads <- c(min(filter(tidy_eggegg_grads, type!="Diff")$conf.low), 
                            max(filter(tidy_eggegg_grads, type!="Diff")$conf.high))
P_asterisk_eggegg_grads <- 0.45
P_size <- 8
legend_eggegg_labels <- c("Complex","Simple")
legend_eggegg_title <- "Food web"
point.size <- 3

# Plot directional selection gradients
plot_eggegg_directional_grads <- tidy_eggegg_grads %>%
  filter(type!="Diff", term %in% c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_eggegg_grads, type=="Diff", term %in% c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref")), 
            aes(y=P_asterisk_eggegg_grads, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Gradient", limits=y_limits_eggegg_grads) +
  scale_x_discrete(name="", labels=parse(text=c("beta[Diam]","beta[Clutch]","beta[Pref]"))) +
  facet_wrap(~gradient_type) +
  scale_fill_manual(values=cbPalette[c(2,5)], labels=legend_eggegg_labels, name=legend_eggegg_title) +
  scale_color_manual(values=cbPalette[c(2,5)], labels=legend_eggegg_labels, name=legend_eggegg_title)

# Plot quadratic selection gradients
plot_eggegg_quadratic_grads <- tidy_eggegg_grads %>%
  filter(type!="Diff", term %in% c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_eggegg_grads, type=="Diff", term %in% c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)")), 
            aes(y=P_asterisk_eggegg_grads, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Gradient", limits=y_limits_eggegg_grads) +
  scale_x_discrete(name="", labels=parse(text=c("gamma[Diam:Diam]","gamma[Clutch:Clutch]","gamma[Pref:Pref]"))) +
  facet_wrap(~gradient_type) +
  scale_fill_manual(values=cbPalette[c(2,5)], labels=legend_eggegg_labels, name=legend_eggegg_title) +
  scale_color_manual(values=cbPalette[c(2,5)], labels=legend_eggegg_labels, name=legend_eggegg_title)

# Plot correlational selection gradients
plot_eggegg_correlational_grads <- tidy_eggegg_grads %>%
  filter(type!="Diff", term %in% c("sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref")) %>%
  ggplot(., aes(x=term, color=type)) +
  geom_hline(yintercept=0, linetype="dotted") +
  geom_linerange(aes(ymax=conf.high, ymin=conf.low, color=type), position=dodge_width) +
  geom_point(aes(y=mean, fill=type), position=dodge_width, shape=21, color="black", size=point.size) +
  geom_text(data=filter(tidy_eggegg_grads, type=="Diff", term %in% c("sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref")), 
            aes(y=P_asterisk_eggegg_grads, label=P_cutoff), size=P_size, color="black") +
  scale_y_continuous(name="Gradient", limits=y_limits_eggegg_grads) +
  scale_x_discrete(name="", labels=parse(text=c("gamma[Diam:Clutch]","gamma[Diam:Pref]","gamma[Clutch:Pref]"))) +
  facet_wrap(~gradient_type) +
  scale_fill_manual(values=cbPalette[c(2,5)], labels=legend_eggegg_labels, name=legend_eggegg_title) +
  scale_color_manual(values=cbPalette[c(2,5)], labels=legend_eggegg_labels, name=legend_eggegg_title) 

# Get legend
legend_eggegg_grads <- get_legend(plot_eggegg_directional_grads)

# Format plots for manuscript
plot_eggegg_grads <- plot_grid(
  plot_eggegg_directional_grads + theme(legend.position = "none", axis.title = element_blank()),
  plot_eggegg_quadratic_grads + theme(legend.position = "none", axis.title = element_blank()),
  plot_eggegg_correlational_grads + theme(legend.position = "none", axis.title = element_blank()), 
  nrow=2, align="hv", labels = "")
plot_legend_eggegg_grads <- ggdraw(plot_eggegg_grads) + draw_grob(legend_eggegg_grads, x = 0.7, y=-0.2)
y_title_eggegg_grads <- ggdraw() + draw_label("Selection gradient (SDs)", angle = 90)

figure_eggegg_grads <- plot_grid(y_title_eggegg_grads, plot_legend_eggegg_grads, ncol=2, rel_widths = c(0.05,1)) 
figure_eggegg_grads
```

# Reproduce Figure 2 in main text of manuscript.

Use the fitted model to generate predicted estimates of mean fitness for changes in the mean trait value of a population. I restrict these predictions to +/- 1 SD because we can only reliably estimate the shape of the adaptive landscape near the mean phenotype of the population [Arnold et al., 2001](https://link.springer.com/article/10.1023/A:1013373907708). Other trait values are held constant at the mean phenotype (i.e. trait = 0).

```{r Get Gall Diameter Relative Fitness Landscape, cache=TRUE}
newdata_Diam <- bind_rows(
  expand.grid(Foodweb = "Complex", sc.Diam = seq(-1,1,length.out=1000), sc.log.Clutch = 0, sc.sqrt.Pref = 0),
  expand.grid(Foodweb = "Simple", sc.Diam = seq(-1,1,length.out=1000), sc.log.Clutch = 0, sc.sqrt.Pref = 0))

RF_Diam <- bootstrap_fitness(
  logistic_model = foodweb_model, 
  newdata = newdata_Diam,
  bootstraps=n_boots_plots)

egglarval_RF_Diam <- bootstrap_fitness(
  logistic_model = egglarval_model,
  newdata = newdata_Diam,
  bootstraps=n_boots_plots)
```

```{r Get Clutch Size Fitness Landscape, cache=TRUE}
newdata_Clutch <- bind_rows(
  expand.grid(Foodweb = "Complex", sc.Diam = 0, sc.log.Clutch = seq(-1,1,length.out=1000), sc.sqrt.Pref = 0),
  expand.grid(Foodweb = "Simple", sc.Diam = 0, sc.log.Clutch = seq(-1,1,length.out=1000), sc.sqrt.Pref = 0))

RF_Clutch <- bootstrap_fitness(
  logistic_model = foodweb_model,
  newdata = newdata_Clutch,
  bootstraps=n_boots_plots)

egglarval_RF_Clutch <- bootstrap_fitness(
  logistic_model = egglarval_model,
  newdata = newdata_Clutch,
  bootstraps=n_boots_plots)
```

```{r Get Oviposition preference Fitness Landscape, cache=TRUE}

newdata_Pref <- bind_rows(
  expand.grid(Foodweb = "Complex", sc.Diam = 0, sc.log.Clutch = 0, sc.sqrt.Pref = seq(-1,1,length.out=1000)),
  expand.grid(Foodweb = "Simple", sc.Diam = 0, sc.log.Clutch = 0, sc.sqrt.Pref = seq(-1,1,length.out=1000)))

RF_Pref <- bootstrap_fitness(
  logistic_model = foodweb_model, 
  newdata = newdata_Pref,
  bootstraps=n_boots_plots)

egglarval_RF_Pref <- bootstrap_fitness(
  logistic_model = egglarval_model, 
  newdata = newdata_Pref,
  bootstraps=n_boots_plots)

eggegg_RF_Pref <- bootstrap_fitness(
  logistic_model = eggegg_model, 
  newdata = newdata_Pref,
  bootstraps=n_boots_plots) 

linear_eggegg_RF_Pref <- bootstrap_fitness(
  logistic_model = linear_eggegg_model, 
  newdata = newdata_Pref,
  bootstraps=n_boots_plots) 
```

Create plots for each panel of Figure 2 in main text.

```{r Plot Univariate Landscapes}
uni_breaks <- c(0.1,0.5,1.0)

# Gall size 
AF_uni_Diam <- RF_Diam$absolute_fitness %>% 
  select(-sc.log.Clutch, -sc.sqrt.Pref) %>%
  gather(ID, absolute_fitness, -sc.Diam, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate")) %>% 
  ggplot(., aes(x=sc.Diam, y=absolute_fitness, group=interaction(ID,Foodweb), color=Foodweb, alpha=ID_group, size=ID_group)) +
  geom_line() +
  scale_alpha_manual(values=c(1,0.2), guide=FALSE) +
  scale_size_manual(values=c(1.5,0.25), guide=FALSE) +
  xlab("Chamber diameter (SDs)") +
  ylab("Mean larval survival") +
  scale_color_manual(values = treatment_colors, name = "Food web") +
  scale_x_continuous(breaks=c(-1,-0.5,0,0.5,1), labels = c(-1,-0.5,0,0.5,1)) +
  scale_y_log10(breaks=uni_breaks, labels=uni_breaks) + annotation_logticks(sides = "l")+
  coord_cartesian(ylim=c(0.07,1)) 

# Oviposition preference
AF_uni_Pref <- RF_Pref$absolute_fitness %>% 
  select(-sc.Diam, -sc.log.Clutch) %>%
  gather(ID, absolute_fitness, -sc.sqrt.Pref, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate")) %>% 
  ggplot(., aes(x=sc.sqrt.Pref, y=absolute_fitness, group=interaction(ID,Foodweb), color=Foodweb, alpha=ID_group, size=ID_group)) +
  geom_line() +
  scale_alpha_manual(values=c(1,0.2), guide=FALSE) +
  scale_size_manual(values=c(1.5,0.25), guide=FALSE) +
  xlab("Oviposition preference (SDs)") +
  ylab("Mean larval survival") +
  scale_color_manual(values = treatment_colors, name = "Food web") +
  scale_x_continuous(breaks=c(-1,-0.5,0,0.5,1), labels = c(-1,-0.5,0,0.5,1)) +
  scale_y_log10(breaks=uni_breaks, labels=uni_breaks) + annotation_logticks(sides = "l") +
  coord_cartesian(ylim=c(0.07,1))

AF_uni_egglarval_Pref <- egglarval_RF_Pref$absolute_fitness %>% 
  select(-sc.Diam, -sc.log.Clutch) %>%
  gather(ID, absolute_fitness, -sc.sqrt.Pref, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate")) %>% 
  ggplot(., aes(x=sc.sqrt.Pref, y=absolute_fitness, group=interaction(ID,Foodweb), color=Foodweb, alpha=ID_group, size=ID_group)) +
  geom_line() +
  scale_alpha_manual(values=c(1,0.2), guide=FALSE) +
  scale_size_manual(values=c(1.5,0.25), guide=FALSE) +
  xlab("Oviposition preference (SDs)") +
  ylab("Mean larval survival") +
  scale_color_manual(values = treatment_colors, name = "Food web") +
  scale_x_continuous(breaks=c(-1,-0.5,0,0.5,1), labels = c(-1,-0.5,0,0.5,1)) +
  scale_y_log10(breaks=uni_breaks, labels=uni_breaks) + annotation_logticks(sides = "l") +
  coord_cartesian(ylim=c(0.07,1)) 

# Clutch size -- food web
AF_uni_Clutch <- RF_Clutch$absolute_fitness %>% 
  select(-sc.Diam, -sc.sqrt.Pref) %>%
  gather(ID, absolute_fitness, -sc.log.Clutch, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate")) %>% 
  ggplot(., aes(x=sc.log.Clutch, y=absolute_fitness, group=interaction(ID,Foodweb), color=Foodweb, alpha=ID_group, size=ID_group)) +
  geom_line() +
  scale_alpha_manual(values=c(1,0.2), guide=FALSE) +
  scale_size_manual(values=c(1.5,0.25), guide=FALSE) +
  xlab("Clutch size (SDs)") +
  ylab("Mean larval survival") +
  scale_color_manual(values = treatment_colors, name = "Food web") +
  scale_x_continuous(breaks=c(-1,-0.5,0,0.5,1), labels = c(-1,-0.5,0,0.5,1)) +
  scale_y_log10(breaks=uni_breaks, labels=uni_breaks) + annotation_logticks(sides = "l") +
  coord_cartesian(ylim=c(0.07,1))

# Clutch size -- egg vs. larval ptoids
AF_uni_egglarval_Clutch <- egglarval_RF_Clutch$absolute_fitness %>% 
  select(-sc.Diam, -sc.sqrt.Pref) %>%
  gather(ID, absolute_fitness, -sc.log.Clutch, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate")) %>%
  mutate(Foodweb = factor(ifelse(Foodweb=="Complex","Larval","Simple"), levels=c("Simple","Larval"))) %>%
  ggplot(., aes(x=sc.log.Clutch, y=absolute_fitness, group=interaction(ID,Foodweb), color=Foodweb, alpha=ID_group, size=ID_group)) +
  geom_line() +
  scale_alpha_manual(values=c(1,0.2), guide=FALSE) +
  scale_size_manual(values=c(1.5,0.25), guide=FALSE) +
  xlab("Clutch size (SDs)") +
  ylab("Mean larval survival") +
  scale_color_manual(values = cbPalette[c(5,4)], name = "Food web") +
  scale_x_continuous(breaks=c(-1,-0.5,0,0.5,1), labels = c(-1,-0.5,0,0.5,1)) +
  scale_y_log10(breaks=uni_breaks, labels=uni_breaks) + annotation_logticks(sides = "l") +
  coord_cartesian(ylim=c(0.07,1)) 

plot_foodweb_Clutch_df <- RF_Clutch$absolute_fitness %>% 
  select(-sc.Diam, -sc.sqrt.Pref) %>%
  gather(ID, absolute_fitness, -sc.log.Clutch, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate"), facet="a") 

plot_egglarval_Clutch_df <- egglarval_RF_Clutch$absolute_fitness %>% 
  select(-sc.Diam, -sc.sqrt.Pref) %>%
  gather(ID, absolute_fitness, -sc.log.Clutch, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate")) %>%
  mutate(Foodweb = ifelse(Foodweb=="Complex","Larval","Simple")) %>%
  filter(ID_group=="average") %>%
  bind_rows(., filter(plot_foodweb_Clutch_df, ID_group=="average", Foodweb=="Complex")) %>%
  mutate(facet = "b")

legend_only <- bind_rows(plot_foodweb_Clutch_df, plot_egglarval_Clutch_df) %>%
  mutate(Foodweb=factor(Foodweb, levels=c("Complex","Simple","Larval"), labels=c("Egg + Larval (Complex)  ","Egg (Simple)  ","Larval"))) %>%
  ggplot(., aes(x=sc.log.Clutch, y=absolute_fitness, group=interaction(ID,Foodweb), color=Foodweb, alpha=ID_group, size=ID_group)) +
  geom_line() +
  scale_alpha_manual(values=c(1,0.2), guide=FALSE) +
  scale_size_manual(values=c(1.5,0.25), guide=FALSE) +
  xlab("Clutch size (SDs)") +
  ylab("Mean larval survival") +
  scale_color_manual(values = cbPalette[c(6,5,4)], name = "Parasitoids") +
  scale_x_continuous(breaks=c(-1,-0.5,0,0.5,1), labels = c(-1,-0.5,0,0.5,1)) +
  scale_y_log10(breaks=uni_breaks, labels=uni_breaks) + annotation_logticks(sides = "l") +
  coord_cartesian(ylim=c(0.07,1))+
  facet_wrap(~facet) +
  theme(strip.background=element_blank(), strip.text = element_blank()) +
  guides(color=guide_legend(title.position="top"))

## Female pref
plot_foodweb_Pref_df <- RF_Pref$absolute_fitness %>%
  select(-sc.Diam, -sc.log.Clutch) %>%
  gather(ID, absolute_fitness, -sc.sqrt.Pref, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate"), facet="a") 

plot_egglarval_Pref_df <- egglarval_RF_Pref$absolute_fitness %>% 
  select(-sc.Diam, -sc.log.Clutch) %>%
  gather(ID, absolute_fitness, -sc.sqrt.Pref, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate")) %>%
  mutate(Foodweb = ifelse(Foodweb=="Complex","Larval","Simple")) %>%
  filter(ID_group=="average")  %>%
  bind_rows(., filter(plot_foodweb_Pref_df, ID_group=="average", Foodweb=="Complex")) %>%
  mutate(facet = "b")

pref_legend_only <- bind_rows(plot_foodweb_Pref_df, plot_egglarval_Pref_df) %>%
  mutate(Foodweb=factor(Foodweb, levels=c("Complex","Simple","Larval"), labels=c("Egg + Larval (Complex)","Egg (Simple)","Larval"))) %>%
  ggplot(., aes(x=sc.sqrt.Pref, y=absolute_fitness, group=interaction(ID,Foodweb), color=Foodweb, alpha=ID_group, size=ID_group)) +
  geom_line() +
  scale_alpha_manual(values=c(1,0.2), guide=FALSE) +
  scale_size_manual(values=c(1.5,0.25), guide=FALSE) +
  xlab("Oviposition preference (SDs)") +
  ylab("Mean larval survival") +
  scale_color_manual(values = cbPalette[c(6,5,4)], name = "Parasitoids") + 
  scale_x_continuous(breaks=c(-1,-0.5,0,0.5,1), labels = c(-1,-0.5,0,0.5,1)) +
  scale_y_log10(breaks=uni_breaks, labels=uni_breaks) + annotation_logticks(sides = "l") +
  coord_cartesian(ylim=c(0.07,1)) +
  theme(legend.title.align = 0.5) +
  facet_wrap(~facet) +
  theme(strip.background=element_blank(), strip.text = element_blank())

# Chamber diameter
plot_foodweb_Diam_df <- RF_Diam$absolute_fitness %>% 
  select(-sc.sqrt.Pref, -sc.log.Clutch) %>%
  gather(ID, absolute_fitness, -sc.Diam, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate"), facet="a")

plot_egglarval_Diam_df <- egglarval_RF_Diam$absolute_fitness %>% 
  select(-sc.sqrt.Pref, -sc.log.Clutch) %>%
  gather(ID, absolute_fitness, -sc.Diam, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate")) %>%
  mutate(Foodweb = ifelse(Foodweb=="Complex","Larval","Simple")) %>%
  filter(ID_group=="average") %>%
  bind_rows(., filter(plot_foodweb_Diam_df, ID_group=="average", Foodweb=="Complex")) %>%
  mutate(facet = "b")

Diam_legend_only <- bind_rows(plot_foodweb_Diam_df, plot_egglarval_Diam_df) %>%
  mutate(Foodweb=factor(Foodweb, levels=c("Complex","Simple","Larval"), labels=c("Egg + Larval (Complex)","Egg (Simple)","Larval"))) %>%
  ggplot(., aes(x=sc.Diam, y=absolute_fitness, group=interaction(ID,Foodweb), color=Foodweb, alpha=ID_group, size=ID_group)) +
  geom_line() +
  scale_alpha_manual(values=c(1,0.2), guide=FALSE) +
  scale_size_manual(values=c(1.5,0.25), guide=FALSE) +
  xlab("Chamber diameter (SDs)") +
  ylab("Mean larval survival") +
  scale_color_manual(values = cbPalette[c(6,5,4)], name = "Parasitoids") + 
  scale_x_continuous(breaks=c(-1,-0.5,0,0.5,1), labels = c(-1,-0.5,0,0.5,1)) +
  scale_y_log10(breaks=uni_breaks, labels=uni_breaks) + annotation_logticks(sides = "l") +
  coord_cartesian(ylim=c(0.07,1)) +
  theme(legend.title.align = 0.5) +
  facet_wrap(~facet) +
  theme(strip.background=element_blank(), strip.text = element_blank())
```

Fit plots together to reproduce Figure 2.

```{r Univariate-Fitness-Landscapes, echo=FALSE, fig.cap="Selection gradients acting on gall traits in complex vs. simple food webs. Each panel corresponds to a different gall trait: gall diameter (A); clutch size (B); and Oviposition preference (C). Solid lines represent the estimated gradients in complex (orange) and simple (blue) food webs. Transparent lines represent bootstrapped replicates (n=100) to show the uncertainty in estimated gradients. Note that only 100 bootstraps are displayed here, but that inferences are based on 1,000 bootstrapped samples."}

# Get legend
AF_uni_legend <- get_legend(AF_uni_Diam + theme(legend.title.align = 0.5)) 

# Make plots
AF_uni_plots <- plot_grid(AF_uni_Diam + theme(legend.position = "none"), 
                       AF_uni_Pref + theme(legend.position = "none", 
                                           axis.title.y = element_blank()) + xlab("Preference (SDs)"),
                      AF_uni_Clutch + theme(legend.position = "none",
                                             axis.title.y = element_blank()), 
                       labels = "AUTO", nrow = 1, align='hv')

AF_gradients <- plot_grid(AF_uni_plots, AF_uni_legend, ncol = 2, rel_widths = c(0.8,0.2)) 
AF_gradients
save_plot(filename = "UV_landscapes.pdf", plot = AF_gradients, base_height = 5, base_width = 8.5)
```


# Replot univariate adaptive landscapes in terms of relative fitness

```{r Plot Univariate RF Landscapes}

RF_plot_foodweb_Clutch_df <- RF_Clutch$absolute_fitness %>% 
  select(-sc.Diam, -sc.sqrt.Pref) %>%
  gather(ID, absolute_fitness, -sc.log.Clutch, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate")) %>%
  filter(ID_group == "average") %>%
  group_by(Foodweb) %>%
  mutate(relative_fitness = absolute_fitness/mean(absolute_fitness)) %>%
  ungroup()

RF_plot_egglarval_Clutch_df <- egglarval_RF_Clutch$absolute_fitness %>% 
  select(-sc.Diam, -sc.sqrt.Pref) %>%
  gather(ID, absolute_fitness, -sc.log.Clutch, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate")) %>%
  mutate(Foodweb = ifelse(Foodweb=="Complex","Larval","Simple")) %>%
  filter(Foodweb=="Larval", ID_group=="average") %>%
  group_by(Foodweb) %>%
  mutate(relative_fitness = absolute_fitness/mean(absolute_fitness))%>%
  ungroup()

RF_legend_only <- bind_rows(RF_plot_foodweb_Clutch_df, RF_plot_egglarval_Clutch_df) %>%
  mutate(Foodweb=factor(Foodweb, levels=c("Complex","Simple","Larval"), labels=c("Egg + Larval (Complex)","Egg (Simple)","Larval"))) %>%
  filter(ID_group=="average") %>%
  ggplot(., aes(x=sc.log.Clutch, y=relative_fitness, group=interaction(ID,Foodweb), color=Foodweb, alpha=ID_group, size=ID_group)) +
  geom_line() +
  scale_alpha_manual(values=c(1,0.2), guide=FALSE) +
  scale_size_manual(values=c(1.5,0.25), guide=FALSE) +
  xlab("Clutch size (SDs)") +
  ylab("Relative fitness") +
  scale_color_manual(values = cbPalette[c(6,5,4)], name = "Parasitoids") + 
  scale_x_continuous(breaks=c(-1,-0.5,0,0.5,1), labels = c(-1,-0.5,0,0.5,1)) +
  coord_cartesian(ylim=c(0.2,2)) +
  geom_hline(yintercept=1, linetype="dotted")

## Female pref

RF_plot_foodweb_Pref_df <- RF_Pref$absolute_fitness %>% 
  select(-sc.Diam, -sc.log.Clutch) %>%
  gather(ID, absolute_fitness, -sc.sqrt.Pref, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate")) %>%
  filter(ID_group == "average") %>%
  group_by(Foodweb) %>%
  mutate(relative_fitness = absolute_fitness/mean(absolute_fitness))%>%
  ungroup()

RF_plot_egglarval_Pref_df <- egglarval_RF_Pref$absolute_fitness %>%
  select(-sc.Diam, -sc.log.Clutch) %>%
  gather(ID, absolute_fitness, -sc.sqrt.Pref, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate")) %>%
  mutate(Foodweb = ifelse(Foodweb=="Complex","Larval","Simple")) %>%
  filter(Foodweb=="Larval", ID_group=="average") %>%
  group_by(Foodweb) %>%
  mutate(relative_fitness = absolute_fitness/mean(absolute_fitness))%>%
  ungroup()

RF_pref_legend_only <- bind_rows(RF_plot_foodweb_Pref_df, RF_plot_egglarval_Pref_df) %>%
  mutate(Foodweb=factor(Foodweb, levels=c("Complex","Simple","Larval"), labels=c("Egg + Larval (Complex)","Egg (Simple)","Larval"))) %>%
  filter(ID_group=="average") %>%
  ggplot(., aes(x=sc.sqrt.Pref, y=relative_fitness, group=interaction(ID,Foodweb), color=Foodweb, alpha=ID_group, size=ID_group)) +
  geom_line() +
  scale_alpha_manual(values=c(1,0.2), guide=FALSE) +
  scale_size_manual(values=c(1.5,0.25), guide=FALSE) +
  xlab("Oviposition preference (SDs)") +
  ylab("Relative fitness") +
  scale_color_manual(values = cbPalette[c(6,5,4)], name = "Parasitoids") + 
  scale_x_continuous(breaks=c(-1,-0.5,0,0.5,1), labels = c(-1,-0.5,0,0.5,1)) +
  coord_cartesian(ylim=c(0.2,2)) +
  theme(legend.title.align = 0.5) +
  geom_hline(yintercept=1, linetype="dotted")

# Chamber diameter
RF_plot_foodweb_Diam_df <- RF_Diam$absolute_fitness %>% 
  select(-sc.sqrt.Pref, -sc.log.Clutch) %>%
  gather(ID, absolute_fitness, -sc.Diam, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate")) %>%
  filter(ID_group == "average") %>%
  group_by(Foodweb) %>%
  mutate(relative_fitness = absolute_fitness/mean(absolute_fitness))%>%
  ungroup()

RF_plot_egglarval_Diam_df <- egglarval_RF_Diam$absolute_fitness %>% 
  select(-sc.sqrt.Pref, -sc.log.Clutch) %>%
  gather(ID, absolute_fitness, -sc.Diam, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate")) %>%
  mutate(Foodweb = ifelse(Foodweb=="Complex","Larval","Simple")) %>%
  filter(Foodweb=="Larval", ID_group=="average") %>%
  group_by(Foodweb) %>%
  mutate(relative_fitness = absolute_fitness/mean(absolute_fitness))%>%
  ungroup()

RF_Diam_legend_only <- bind_rows(RF_plot_foodweb_Diam_df, RF_plot_egglarval_Diam_df) %>%
  mutate(Foodweb=factor(Foodweb, levels=c("Complex","Simple","Larval"), labels=c("Egg + Larval (Complex)","Egg (Simple)","Larval"))) %>%
  filter(ID_group=="average") %>%
  ggplot(., aes(x=sc.Diam, y=relative_fitness, group=interaction(ID,Foodweb), color=Foodweb, alpha=ID_group, size=ID_group)) +
  geom_line() +
  scale_alpha_manual(values=c(1,0.2), guide=FALSE) +
  scale_size_manual(values=c(1.5,0.25), guide=FALSE) +
  xlab("Chamber diameter (SDs)") +
  ylab("Relative fitness") +
  scale_color_manual(values = cbPalette[c(6,5,4)], name = "Parasitoids") + 
  scale_x_continuous(breaks=c(-1,-0.5,0,0.5,1), labels = c(-1,-0.5,0,0.5,1)) +
  coord_cartesian(ylim=c(0.2,2)) +
  theme(legend.title.align = 0.5) +
  geom_hline(yintercept=1, linetype="dotted")

# Get legend
RF_uni_legend <- get_legend(RF_legend_only)  

# Make plots
RF_uni_plots <- plot_grid(RF_Diam_legend_only + theme(legend.position = "none", 
                                             axis.text.x = element_text(size=10),
                                             axis.title.x = element_text(size=11)),
                     RF_pref_legend_only + theme(legend.position = "none",                          
                                             axis.title.y = element_blank(), 
                                             axis.text.x = element_text(size=10),
                                             axis.title.x = element_text(size=11)),
                     RF_legend_only + theme(legend.position = "none",                          
                                             axis.title.y = element_blank(), 
                                             axis.text.x = element_text(size=10),
                                             axis.title.x = element_text(size=11)),
                     ncol = 3, align='hv')

RF_gradients <- plot_grid(RF_uni_plots, RF_uni_legend, ncol = 2, rel_widths = c(0.8,0.2)) 
RF_gradients
```

# Reproduce Figure 3 presented in main text.

Use the fitted model to generate predicted estimates of mean fitness for different phenotypic combinations. I restrict these predictions to +/- 1 SD because we can only reliably estimate the shape of the adaptive landscape near the mean phenotype of the population [Arnold et al., 2001](https://link.springer.com/article/10.1023/A:1013373907708).

```{r Get Clutch Size x Oviposition preference Landscape, cache=TRUE}

newdata_Clutch.Pref <- bind_rows(
  expand.grid(Foodweb = "Complex", sc.Diam = 0, sc.log.Clutch = seq(-1,1,length.out=1000), sc.sqrt.Pref = seq(-1,1,length.out=1000)),
  expand.grid(Foodweb = "Simple", sc.Diam = 0, sc.log.Clutch = seq(-1,1,length.out=1000), sc.sqrt.Pref = seq(-1,1,length.out=1000)))

RF_Clutch.Pref <- bootstrap_fitness(
  logistic_model = foodweb_model, 
  newdata = newdata_Clutch.Pref,
  bootstraps=NULL)

```

```{r Get Gall Diameter x Clutch Size Landscape, cache=TRUE}

newdata_Diam.Clutch <- bind_rows(
  expand.grid(Foodweb = "Complex", sc.Diam = seq(-1,1,length.out=1000), sc.log.Clutch = seq(-1,1,length.out=1000), sc.sqrt.Pref = 0),
  expand.grid(Foodweb = "Simple", sc.Diam = seq(-1,1,length.out=1000), sc.log.Clutch = seq(-1,1,length.out=1000), sc.sqrt.Pref=0))

RF_Diam.Clutch <- bootstrap_fitness(
  logistic_model = foodweb_model, 
  newdata = newdata_Diam.Clutch,
  bootstraps=NULL)

```

```{r Get Gall Diameter x Oviposition preference Landscape, cache=TRUE}

newdata_Diam.Pref <- bind_rows(
  expand.grid(Foodweb = "Complex", sc.Diam = seq(-1,1,length.out=1000), sc.log.Clutch = 0, sc.sqrt.Pref = seq(-1,1,length.out=1000)),
  expand.grid(Foodweb = "Simple", sc.Diam = seq(-1,1,length.out=1000), sc.log.Clutch = 0, sc.sqrt.Pref = seq(-1,1,length.out=1000)))

RF_Diam.Pref <- bootstrap_fitness(
  logistic_model = foodweb_model, 
  newdata = newdata_Diam.Pref,
  bootstraps=NULL)

```

Create plots for each panel.

```{r Get plots of multivariate adaptive landscape}

# Plot helpers
AF_range <- bind_rows(RF_Clutch.Pref$absolute_fitness, RF_Diam.Clutch$absolute_fitness, RF_Diam.Pref$absolute_fitness) %>%
  summarise(min = min(average), max = max(average))

my_breaks <- c(0.2,0.4,0.6,0.8)

# Set contour breaks
breaks <- predict(foodweb_model, newdata=data.frame(sc.Diam = c(0,0), sc.log.Clutch = c(0,0), sc.sqrt.Pref = c(0,0), Foodweb = c("Complex","Simple")), type="response", re.form=~0)
names(breaks) <- c("Complex","Simple")

# Size x Clutch
AF_plot_Diam.Clutch <- RF_Diam.Clutch$absolute_fitness %>% 
  filter(Foodweb == "Complex") %>%
  ggplot(., aes(x=sc.Diam, y=sc.log.Clutch)) +
  geom_raster(aes(fill=average)) +
  stat_contour(aes(z = average), breaks = breaks["Complex"], linetype = "dotted", color = "black") +
  geom_raster(data = filter(RF_Diam.Clutch$absolute_fitness, Foodweb == "Simple"), aes(fill=average)) +
  stat_contour(data = filter(RF_Diam.Clutch$absolute_fitness, Foodweb == "Simple"), aes(z = average), breaks = breaks["Simple"], linetype = "dotted", color = "black") +
  facet_wrap(~Foodweb) +
  xlab("Gall diameter (SDs)") +
  ylab("Clutch size (SDs)") +
  scale_x_continuous(labels = c(-1,-0.5,0,0.5,1)) +
  scale_y_continuous(labels = c(-1,-0.5,0,0.5,1)) +
  scale_fill_viridis(name = "Mean larval\nsurvival", trans="log", breaks = my_breaks, labels = my_breaks, limits = c(AF_range$min, AF_range$max)) +
  theme(strip.background = element_blank(),
        strip.text.x=element_text(margin=margin(b=4))) 

# Size x Preference
AF_plot_Diam.Pref <- RF_Diam.Pref$absolute_fitness %>% 
  filter(Foodweb == "Complex") %>%
  ggplot(., aes(x=sc.Diam, y=sc.sqrt.Pref)) +
  geom_raster(aes(fill=average)) +
  stat_contour(aes(z = average), breaks = breaks["Complex"], linetype = "dotted", color = "black") +
  geom_raster(data = filter(RF_Diam.Pref$absolute_fitness, Foodweb == "Simple"), aes(fill=average)) +
  stat_contour(data = filter(RF_Diam.Pref$absolute_fitness, Foodweb == "Simple"), aes(z = average), breaks = breaks["Simple"], linetype = "dotted", color = "black") +
  facet_wrap(~Foodweb) +
  xlab("Chamber diameter (SDs)") +
  ylab("Oviposition preference (SDs)") +
  scale_x_continuous(labels = c(-1,-0.5,0,0.5,1)) +
  scale_y_continuous(labels = c(-1,-0.5,0,0.5,1)) +
  scale_fill_viridis(name = "Mean larval\nsurvival", trans="log", breaks = my_breaks, labels = my_breaks, limits = c(AF_range$min, AF_range$max)) +
  theme(strip.background = element_blank(),
        strip.text.x=element_text(margin=margin(b=4))) 

# Clutch x Preference
AF_plot_Clutch.Pref <- RF_Clutch.Pref$absolute_fitness %>%
  filter(Foodweb == "Complex") %>%
  ggplot(., aes(x=sc.sqrt.Pref, y=sc.log.Clutch)) +
  geom_raster(aes(fill=average)) +
  stat_contour(aes(z = average), breaks = breaks["Complex"], linetype = "dotted", color = "black") +
  geom_raster(data = filter(RF_Clutch.Pref$absolute_fitness, Foodweb == "Simple"), aes(fill=average)) +
  stat_contour(data = filter(RF_Clutch.Pref$absolute_fitness, Foodweb == "Simple"), aes(z = average), breaks = breaks["Simple"], linetype = "dotted", color = "black") +
  facet_wrap(~Foodweb) +
  xlab("Oviposition preference (SDs)") +
  ylab("Clutch size (SDs)") +
  scale_x_continuous(labels = c(-1,-0.5,0,0.5,1)) +
  scale_y_continuous(labels = c(-1,-0.5,0,0.5,1)) +
  scale_fill_viridis(name = "Mean larval\nsurvival", trans="log", breaks = my_breaks, labels = my_breaks, limits = c(AF_range$min, AF_range$max)) +
  theme(strip.background = element_blank(),
        strip.text.x=element_text(margin=margin(b=4)))

```

Fit plots together to reproduce Figure 3.

```{r Figure-Multivariate-Landscapes}

# Get legend
AF_landscape_legend <- get_legend(AF_plot_Diam.Pref + theme(legend.text = element_text(size=10)))

# Arrow data
gradients_Diam.Clutch <- data.frame(Foodweb = c("Complex","Simple"),
                                    sc.Diam = c(0,0), 
                                    sc.log.Clutch = c(0,0), 
                                    xend = c(filter(tidy_foodweb_grads, type=="Complex", term=="sc.Diam")$mean,
                                             filter(tidy_foodweb_grads, type=="Simple", term=="sc.Diam")$mean), 
                                    yend = c(filter(tidy_foodweb_grads, type=="Complex", term=="sc.log.Clutch")$mean, 
                                             filter(tidy_foodweb_grads, type=="Simple", term=="sc.log.Clutch")$mean))

gradients_Clutch.Pref <- data.frame(Foodweb = c("Complex","Simple"),
                                    sc.sqrt.Pref = c(0,0), 
                                    sc.log.Clutch = c(0,0), 
                                    xend = c(filter(tidy_foodweb_grads, type=="Complex", term=="sc.sqrt.Pref")$mean, 
                                             filter(tidy_foodweb_grads, type=="Simple", term=="sc.sqrt.Pref")$mean), 
                                    yend = c(filter(tidy_foodweb_grads, type=="Complex", term=="sc.log.Clutch")$mean, 
                                             filter(tidy_foodweb_grads, type=="Simple", term=="sc.log.Clutch")$mean))

gradients_Diam.Pref <- data.frame(Foodweb = c("Complex","Simple"),
                                    sc.Diam = c(0,0), 
                                    sc.sqrt.Pref = c(0,0), 
                                    xend = c(filter(tidy_foodweb_grads, type=="Complex", term=="sc.Diam")$mean,
                                             filter(tidy_foodweb_grads, type=="Simple", term=="sc.Diam")$mean), 
                                    yend = c(filter(tidy_foodweb_grads, type=="Complex", term=="sc.sqrt.Pref")$mean, 
                                             filter(tidy_foodweb_grads, type=="Simple", term=="sc.sqrt.Pref")$mean))
                                    

# Format plots
AF_landscape_plots <- plot_grid(
  AF_plot_Diam.Clutch + theme(legend.position = "none", 
                              axis.title.x = element_blank(),
                             axis.text.x = element_blank()) +
    geom_segment(data = gradients_Diam.Clutch, 
                 aes(x = sc.Diam, y = sc.log.Clutch, xend = xend, yend = yend), 
                 arrow = arrow(length = unit(0.03, "npc"))),
  AF_plot_Clutch.Pref + theme(legend.position = "none", 
                              axis.title.y = element_blank(),
                              axis.text.y = element_blank()) + xlab("Preference (SDs)") +
    geom_segment(data = gradients_Clutch.Pref, 
                 aes(x = sc.sqrt.Pref, y = sc.log.Clutch, xend = xend, yend = yend), 
                 arrow = arrow(length = unit(0.03, "npc"))), 
  AF_plot_Diam.Pref + theme(legend.position = "none") + ylab("Preference (SDs)") +
    geom_segment(data = gradients_Diam.Pref, 
                 aes(x = sc.Diam, y = sc.sqrt.Pref, xend = xend, yend = yend), 
                 arrow = arrow(length = unit(0.03, "npc"))), 
  nrow=2, align="hv", labels = "AUTO")

AF_landscape_2d <- ggdraw(AF_landscape_plots) + draw_grob(AF_landscape_legend, x = 0.7, y=-0.2)
AF_landscape_2d
save_plot(filename = "MV_landscapes.pdf", plot = AF_landscape_2d, base_width=8, base_height = 6)
```

# Calculating Slope and Curvature of the Adaptive Landscape

Below is the code I used to get estimates for the slope and curvature of the adaptive landscape in each food-web treatment. If 95% confidence intervals of selection gradients overlap zero, then they are set to zero; otherwise, I retain the mean estimate. 

```{r Slope and Curvature of the Adaptive Landscape}

## Create beta-matrix for complex food-web treatment
complex_betas_df <- tidy_foodweb_grads %>%
  filter(type=="Complex", gradient_type=="Directional") %>%
  select(term, gradient=mean, low=conf.low, high=conf.high)
complex_betas_df$term <- factor(complex_betas_df$term, levels=c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref"), labels=c("Diam","Clutch","Pref"), order=TRUE)
rownames(complex_betas_df) <- complex_betas_df$term

complex_betas <- matrix(nrow = 3, ncol = 1, dimnames = list(c("Diam","Clutch","Pref"), c("")))
complex_betas["Diam",] <- ifelse(complex_betas_df["Diam","low"]*complex_betas_df["Diam","high"] > 0, 
                                        complex_betas_df["Diam","gradient"], 0)
complex_betas["Clutch",] <- ifelse(complex_betas_df["Clutch","low"]*complex_betas_df["Clutch","high"] > 0,
                                            complex_betas_df["Clutch","gradient"], 0)
complex_betas["Pref",] <- ifelse(complex_betas_df["Pref","low"]*complex_betas_df["Pref","high"] > 0,
                                        complex_betas_df["Pref","gradient"], 0)
complex_betas <- round(complex_betas, 2)

## Create gamma-matrix for complex food-web treatment
complex_gammas_df <- tidy_foodweb_grads %>%
  filter(type=="Complex", gradient_type %in% c("Quadratic","Correlational")) %>%
  select(term, gradient=mean, low=conf.low, high=conf.high)
complex_gammas_df$term <- factor(complex_gammas_df$term, levels=c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)","sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref"), labels=c("Diam^2","Clutch^2","Pref^2","Diam:Clutch","Diam:Pref","Clutch:Pref"), order=TRUE)
rownames(complex_gammas_df) <- complex_gammas_df$term
  
complex_gammas <- matrix(nrow = 3, ncol = 3, dimnames = list(c("Diam","Clutch","Pref"), c("Diam","Clutch","Pref")))
complex_gammas["Diam","Diam"] <- ifelse(complex_gammas_df["Diam^2","low"]*complex_gammas_df["Diam^2","high"] > 0, 
                                        complex_gammas_df["Diam^2","gradient"], 0)
complex_gammas["Clutch","Clutch"] <- ifelse(complex_gammas_df["Clutch^2","low"]*complex_gammas_df["Clutch^2","high"] > 0,
                                            complex_gammas_df["Clutch^2","gradient"], 0)
complex_gammas["Pref","Pref"] <- ifelse(complex_gammas_df["Pref^2","low"]*complex_gammas_df["Pref^2","high"] > 0,
                                        complex_gammas_df["Pref^2","gradient"], 0)
complex_gammas["Diam","Clutch"] <- ifelse(complex_gammas_df["Diam:Clutch","low"]*complex_gammas_df["Diam:Clutch","high"] > 0,
                                          complex_gammas_df["Diam:Clutch","gradient"], 0)
complex_gammas["Clutch","Diam"] <- complex_gammas["Diam","Clutch"]
complex_gammas["Diam","Pref"] <- ifelse(complex_gammas_df["Diam:Pref","low"]*complex_gammas_df["Diam:Pref","high"] > 0,
                                            complex_gammas_df["Diam:Pref","gradient"], 0)
complex_gammas["Pref","Diam"] <- complex_gammas["Diam","Pref"]
complex_gammas["Clutch","Pref"] <- ifelse(complex_gammas_df["Clutch:Pref","low"]*complex_gammas_df["Clutch:Pref","high"] > 0, 
                                        complex_gammas_df["Clutch:Pref","gradient"], 0)
complex_gammas["Pref","Clutch"] <- complex_gammas["Clutch","Pref"]
complex_gammas <- round(complex_gammas, 2)

## Create matrix of Betas in simple food-web treatment
simple_betas_df <- tidy_foodweb_grads %>%
  filter(type=="Simple", gradient_type=="Directional") %>%
  select(term, gradient=mean, low=conf.low, high=conf.high)
simple_betas_df$term <- factor(simple_betas_df$term, levels=c("sc.Diam","sc.log.Clutch","sc.sqrt.Pref"), labels=c("Diam","Clutch","Pref"), order=TRUE)
rownames(simple_betas_df) <- simple_betas_df$term

simple_betas <- matrix(nrow = 3, ncol = 1, dimnames = list(c("Diam","Clutch","Pref"), c("")))
simple_betas["Diam",] <- ifelse(simple_betas_df["Diam","low"]*simple_betas_df["Diam","high"] > 0, 
                                        simple_betas_df["Diam","gradient"], 0)
simple_betas["Clutch",] <- ifelse(simple_betas_df["Clutch","low"]*simple_betas_df["Clutch","high"] > 0,
                                            simple_betas_df["Clutch","gradient"], 0)
simple_betas["Pref",] <- ifelse(simple_betas_df["Pref","low"]*simple_betas_df["Pref","high"] > 0,
                                        simple_betas_df["Pref","gradient"], 0)
simple_betas <- round(simple_betas, 2)

## Create gamma-matrix for simple food-web treatment
simple_gammas_df <- tidy_foodweb_grads %>%
  filter(type=="Simple", gradient_type %in% c("Quadratic","Correlational")) %>%
  select(term, gradient=mean, low=conf.low, high=conf.high)
simple_gammas_df$term <- factor(simple_gammas_df$term, levels=c("I(sc.Diam^2)","I(sc.log.Clutch^2)","I(sc.sqrt.Pref^2)","sc.Diam:sc.log.Clutch","sc.Diam:sc.sqrt.Pref","sc.log.Clutch:sc.sqrt.Pref"), labels=c("Diam^2","Clutch^2","Pref^2","Diam:Clutch","Diam:Pref","Clutch:Pref"), order=TRUE)
rownames(simple_gammas_df) <- simple_gammas_df$term

simple_gammas <- matrix(nrow = 3, ncol = 3, dimnames = list(c("Diam","Clutch","Pref"), c("Diam","Clutch","Pref")))
simple_gammas["Diam","Diam"] <- ifelse(simple_gammas_df["Diam^2","low"]*simple_gammas_df["Diam^2","high"] > 0, 
                                        simple_gammas_df["Diam^2","gradient"], 0)
simple_gammas["Clutch","Clutch"] <- ifelse(simple_gammas_df["Clutch^2","low"]*simple_gammas_df["Clutch^2","high"] > 0,
                                            simple_gammas_df["Clutch^2","gradient"], 0)
simple_gammas["Pref","Pref"] <- ifelse(simple_gammas_df["Pref^2","low"]*simple_gammas_df["Pref^2","high"] > 0,
                                        simple_gammas_df["Pref^2","gradient"], 0)
simple_gammas["Diam","Clutch"] <- ifelse(simple_gammas_df["Diam:Clutch","low"]*simple_gammas_df["Diam:Clutch","high"] > 0,
                                          simple_gammas_df["Diam:Clutch","gradient"], 0)
simple_gammas["Clutch","Diam"] <- simple_gammas["Diam","Clutch"]
simple_gammas["Diam","Pref"] <- ifelse(simple_gammas_df["Diam:Pref","low"]*simple_gammas_df["Diam:Pref","high"] > 0,
                                            simple_gammas_df["Diam:Pref","gradient"], 0)
simple_gammas["Pref","Diam"] <- simple_gammas["Diam","Pref"]
simple_gammas["Clutch","Pref"] <- ifelse(simple_gammas_df["Clutch:Pref","low"]*simple_gammas_df["Clutch:Pref","high"] > 0, 
                                        simple_gammas_df["Clutch:Pref","gradient"], 0)
simple_gammas["Pref","Clutch"] <- simple_gammas["Clutch","Pref"]
simple_gammas <- round(simple_gammas, 2)

## Calculate Curvature of the Fitness landscape
complex_curvature <- complex_gammas - complex_betas %*% t(complex_betas)
simple_curvature <- simple_gammas - simple_betas %*% t(simple_betas)
```

I use these estimates to populate the curvature matrices presented in the **Results** of the main text. I reproduce these estimates here for clarity:

$$\textbf{C} = \begin{pmatrix} C_{\text{Diam:Diam}}&& \\ C_{\text{Clutch:Diam}} & C_{\text{Clutch:Clutch}} & \\ C_{\text{Pref:Diam}} & C_{\text{Pref:Clutch}} & C_{\text{Pref:Pref}} \end{pmatrix}$$

$$\textbf{C}_{\text{Complex}} = \begin{pmatrix} 
`r round(complex_curvature["Diam","Diam"],2)` &  &  \\  
`r round(complex_curvature["Clutch","Diam"],2)` & `r round(complex_curvature["Clutch","Clutch"],2)` &  \\  
`r round(complex_curvature["Pref","Diam"],2)` & `r round(complex_curvature["Pref","Clutch"],2)` & `r round(complex_curvature["Pref","Pref"],2)` \end{pmatrix}$$

$$\textbf{C}_{\text{Simple}} = \begin{pmatrix} 
`r round(simple_curvature["Diam","Diam"],2)` &  &  \\  
`r round(simple_curvature["Clutch","Diam"],2)` & `r round(simple_curvature["Clutch","Clutch"],2)` &  \\  
`r round(simple_curvature["Pref","Diam"],2)` & `r round(simple_curvature["Pref","Clutch"],2)` & `r round(simple_curvature["Pref","Pref"],2)` \end{pmatrix}$$

# Reproduce Figure 4 in main text

```{r Egg-Parasitoid-Selection}
eggptoid_plot_df <- eggegg_RF_Pref$absolute_fitness %>% 
  select(-sc.Diam, -sc.log.Clutch) %>%
  gather(ID, absolute_fitness, -sc.sqrt.Pref, -Foodweb) %>%
  mutate(ID_group = ifelse(ID == "average", "average", "replicate")) %>%
  spread(Foodweb, absolute_fitness) %>%
  mutate(fitness_difference = Complex-Simple)

eggptoid_selection_plot <- eggptoid_plot_df %>%
  ggplot(., aes(x=sc.sqrt.Pref, y=fitness_difference, group=ID, alpha=ID_group, size=ID_group)) +
  geom_line(color=cbPalette[5]) +
  scale_alpha_manual(values=c(1,0.2), guide=FALSE) +
  scale_size_manual(values=c(1.5,0.25), guide=FALSE) +
  xlab("Gall midge preference (SDs)") + 
  ylab(expression(paste(Delta," egg parasitoid survival (complex - simple)"))) +
  scale_x_continuous(breaks=c(-1,-0.5,0,0.5,1), labels = c(-1,-0.5,0,0.5,1)) +
  geom_hline(yintercept=0, linetype="dotted") +
  theme_cowplot(font_size = 12)

eggptoid_selection_plot
save_plot(filename = "selection_on_Platygaster.pdf", plot = eggptoid_selection_plot, base_height = 4) # base_height = 6 is to large for PDF of manuscript
```