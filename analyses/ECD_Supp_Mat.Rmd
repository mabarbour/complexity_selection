---
title: "Predicting the effects of character displacement on food-web dynamics"
author: "Matt Barbour"
output:
  pdf_document:
    df_print: paged
    fig_caption: true
    citation_package: natbib
    includes:  
      in_header: preamble-latex.tex
bibliography: references_ECD_supp_mat.bib
fontsize: 12pt
---

Keywords: competition; eco-evolutionary dynamics; ecological speciation; three-spine stickleback; zooplankton 

## Abstract 

<!-- Ecological character displacement is a key driver of diversification and adaptive radiation; however, there has been little work examining the consequences of character displacement on the dynamics of ecological communities. Given the growing recognition for the role of evolution in structuring ecological communities, understanding how major evolutionary processes impact ecological dynamics is increasingly important. Here, we build a mathematical model to predict how exploitative competition between two consumers for two resources affects the evolution of consumer attack rates, and, in turn, consumer-resource population dynamics. Our model suggested that increasing ecological character displacement decreases the equilibrium density of resources, and with sufficient divergence, results in more oscillatory (destabilizing) consumer-resource dynamics. These results suggest that ecological character displacement can eventually have a negative feedback on food-web persistence in the absence of other processes. --> 

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE)

## Load required libraries
library(deSolve) # numerical integration library
library(rootSolve) # for runsteady integration function
library(pse) # for latin hypercube
library(plyr) # for ldply
library(dplyr) # for manipulating data
library(tidyr) # for tidying data
library(cowplot) # for better base, ggplot graphics

## color palette
cbPalette <- c("#D55E00", "#0072B2", "#009E73")
```

```{r Simulations, include=FALSE, messages=TRUE, cache=TRUE}

#### GET REQUIRED FUNCTIONS ####

source('identify_steady_state.R')
source('eco_evo_sim_function.R')
source('Consumer_Resource_Functions.R')
source('CR_dynamics.R')

#### GENERAL PARAMETERS AND STATE VARIABLES #### 

## Intrinsic growth rates
r <- 1
r1 <- r 
r2 <- r 

## Carrying capacity
K <- 4
K1 <- K
K2 <- K

## Conversion efficiency
e <- 0.8
e11 <- e 
e12 <- e 
e21 <- e 
e22 <- e 

## Mortality rate
m <- 1
m1 <- m
m2 <- m

## General, non-evolving parameter set for 2C,2R model
general_parameters <- data.frame(r1 = r1, r2 = r2, K1 = K1, K2 = K2, e11 = e11, e12 = e12, e21 = e21, e22 = e22, m1 = m1, m2 = m2)

## Attack rate
A <- 2
aii <- A*0.6

## Habitat preference (for LawlorSmith and McCann models)
w <- 0.6
wii <- w
wij <- (1 - w)

## Handling time (only for McCann model)
h <- 0.4
h11 <- h
h12 <- h
h21 <- h
h22 <- h

## State variables
R <- 2
R1 <- R
R2 <- R
C <- 1
C1 <- C
C2 <- C

states_2C_2R <- data.frame(R1 = R1, R2 = R2, C1 = C1, C2 = C2)
states_1C_2R <- data.frame(R1 = R1, R2 = R2, C1 = C1)

## Trade-offs. Borrowed from Sargent and Otto, 2006 Am Nat
a12_tradeoff <- expression(A*(1-(a11m/A)^n)^(1/n)) 
a21_tradeoff <- expression(A*(1-(a22m/A)^n)^(1/n)) 

n_concaveDN <- 1.15
n_linear <- 1
n_concaveUP <- 0.85

concaveDN_df <- data.frame(n = n_concaveDN, aii = seq(0,A,0.01)) %>% mutate(aij = A*(1-(aii/A)^n_concaveDN)^(1/n_concaveDN))
linear_df <- data.frame(n = n_linear, aii = seq(0,A,0.01)) %>% mutate(aij = A*(1-(aii/A)^n_linear)^(1/n_linear))
concaveUP_df <- data.frame(n = n_concaveUP, aii = seq(0,A,0.01)) %>% mutate(aij = A*(1-(aii/A)^n_concaveUP)^(1/n_concaveUP))

bind_rows(concaveDN_df, linear_df, concaveUP_df) %>%
  ggplot(., aes(x=aii, y=aij, color = factor(n))) + geom_line() + ggtitle("Attack rate trade-offs")

bind_rows(concaveDN_df, linear_df, concaveUP_df) %>%
  ggplot(., aes(x=aii/(aii+aij), y=aii+aij, color = factor(n))) + geom_line() + ggtitle("Relationship between specialization and total attack rate")

######################################### MACARTHUR MODEL #######################################################

## Mutant growth rates
mC1_MacArthur <- expression(e11*a11m*R1 + e12*a12m*R2 - m1)
mC2_MacArthur <- expression(e21*a21m*R1 + e22*a22m*R2 - m2)

#### PARAMETERS ####

## Linear
params_2C_2R_MacArthur_linear <- data.frame(general_parameters,
                                            a11 = aii, 
                                            a12 = eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_linear)),                     
                                            a21 = eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_linear)), 
                                            a22 = aii)                      
params_1C_2R_MacArthur_linear <- params_2C_2R_MacArthur_linear[c("r1","r2","K1","K2","e11","e12","a11","a12","m1")]


## concaveDN
params_2C_2R_MacArthur_concaveDN <- params_2C_2R_MacArthur_linear
params_2C_2R_MacArthur_concaveDN["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveDN))
params_2C_2R_MacArthur_concaveDN["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveDN))
params_1C_2R_MacArthur_concaveDN <- params_2C_2R_MacArthur_concaveDN[c("r1","r2","K1","K2","e11","e12","a11","a12","m1")]

## concaveUP
params_2C_2R_MacArthur_concaveUP <- params_2C_2R_MacArthur_linear
params_2C_2R_MacArthur_concaveUP["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveUP))
params_2C_2R_MacArthur_concaveUP["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveUP))
params_1C_2R_MacArthur_concaveUP <- params_2C_2R_MacArthur_concaveUP[c("r1","r2","K1","K2","e11","e12","a11","a12","m1")]

#### SIMULATIONS ####

## Linear
sim_2C_2R_MacArthur_linear <- eco_evo_CR(init_parameters = params_2C_2R_MacArthur_linear, 
                                init_states = states_2C_2R, 
                                eco_CR_model = MacArthur_2C_2R, 
                                AD_CR_models = c(mC1_MacArthur, mC2_MacArthur),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_linear))
sim_1C_2R_MacArthur_linear <- eco_evo_CR(init_parameters = params_1C_2R_MacArthur_linear, 
                                init_states = states_1C_2R, 
                                eco_CR_model = MacArthur_1C_2R, 
                                AD_CR_models = c(mC1_MacArthur),
                                species_traits = c(1), 
                                eco_param_names = c("a11"), 
                                eco_tradeoff_names = c("a12"),  
                                evo_param_names = c("a11m"),  
                                evo_tradeoff_names = c("a12m"), 
                                tradeoff_functions = c(a12_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_linear))

## concaveDN
sim_2C_2R_MacArthur_concaveDN <- eco_evo_CR(init_parameters = params_2C_2R_MacArthur_concaveDN, 
                                init_states = states_2C_2R, 
                                eco_CR_model = MacArthur_2C_2R, 
                                AD_CR_models = c(mC1_MacArthur, mC2_MacArthur),
                                species_traits = c(1,2), 
                                eco_param_names = c("a11","a22"), 
                                eco_tradeoff_names = c("a12","a21"),  
                                evo_param_names = c("a11m","a22m"),  
                                evo_tradeoff_names = c("a12m","a21m"), 
                                tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveDN))
sim_1C_2R_MacArthur_concaveDN <- eco_evo_CR(init_parameters = params_1C_2R_MacArthur_concaveDN, 
                                init_states = states_1C_2R, 
                                eco_CR_model = MacArthur_1C_2R, 
                                AD_CR_models = c(mC1_MacArthur),
                                species_traits = c(1), 
                                eco_param_names = c("a11"), 
                                eco_tradeoff_names = c("a12"),  
                                evo_param_names = c("a11m"),  
                                evo_tradeoff_names = c("a12m"), 
                                tradeoff_functions = c(a12_tradeoff),
                                extra_tradeoff_params = c(A=A, n=n_concaveDN))
## concaveUP
sim_2C_2R_MacArthur_concaveUP <- eco_evo_CR(init_parameters = params_2C_2R_MacArthur_concaveUP, 
                                       init_states = states_2C_2R, 
                                       eco_CR_model = MacArthur_2C_2R, 
                                       AD_CR_models = c(mC1_MacArthur, mC2_MacArthur),
                                       species_traits = c(1,2), 
                                       eco_param_names = c("a11","a22"), 
                                       eco_tradeoff_names = c("a12","a21"),  
                                       evo_param_names = c("a11m","a22m"),  
                                       evo_tradeoff_names = c("a12m","a21m"), 
                                       tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_concaveUP))
sim_1C_2R_MacArthur_concaveUP <- eco_evo_CR(init_parameters = params_1C_2R_MacArthur_concaveUP, 
                                       init_states = states_1C_2R, 
                                       eco_CR_model = MacArthur_1C_2R, 
                                       AD_CR_models = c(mC1_MacArthur),
                                       species_traits = c(1), 
                                       eco_param_names = c("a11"), 
                                       eco_tradeoff_names = c("a12"),  
                                       evo_param_names = c("a11m"),  
                                       evo_tradeoff_names = c("a12m"), 
                                       tradeoff_functions = c(a12_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_concaveUP))

######################################### LAWLOR SMITH COARSE-GRAIN MODEL #######################################################


## Mutant growth rates
mC1_LawlorSmith <- expression(e11*w11*a11m*R1 + e12*w12*a12m*R2 - m1)
mC2_LawlorSmith <- expression(e21*w21*a21m*R1 + e22*w22*a22m*R2 - m2)

#### PARAMETERS ####

## Linear
params_2C_2R_LawlorSmith_linear <- data.frame(general_parameters,
                                              a11 = aii,
                                              a12 = eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_linear)), 
                                              a21 = eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_linear)), 
                                              a22 = aii,
                                              w11 = wii, 
                                              w12 = wij, 
                                              w21 = wij,
                                              w22 = wii)
params_1C_2R_LawlorSmith_linear <- params_2C_2R_LawlorSmith_linear[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22")]


## concaveDN
params_2C_2R_LawlorSmith_concaveDN <- params_2C_2R_LawlorSmith_linear
params_2C_2R_LawlorSmith_concaveDN["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveDN))
params_2C_2R_LawlorSmith_concaveDN["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveDN))
params_1C_2R_LawlorSmith_concaveDN <- params_2C_2R_LawlorSmith_concaveDN[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22")]

## concaveUP
params_2C_2R_LawlorSmith_concaveUP <- params_2C_2R_LawlorSmith_linear
params_2C_2R_LawlorSmith_concaveUP["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveUP))
params_2C_2R_LawlorSmith_concaveUP["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveUP))
params_1C_2R_LawlorSmith_concaveUP <- params_2C_2R_LawlorSmith_concaveUP[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22")]

#### SIMULATIONS ####

## Linear
sim_2C_2R_LawlorSmith_linear <- eco_evo_CR(init_parameters = params_2C_2R_LawlorSmith_linear, 
                                       init_states = states_2C_2R, 
                                       eco_CR_model = LawlorSmith_2C_2R, 
                                       AD_CR_models = c(mC1_LawlorSmith, mC2_LawlorSmith),
                                       species_traits = c(1,2), 
                                       eco_param_names = c("a11","a22"), 
                                       eco_tradeoff_names = c("a12","a21"),  
                                       evo_param_names = c("a11m","a22m"),  
                                       evo_tradeoff_names = c("a12m","a21m"), 
                                       tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_linear))
sim_1C_2R_LawlorSmith_linear <- eco_evo_CR(init_parameters = params_1C_2R_LawlorSmith_linear, 
                                       init_states = states_1C_2R, 
                                       eco_CR_model = LawlorSmith_1C_2R, 
                                       AD_CR_models = c(mC1_LawlorSmith),
                                       species_traits = c(1), 
                                       eco_param_names = c("a11"), 
                                       eco_tradeoff_names = c("a12"),  
                                       evo_param_names = c("a11m"),  
                                       evo_tradeoff_names = c("a12m"), 
                                       tradeoff_functions = c(a12_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_linear))

## concaveDN
# max mut iter reach!
sim_2C_2R_LawlorSmith_concaveDN <- eco_evo_CR(init_parameters = params_2C_2R_LawlorSmith_concaveDN, 
                                       init_states = states_2C_2R, 
                                       eco_CR_model = LawlorSmith_2C_2R, 
                                       AD_CR_models = c(mC1_LawlorSmith, mC2_LawlorSmith),
                                       species_traits = c(1,2), 
                                       eco_param_names = c("a11","a22"), 
                                       eco_tradeoff_names = c("a12","a21"),  
                                       evo_param_names = c("a11m","a22m"),  
                                       evo_tradeoff_names = c("a12m","a21m"), 
                                       tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_concaveDN))
# note that although the max mutation iterations are reached, the evolving parameters appear to oscillate near high values, i.e. they are effectively at an ESS
plot(sim_2C_2R_LawlorSmith_concaveDN[,c("a11","a22")]) 
plot(sim_2C_2R_LawlorSmith_concaveDN[,c("a11","a22")], xlim=c(1.85,1.95)) 

sim_1C_2R_LawlorSmith_concaveDN <- eco_evo_CR(init_parameters = params_1C_2R_LawlorSmith_concaveDN, 
                                       init_states = states_1C_2R, 
                                       eco_CR_model = LawlorSmith_1C_2R, 
                                       AD_CR_models = c(mC1_LawlorSmith),
                                       species_traits = c(1), 
                                       eco_param_names = c("a11"), 
                                       eco_tradeoff_names = c("a12"),  
                                       evo_param_names = c("a11m"),  
                                       evo_tradeoff_names = c("a12m"), 
                                       tradeoff_functions = c(a12_tradeoff),
                                       extra_tradeoff_params = c(A=A, n=n_concaveDN))
## concaveUP
sim_2C_2R_LawlorSmith_concaveUP <- eco_evo_CR(init_parameters = params_2C_2R_LawlorSmith_concaveUP, 
                                        init_states = states_2C_2R, 
                                        eco_CR_model = LawlorSmith_2C_2R, 
                                        AD_CR_models = c(mC1_LawlorSmith, mC2_LawlorSmith),
                                        species_traits = c(1,2), 
                                        eco_param_names = c("a11","a22"), 
                                        eco_tradeoff_names = c("a12","a21"),  
                                        evo_param_names = c("a11m","a22m"),  
                                        evo_tradeoff_names = c("a12m","a21m"), 
                                        tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                        extra_tradeoff_params = c(A=A, n=n_concaveUP))
sim_1C_2R_LawlorSmith_concaveUP <- eco_evo_CR(init_parameters = params_1C_2R_LawlorSmith_concaveUP, 
                                        init_states = states_1C_2R, 
                                        eco_CR_model = LawlorSmith_1C_2R, 
                                        AD_CR_models = c(mC1_LawlorSmith),
                                        species_traits = c(1), 
                                        eco_param_names = c("a11"), 
                                        eco_tradeoff_names = c("a12"),  
                                        evo_param_names = c("a11m"),  
                                        evo_tradeoff_names = c("a12m"), 
                                        tradeoff_functions = c(a12_tradeoff),
                                        extra_tradeoff_params = c(A=A, n=n_concaveUP))

######################################### MCCANN MODEL #######################################################


## Mutant growth rates
mC1_McCann <- expression(e11*(((w11 * R1)/(w11 * R1 + w12 * R2)) * a11m * R1)/(1 + ((w11 * R1)/(w11 * R1 + w12 * R2)) * a11m * h11 * R1 + ((w12 * R2)/(w11 * R1 + w12 * R2)) * a12m * h12 * R2) + e12*(((w12 * R2)/(w11 * R1 + w12 * R2)) * a12m * R2)/(1 + ((w11 * R1)/(w11 * R1 + w12 * R2)) * a11m * h11 * R1 + ((w12 * R2)/(w11 * R1 + w12 * R2)) * a12m * h12 * R2) - m1)
mC2_McCann <- expression(e21*(((w21 * R1)/(w21 * R1 + w22 * R2)) * a21m * R1)/(1 + ((w21 * R1)/(w21 * R1 + w22 * R2)) * a21m * h21 * R1 + ((w22 * R2)/(w21 * R1 + w22 * R2)) * a22m * h22 * R2) + e22*(((w22 * R2)/(w21 * R1 + w22 * R2)) * a22m * R2)/(1 + ((w21 * R1)/(w21 * R1 + w22 * R2)) * a21m * h21 * R1 + ((w22 * R2)/(w21 * R1 + w22 * R2)) * a22m * h22 * R2) - m2)


#### PARAMETERS ####

## Linear
params_2C_2R_McCann_linear <- data.frame(general_parameters,
                                         a11 = aii,
                                         a12 = eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_linear)), 
                                         a21 = eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_linear)), 
                                         a22 = aii,
                                         w11 = wii, 
                                         w12 = wij, 
                                         w21 = wij,
                                         w22 = wii,
                                         h11 = h11,
                                         h12 = h12,
                                         h21 = h21,
                                         h22 = h22)
                                            
params_1C_2R_McCann_linear <- params_2C_2R_McCann_linear[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22","h11","h12","h21","h22")]


## concaveDN
params_2C_2R_McCann_concaveDN <- params_2C_2R_McCann_linear
params_2C_2R_McCann_concaveDN["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveDN))
params_2C_2R_McCann_concaveDN["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveDN))
params_1C_2R_McCann_concaveDN <- params_2C_2R_McCann_concaveDN[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22","h11","h12","h21","h22")]

## concaveUP
params_2C_2R_McCann_concaveUP <- params_2C_2R_McCann_linear
params_2C_2R_McCann_concaveUP["a12"] <- eval(a12_tradeoff, data.frame(A=A, a11m=aii, n=n_concaveUP))
params_2C_2R_McCann_concaveUP["a21"] <- eval(a21_tradeoff, data.frame(A=A, a22m=aii, n=n_concaveUP))
params_1C_2R_McCann_concaveUP <- params_2C_2R_McCann_concaveUP[c("r1","r2","K1","K2","e11","e12","a11","a12","m1","w11","w12","w21","w22","h11","h12","h21","h22")]

#### SIMULATIONS ####

## Linear
sim_2C_2R_McCann_linear <- eco_evo_CR(init_parameters = params_2C_2R_McCann_linear, 
                                         init_states = states_2C_2R, 
                                         eco_CR_model = McCann_2C_2R, 
                                         AD_CR_models = c(mC1_McCann, mC2_McCann),
                                         species_traits = c(1,2), 
                                         eco_param_names = c("a11","a22"), 
                                         eco_tradeoff_names = c("a12","a21"),  
                                         evo_param_names = c("a11m","a22m"),  
                                         evo_tradeoff_names = c("a12m","a21m"), 
                                         tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                         extra_tradeoff_params = c(A=A, n=n_linear))
sim_1C_2R_McCann_linear <- eco_evo_CR(init_parameters = params_1C_2R_McCann_linear, 
                                         init_states = states_1C_2R, 
                                         eco_CR_model = McCann_1C_2R, 
                                         AD_CR_models = c(mC1_McCann),
                                         species_traits = c(1), 
                                         eco_param_names = c("a11"), 
                                         eco_tradeoff_names = c("a12"),  
                                         evo_param_names = c("a11m"),  
                                         evo_tradeoff_names = c("a12m"), 
                                         tradeoff_functions = c(a12_tradeoff),
                                         extra_tradeoff_params = c(A=A, n=n_linear))

## concaveDN
# max mut iter
sim_2C_2R_McCann_concaveDN <- eco_evo_CR(init_parameters = params_2C_2R_McCann_concaveDN, 
                                         init_states = states_2C_2R, 
                                         eco_CR_model = McCann_2C_2R, 
                                         AD_CR_models = c(mC1_McCann, mC2_McCann),
                                         species_traits = c(1,2), 
                                         eco_param_names = c("a11","a22"), 
                                         eco_tradeoff_names = c("a12","a21"),  
                                         evo_param_names = c("a11m","a22m"),  
                                         evo_tradeoff_names = c("a12m","a21m"), 
                                         tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                         extra_tradeoff_params = c(A=A, n=n_concaveDN))
# note that although the max mutation iterations are reached, the evolving parameters appear to oscillate near high values. i.e. they are effectively at an ESS
plot(sim_2C_2R_McCann_concaveDN[,c("a11","a22")]) 
plot(sim_2C_2R_McCann_concaveDN[,c("a11","a22")], xlim=c(1.85,1.95)) 

sim_1C_2R_McCann_concaveDN <- eco_evo_CR(init_parameters = params_1C_2R_McCann_concaveDN, 
                                         init_states = states_1C_2R, 
                                         eco_CR_model = McCann_1C_2R, 
                                         AD_CR_models = c(mC1_McCann),
                                         species_traits = c(1), 
                                         eco_param_names = c("a11"), 
                                         eco_tradeoff_names = c("a12"),  
                                         evo_param_names = c("a11m"),  
                                         evo_tradeoff_names = c("a12m"), 
                                         tradeoff_functions = c(a12_tradeoff),
                                         extra_tradeoff_params = c(A=A, n=n_concaveDN))
## concaveUP
sim_2C_2R_McCann_concaveUP <- eco_evo_CR(init_parameters = params_2C_2R_McCann_concaveUP, 
                                          init_states = states_2C_2R, 
                                          eco_CR_model = McCann_2C_2R, 
                                          AD_CR_models = c(mC1_McCann, mC2_McCann),
                                          species_traits = c(1,2), 
                                          eco_param_names = c("a11","a22"), 
                                          eco_tradeoff_names = c("a12","a21"),  
                                          evo_param_names = c("a11m","a22m"),  
                                          evo_tradeoff_names = c("a12m","a21m"), 
                                          tradeoff_functions = c(a12_tradeoff, a21_tradeoff),
                                          extra_tradeoff_params = c(A=A, n=n_concaveUP))
sim_1C_2R_McCann_concaveUP <- eco_evo_CR(init_parameters = params_1C_2R_McCann_concaveUP, 
                                          init_states = states_1C_2R, 
                                          eco_CR_model = McCann_1C_2R, 
                                          AD_CR_models = c(mC1_McCann),
                                          species_traits = c(1), 
                                          eco_param_names = c("a11"), 
                                          eco_tradeoff_names = c("a12"),  
                                          evo_param_names = c("a11m"),  
                                          evo_tradeoff_names = c("a12m"), 
                                          tradeoff_functions = c(a12_tradeoff),
                                          extra_tradeoff_params = c(A=A, n=n_concaveUP))
```

```{r Organize_Simulation_Data, include=FALSE, cache=TRUE}

## Gather data. Note different formula for effective attack rate of consumer 1 "a_eff_C1". This accounts for the differences between fine- and coarse-grained environments
sim_data <- bind_rows(
  mutate(sim_2C_2R_MacArthur_linear, Model = "MacArthur", n = n_linear, Competitor = "Yes", a_eff_C1 = a11+a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_MacArthur_linear, Model = "MacArthur", n = n_linear, Competitor = "No", a_eff_C1 = a11+a12, Ctot = C1),
  mutate(sim_2C_2R_MacArthur_concaveDN, Model = "MacArthur", n = n_concaveDN, Competitor = "Yes", a_eff_C1 = a11+a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_MacArthur_concaveDN, Model = "MacArthur", n = n_concaveDN, Competitor = "No", a_eff_C1 = a11+a12, Ctot = C1),
  mutate(sim_2C_2R_MacArthur_concaveUP, Model = "MacArthur", n = n_concaveUP, Competitor = "Yes", a_eff_C1 = a11+a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_MacArthur_concaveUP, Model = "MacArthur", n = n_concaveUP, Competitor = "No", a_eff_C1 = a11+a12, Ctot = C1),
  mutate(sim_2C_2R_LawlorSmith_linear, Model = "LawlorSmith", n = n_linear, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_LawlorSmith_linear, Model = "LawlorSmith", n = n_linear, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1),
  mutate(sim_2C_2R_LawlorSmith_concaveDN, Model = "LawlorSmith", n = n_concaveDN, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_LawlorSmith_concaveDN, Model = "LawlorSmith", n = n_concaveDN, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1),
  mutate(sim_2C_2R_LawlorSmith_concaveUP, Model = "LawlorSmith", n = n_concaveUP, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_LawlorSmith_concaveUP, Model = "LawlorSmith", n = n_concaveUP, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1),
  mutate(sim_2C_2R_McCann_linear, Model = "McCann", n = n_linear, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_McCann_linear, Model = "McCann", n = n_linear, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1),
  mutate(sim_2C_2R_McCann_concaveDN, Model = "McCann", n = n_concaveDN, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_McCann_concaveDN, Model = "McCann", n = n_concaveDN, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1),
  mutate(sim_2C_2R_McCann_concaveUP, Model = "McCann", n = n_concaveUP, Competitor = "Yes", a_eff_C1 = w11*a11+w12*a12, Ctot = C1+C2), 
  mutate(sim_1C_2R_McCann_concaveUP, Model = "McCann", n = n_concaveUP, Competitor = "No", a_eff_C1 = w11*a11+w12*a12, Ctot = C1)) 

#### PREDICTING EFFECTS OF CHARACTER DISPLACEMENT ON C-R DYNAMICS ####

tradeoff_df <- bind_rows(mutate(concaveDN_df, n = n_concaveDN), 
                         mutate(linear_df, n = n_linear), 
                         mutate(concaveUP_df, n = n_concaveUP)) %>%
  data.frame(., general_parameters) %>%
  mutate(a11 = aii, a12 = aij, a21 = aij, a22 = aii,
         w11 = wii, w12 = wij, w21 = wij, w22 = wii)

## MacArthur
MacArthur_displacements <- bind_rows(
  mutate(sim_2C_2R_MacArthur_linear, Model = "MacArthur", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_MacArthur_linear)), ], 
  mutate(sim_1C_2R_MacArthur_linear, Model = "MacArthur", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_MacArthur_linear)), ],
  mutate(sim_2C_2R_MacArthur_concaveDN, Model = "MacArthur", n = n_concaveDN, Competitor = "Yes")[c(1,nrow(sim_2C_2R_MacArthur_concaveDN)), ], 
  mutate(sim_1C_2R_MacArthur_concaveDN, Model = "MacArthur", n = n_concaveDN, Competitor = "No")[c(1,nrow(sim_1C_2R_MacArthur_concaveDN)), ],
  mutate(sim_2C_2R_MacArthur_concaveUP, Model = "MacArthur", n = n_concaveUP, Competitor = "Yes")[c(1,nrow(sim_2C_2R_MacArthur_concaveUP)), ], 
  mutate(sim_1C_2R_MacArthur_concaveUP, Model = "MacArthur", n = n_concaveUP, Competitor = "No")[c(1,nrow(sim_1C_2R_MacArthur_concaveUP)), ]) 
MacArthur_displacements$Time <- rep(c("Begin","End"),6)

MacArthur_2C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:a22), init_states = states_2C_2R, eco_CR_model = MacArthur_2C_2R)
MacArthur_1C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:a12), init_states = states_1C_2R, eco_CR_model = MacArthur_1C_2R)

## Lawlor Smith
LawlorSmith_displacements <- bind_rows(
  mutate(sim_2C_2R_LawlorSmith_linear, Model = "LawlorSmith", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_LawlorSmith_linear)), ], 
  mutate(sim_1C_2R_LawlorSmith_linear, Model = "LawlorSmith", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_LawlorSmith_linear)), ],
  mutate(sim_2C_2R_LawlorSmith_concaveDN, Model = "LawlorSmith", n = n_concaveDN, Competitor = "Yes")[c(1,nrow(sim_2C_2R_LawlorSmith_concaveDN)), ], 
  mutate(sim_1C_2R_LawlorSmith_concaveDN, Model = "LawlorSmith", n = n_concaveDN, Competitor = "No")[c(1,nrow(sim_1C_2R_LawlorSmith_concaveDN)), ],
  mutate(sim_2C_2R_LawlorSmith_concaveUP, Model = "LawlorSmith", n = n_concaveUP, Competitor = "Yes")[c(1,nrow(sim_2C_2R_LawlorSmith_concaveUP)), ], 
  mutate(sim_1C_2R_LawlorSmith_concaveUP, Model = "LawlorSmith", n = n_concaveUP, Competitor = "No")[c(1,nrow(sim_1C_2R_LawlorSmith_concaveUP)), ]) 
LawlorSmith_displacements$Time <- rep(c("Begin","End"),6)

LawlorSmith_2C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:w22), init_states = states_2C_2R, eco_CR_model = LawlorSmith_2C_2R)
LawlorSmith_1C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:a12, w11, w12), init_states = states_1C_2R, eco_CR_model = LawlorSmith_1C_2R)

## McCann
McCann_displacements <- bind_rows(
  mutate(sim_2C_2R_McCann_linear, Model = "McCann", n = n_linear, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_linear)), ], 
  mutate(sim_1C_2R_McCann_linear, Model = "McCann", n = n_linear, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_linear)), ],
  mutate(sim_2C_2R_McCann_concaveDN, Model = "McCann", n = n_concaveDN, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_concaveDN)), ], 
  mutate(sim_1C_2R_McCann_concaveDN, Model = "McCann", n = n_concaveDN, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_concaveDN)), ],
  mutate(sim_2C_2R_McCann_concaveUP, Model = "McCann", n = n_concaveUP, Competitor = "Yes")[c(1,nrow(sim_2C_2R_McCann_concaveUP)), ], 
  mutate(sim_1C_2R_McCann_concaveUP, Model = "McCann", n = n_concaveUP, Competitor = "No")[c(1,nrow(sim_1C_2R_McCann_concaveUP)), ]) 
McCann_displacements$Time <- rep(c("Begin","End"),6)

McCann_2C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:w22), init_states = states_2C_2R, eco_CR_model = McCann_2C_2R)
McCann_1C_2R_tradeoff_dynamics <- CR_dynamics(init_parameters = select(tradeoff_df, r1:a12, w11, w12), init_states = states_1C_2R, eco_CR_model = McCann_1C_2R)

```

## Motivation 

<!-- ECD as an important eco-evolutionary feedback -->

Ecological character displacement is thought to be a key evolutionary process in the diversification of species and consequently the generation of biodiversity (Schluter 2000; Pfennig and Pfennig 2010; Stuart and Losos 2013). Ecological character displacement describes the “process of phenotypic evolution in a species generated or maintained by [exploitative] resource competition with one or more coexisting species” (Schluter 2000). Over the past 40 years, a large body of theoretical (e.g. Lawlor and Smith 1976; Abrams 1986; Doebeli 1996; Taper and Case 1985) and empirical (reviewed in: Schluter 2000; Dayan and Simberloff 2005; Stuart and Losos 2013) work has been generated to understand the scenarios under which exploitative competition for resources leads to the divergence of consumer foraging traits. The general result emerging from these studies is that, if resources are nutritionally substitutable and there is no other strong source of density dependence acting on consumers (Abrams 1986; OTHER ABRAMS PAPER), then resource competition drives the divergence of consumer foraging traits (Lawlor and Smith 1976; Taper and Case 1985).

Another key insight emerging from past work is that character displacement is not simply driven by ecological differences, but also drives further ecological differentiation (cite?). This insight emerged from theoretical work that explicitly accounted for resource dynamics when modeling character displacement. If, for example, resources are treated as constants, the optimal strategy for each consumer species is unaffected by the presence or absence of a competitor.  

This is because character divergence reduces interspecific competition relative to intraspecific competition, facilitating consumer coexistence.

In other words, ecological character displacement is the result of an eco-evolutionary feedback between consumers. 

<!-- ECD on consumer coexistence -->

The consequence of this eco-evolutionary feedback for consumers has been well characterized  

<!-- ECD effect on consumer-resource interactions -->

Yet, although resources mediate this eco-evolutionary feedback between consumers, the consequences of character displacement on consumer-resource interactions and food-web dynamics has received, surprisingly, little attention.


<!-- Ecological character displacement is not simply driven by ecological differences but also drives further ecological differentiation. In other words, ecological character displacement embodies an eco-evolutionary feedback between consumers. Character divergence in foraging traits also has ecological consequences, in that it promotes stable coexistence between competing consumers. 

Yet, although the process of ecological character displacement is driven by consumers competing for shared resources (i.e. exploitative competition), the consequences of character displacement on consumer-resource interactions and food-web dynamics has received, suprisingly, little attention. -->

<!-- the interplay between competition and trait change, and hence is strongly dependent on resource availability, little of the work to date has explicitly considered how character displacement impacts other species within the community. Similarly, research on food-web dynamics has largely ignored the potential role of evolution in altering interactions and stability (Fussmann et al. 2007). Given the emerging evidence that evolutionary processes can drive ecological dynamics (Hairston et al. 2005, Post et al. 2008, Harmon et al. 2009, Schoener 2011, Rudman et al. 2015), understanding the ecological consequences of character displacement is an important step in investigating how evolutionary processes affect food-web dynamics. -->

<!-- Ecological character displacement has typically been considered to be a stabilizing factor in communities (Lawlor and Smith 1976). This is because divergence in foraging traits is thought to reduce the strength of interspecific competition between consumers. Reducing the strength of interspecific competition relative to intraspecific competition is a stabilizing force in consumer-resource systems. Consumer specialization on distinct resources suggests that there are niche differences between consumers. Mathematically, this is also often assumed to be the case, because using techniques such as evolutionary invasion analysis describe the ability for a consumer with a mutant allele to increase in abundance when rare, a demographic signature of niche differentiation. Therefore, if both consumers are able to invade when rare, then this suggests that they can coexist. On the other hand, relatively specialized consumers have also been shown to be a strongly stabilizing force in food webs (McCann et al. 2005). This is because these more specialized consumers may generate asynchrony in the dynamics of patchily distributed resources. This asynchrony in resources then permits consumers to move to habitat patches with higher resource densities after they have depleted the resources in a different patch. If, for example, the consumers were not specialized, then the resources would exhibit the same dynamics, so when the resources at low densities, consumers would be unable to switch to alternative resources, which would cause the consumer populations to crash, and oscillate more with their resources (McCann et al. 2005). Consequently, whether ecological character displacement will tend to stabilize (via asynchronous resource dynamics) or destabilize (via increased interaction strength) food webs is unclear. 

On the other hand, ecological character displacement often results in the evolution of characters that enhance a consumer’s ability to capture resources, which tends to destabilize consumer-resource interactions (Murdoch et al. 2003; McCann 2011). This occurs because increases in a consumer’s attack rate results in the resource being suppressed well below its carrying capacity, which if sufficient enough, can generate oscillations, and hence less stable, consumer-resource dynamics (Rosenzweig 1971; Murdoch et al. 2003). Experimental decreases in interaction strength between consumers and resources has been shown to promote coexistence between consumers and resources (Luckinbill 1973). Moreover, there is broad support that specialized consumers, since they are tightly coupled to their resources, tend to exhibit consumer-resource cycles, whereas this is not the case for generalists (Murdoch et al. 2002). Therefore, although evolutionary responses to exploitative competition may reduce the strength of interactions between consumers, they ultimately increase the strength of interactions with their resources which can destabilize the direct consumer-resource interaction (rather than the indirect consumer-consumer interaction). While prior models of character displacement have included more realistic functional responses and spatial relationships between consumers and resources, they have focused more on whether these factors alter patterns of character displacement rather than the effects of character displacement on the stability of the ecological community. As a consequence, it is currently unclear whether ecological character displacement has a net stabilizing or destabilizing effect on ecological communities. 

Here, we address this knowledge gap by building a mathematical model to examine how ecological character displacement affects consumer-resource dynamics. We then compared the predictions from our model to field data from one of the most well-studied examples of ecological character displacement in a natural system, threespine stickleback in lakes of southern British Columbia. We specifically sought to address two questions: (1) How does exploitative competition between two consumers for two resources affect the evolution of consumer attack rates? (2) How does the evolution of consumer attack rates affect community stability? --> 

## Model of resource competition

To examine how ecological character displacement affects consumer-resource interactions and food-web dynamics, I analyzed a continuous-time model of two consumers ($C_1,C_2$) competing for two shared resources ($R_1,R_2$): 

$$\frac{dR_1}{dt}=r_1K_1(1-\frac{R_1}{K_1})-F_{11}(R_1)C_1-F_{21}(R_1)C_2$$
$$\frac{dR_2}{dt}=r_2K_2(1-\frac{R_2}{K_2})-F_{12}(R_2)C_1-F_{22}(R_2)C_2$$
$$\frac{dC_1}{dt}=e_{11}F_{11}(R_1)C_1+e_{12}F_{12}(R_2)C_1-m_1C_1$$
$$\frac{dC_2}{dt}=e_{21}F_{21}(R_1)C_2+e_{22}F_{22}(R_2)C_2-m_2C_2$$

where $r_i$ represents the intrinsic growth rate of resource $i$, $K_i$ represents the carrying capacity of resource $i$, $e_{ji}$ represents the conversion efficiency of resource $i$ into consumer $j$, and $m_j$ represents the mortality rate of consumer $j$. $F_{ji}(R_i)$ represents consumer $j$'s feeding rate (i.e. functional response) on resource $i$. This model is a useful characterization of a scenario where consumers compete for two distinct resources (e.g. zooplankton and benthic invertebrates) rather than if resources are better characterized by a continuous trait distribution (e.g. seed size, see @Taper1985 for an example). In the scenario where consumer feeding rates increase linearly with resource density, such that $F_{ji}(R_i)=a_{ji}R_i$ where $a_{ji}$ is the attack rate of consumer $j$ on resource $i$, then this model becomes MacArthur's model of resource competition (@MacArthur1972). The evolution of consumer attack rates in this model (and several extensions) have been analyzed in detail (@Lawlor1976; @Abrams1986). The general result of these analyses is that divergent character displacement in attack rates is an inevitable outcome of resource competition. <!-- In other words, the presence of a competitor causes consumers to evolve more specialized attack rates ($\frac{a_{ii}}{a_{ii}+a_{ij}}$) compared to when no competitor is present. -->

Here, I examine the effects of this inevitable divergence in attack rates on food-web dynamics. In particular, I examine how divergence in attack rates affect resource densities as well as the local stability of both resources and consumers. I do this by (i) deriving analytical expressions for the relationship between attack rates and food-web dynamics in different foraging scenarios and (ii) simulating the effects of competition on the eco-evolutionary dynamics of consumers and resources. For these simulations, I used an Adaptive Dynamics approach. At each evolutionary time step, I created a mutant consumer by randomly choosing a consumer and modifying its attack rate on one resource by either subtracting or adding a small constant <!-- (0.001 in the following simulations) -->with equal probability. The mutant's attack rate on the other resource was determined by the shape of the tradeoff (details below). Assuming this mutant consumer is rare, I then determined whether the mutant had higher relative fitness than the resident consumer, and thus could invade and replace the resident consumer. If the mutant was able to invade, I updated the attack rate of the resident consumer to the mutant attack rate and allowed consumer and resource dynamics to reach a steady state. I then repeated the simulation up to 10,000 times, which was sufficient for consumers to either reach an evolutionary stable strategy (ESS, @Smith1973) or an evolutionary limit (e.g. $\frac{a_{ii}}{a_{ii}+a_{ij}}$ is constrained to a maximum of 1 and minimum of 0). I show that the consequences of character displacement on food-web dynamics are not intuitive and depend critically on the foraging scenario and tradeoff in consumer attack rates.


## Effect of character displacement on resource densities

I start by examing the effects of character displacement on the density of resources at equilibrium, which will also set the stage for a later analysis of food-web stability. In particular, I examine two different foraging scenarios: one where consumers forage for both resources simultaneously (e.g. @MacArthur1972) and one where they cannot because resources occur in distinct habitats (e.g. @Lawlor1976; @McCann2005). I say consumers have undergone divergent character displacement if there evolved attack rates are more specialized, defined as $|\frac{a_{ii}}{a_{ii}+a_{ij}}-0.5|$, when evolving with a competing consumer.     

### Consumers forage for both resources simultaneously

An inherent assumption in MacArthur's model of resource competition is that consumers can forage for both resources simultaneously. In essence, this implies that both resources occur within the same habitat. To gain analytical insight to this scenario, I assume that resources are equivalent ($r=r_1=r_2$ and $K=K_1=K_2$) as well as consumers ($e=e_{11}=e_{12}=e_{21}=e_{22}$; $m=m_1=m_2$), except that consumer attack rates are mirror images of each other ($a_{ii}=a_{11}=a_{22}$; $a_{ij}=a_{12}=a_{21}$). While this scenario is arguably simplistic, it isolates the effect of character displacement rather than any dependence on inherent differences in consumers or resources. I show that when both consumers and resources are present that the density of resources at equilibrium are equivalent ($R=R_1=R_2$) and are determined by the following equation (*Mathematica* file with derivation available upon request):

$$\hat{R}=\frac{1}{a_{ii}+a_{ij}}\cdot\frac{m}{e}$$
Note that a key determinant of resource density is the consumer's total attack rate, $a_{ii}+a_{ij}$. Since the total attack rate is in the denominator, this implies that resource densities will decrease if evolution favors an increase in total attack rate. I assume that consumers are not 'Darwinian demons' (@Law1979) and thus the evolution of their attack rates are subject to certain constraints. I modelled these constraints such that $\big(a_{ii}/{A}\big)^n+\big(a_{ij}/{A}\big)^n=1$, where $A$ is the total investment in attack rates and $n$ describes the shape of the tradeoff (@Sargent2006). This function has the useful property that it differentiates between cases where intermediate combinations of $a_{ii}$ and $a_{ij}$ are higher, on average, than the extremes (when $n>1$, green line in Fig. \ref{fig:Tradeoff}) or, conversely, where the two extremes are higher, on average, than intermediate investments (when $n<1$, orange line Fig. \ref{fig:Tradeoff}). When $n=1$, the tradeoff function is linear, and all combinations of $a_{ii}$ and $a_{ij}$ have the same total attack rate (blue line in Fig. \ref{fig:Tradeoff}).

```{r Tradeoff, echo=FALSE, fig.cap="\\label{fig:Tradeoff}Tradeoff forms for consumer attack rates."}
tradeoff_plot <- bind_rows(concaveDN_df, linear_df, concaveUP_df) %>%
  ggplot(., aes(x=aii, y=aij, color = factor(n))) + 
  geom_line() + 
  xlab(expression(a[ii])) +
  ylab(expression(a[ij])) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  

tradeoff_plot
```


Previous work has shown that consumers undergo divergent character displacement regardless of the shape of the tradeoff (@Lawlor1976; @Abrams1986). Interestingly, I find that the shape of the tradeoff qualitatively affects the relationship between character displacement and resource density (Fig. \ref{fig:MacArthur_Resources}). For example, if consumer's are constrained by a linear tradeoff (blue lines), then there is no net change in total attack rate (Fig. \ref{fig:MacArthur_Resources}A) and character displacement has no effect on resource densities (Fig. \ref{fig:MacArthur_Resources}B). If the tradeoff is concave down (green lines), then resource abundances can actually increase under character displacement (Fig. \ref{fig:MacArthur_Resources}B). This is because the total attack rate of consumers is maximized at intermediate values ($a_{ii}=a_{ij}$) and decreases as consumers diverge (Fig. \ref{fig:MacArthur_Resources}A). Note that detecting this effect in nature would likely be difficult, since a concave-down tradeoff results in relatively small displacement relative to other tradeoff shapes (@Lawlor1976; green points in Fig. \ref{fig:MacArthur_Resources}A,B). When the tradeoff is concave up (orange lines), character displacement suppresses resource densities due to the increase in total attack rates (Fig. \ref{fig:MacArthur_Resources}A,B). Although the equation I derived for resource density was for the scenario where both consumers and both resources are present, it predicts well the density of resources when a single consumer reaches its ESS (triangles on respective colored lines in Fig. \ref{fig:MacArthur_Resources}B). This is because a single consumer evolves to be a generalist that has equal attack rates on each resource (triangles at 0.5 along x-axis in Fig. \ref{fig:MacArthur_Resources}A), resulting in equivalent resource densities. 


```{r MacArthur_Resources, echo=FALSE, fig.cap="\\label{fig:MacArthur_Resources}Effect of character displacement on total attack rates (A) and resource densities (B) when consumers can forage for both resources simultaneously."}
Mac_attack <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=aii+aij, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements, Time=="End"), aes(x = a11/(a11+a12), y=a11+a12, fill=factor(n), shape=Competitor), size=5, color="black") + #, show.legend=FALSE) +
  #geom_point(data = filter(MacArthur_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=a11+a12, fill=factor(n), shape=Competitor), size=1.5, color="black") +
  ylab(expression(a[ii]+a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Mac_resources <- cbind.data.frame(tradeoff_df, MacArthur_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=5, color="black") + #, show.legend=FALSE) +
  #geom_point(data = filter(MacArthur_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=1.5, color="black") +
  ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Mac_plots <- plot_grid(Mac_attack + theme(legend.position = "none"), Mac_resources, 
                       ncol=2, labels = "AUTO", rel_widths = c(0.65,1))
Mac_plots
```

### Consumers *cannot* forage for resources simultaneously

Most models of character displacement have assumed a scenario where consumers can forage for both resources simultaneously (e.g. @Taper1985; @Abrams1986). This assumption may be valid for some foraging scenarios (e.g. Darwin's finches foraging for seeds); however, in many situations consumers forage for resources that occur in different habitats, and thus cannot forage for both simultaneosly. The only character displacement model that I am aware of that modeled resources in different habitats was one examined by @Lawlor1976. This model takes the same form as the previous model, except now the consumer's feeding rate takes the form:

$$F_{ji}(R_i)=w_{ji}a_{ji}R_i$$

where $w_{ji}$ represents the proportion of time consumer $j$ spends foraging in a habitat where only resource $j$ is found (i.e. habitat preference). Note that since $w_{ji}$ is a proportion that $w_{jj}=1-w_{ji}$. As with attack rates, I assume that consumer habitat preferences are mirror images of each other ($w=w_{11}=w_{22}$). 

@Lawlor1976 found that consumers still underwent divergent character displacement regardless of whether consumers could or could not forage for resources simultaneously. I find that the foraging scenario qualitatively affects the relationship between character displacement and resource densities. To demonstrate this, note that again resource densities are equivalent at equilibrium ($R=R_1=R_2$ when both consumers and resources present), but are now determined by the following equation (*Mathematica* file with derivation available upon request):

$$\hat{R}=\frac{1}{wa_{ii}+(1-w)a_{ij}}\cdot\frac{m}{e}$$

This equation implies that if consumers evolve to become specialists on resources that occur in their preferred habitat (e.g. $w>0.5$ and $a_{ii}>a_{ij}$), then character displacement will always increase the effective attack rate of consumers ($wa_{ii}+(1-w)a_{ij}$), regardless of the tradeoff (Fig. \ref{fig:LS_Resources}A). Thus, character displacement always results in resource suppression if consumers are competing for resources that occur in different habitats (Fig. \ref{fig:LS_Resources}B). Note that the shape of the tradeoff can modify the effect of character displacement. This is not so much due to the tradeoff affecting the magnitude of displacement (it does, but the effect is minor), but because the form of the tradeoff affects resource abundances when a single consumer has reached its ESS (triangles in Fig. \ref{fig:LS_Resources}B). In contrast, resource densities reach a similar value when consumers evolve in the presence of a competitor (circles in Fig. \ref{fig:LS_Resources}B), because character displacement tends to reach a constraint of complete specialization. 

These results do lead to an interesting prediction that could be tested either experimentally or with field data. If consumers are competing for resources that occur in different habitats, then greater character displacement corresponds to a greater decrease in resource densities (line trajectories in Fig. \ref{fig:LS_Resources}B). This prediction likely only applies to comparisons within species where there is likely little difference in the shape of the tradeoff among populations. 

It is worth noting that in this foraging scenario, resource densities are consistently higher at the single consumer ESS compared to the predictions I derived for when both consumers are present (deviation of triangles from respective colored lines in Fig. \ref{fig:LS_Resources}B). This is likely because consumers actually evolve to be slightly specialized on the resources that occur in their non-preferred habitat (deviation of triangles from 0.5 along x-axis in Fig. \ref{fig:LS_Resources}B). <!-- I will revisit this subtle point when I examine the effects of character displacement on food-web stability. -->

```{r LS_Resources, echo=FALSE, fig.cap="\\label{fig:LS_Resources}Effect of character displacement on effective attack rates (A) and resource densities (B) when consumers cannot forage for resources simultaneously."}
LS_attack <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=wii*aii+wij*aij, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements, Time=="End"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=5, color="black") + #, show.legend=FALSE) +
  #geom_point(data = filter(LawlorSmith_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=1.5, color="black") +
  ylab(expression(w*a[ii]+(1-w)*a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

LS_resources <- cbind.data.frame(tradeoff_df, LawlorSmith_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, color=factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=5, color="black") + #, show.legend=FALSE) +
  #geom_point(data = filter(LawlorSmith_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=1.5, color="black") +
  ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21)) +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

LS_plots <- plot_grid(LS_attack + theme(legend.position = "none"), LS_resources, 
                      ncol=2, labels = "AUTO", rel_widths = c(0.65,1))
LS_plots
```

The effect of the foraging scenario on the relationship between character displacement and resource densities appears to be quite general. For example, even if I consider a more realistic consumer functional response (derived by @McCann2005):

$$F_{ii}(R_i,R_j)=\frac{a_{ii}W_{ii}R_i}{1+a_{ii}hW_{ii}R_i+a_{ij}hW_{ij}R_j}$$

where consumer feeding rates on resource $i$ are influenced by both resource densities; saturate as resource densities increase (due to handling time $h$); and consumer habitat preferences are modified by relative resource densities, such that:

$$W_{ii}=\frac{wR_i}{wR_i+(1-w)R_j}$$ 

I still observe the same qualitative relationship between character displacement and resource suppression (Fig. \ref{fig:McCann_Resources} in Appendix). This is because resource competition always leads to character divergence and equilibrium resource densities are governed by similar dynamics  (*Mathematica* file with derivations available upon request):

$$\hat{R}=\frac{1}{wa_{ii}+(1-w)a_{ij}}\cdot\frac{m}{e-hm}$$

<!-- This more realistic consumer functional response does actually make an interesting evolutionary prediction that differs from the scenario where consumer feeding rate scales linearly with resource density. Specifically, a consumer's ESS in the absence of competition will remain slightly more specialized on the resources that occur in their preferred habitats. This is in contrast to the prediction when feeding rates scale linearly with resource density, where consumers evolve to be slightly more specialized on resources occurring in their non-preferred habitats. An important caveat for these predictions is that my model does not allow habitat preferences to evolve, which would likely alter these predictions. -->

## Effect of character displacement on food-web stability

Of the prior models of character displacement, only @Lawlor1976 examine the effect of character displacement on the ecological stability of the system. They conducted a detailed theoretical analysis of three different metrics of stability: (i) stable coexistence of consumers, defined as the mutual invasibility of each consumer; (ii) global stability of consumers, defined as the continued coexistence of both consumers when resource dynamics are perturbed; and (iii) local stability, defined as the rate at which the four-species food web returned to equilibrium after a small perturbation to species abundances. Note that the first two metrics correspond to the stable coexistence of consumers, while the third metric measures the stability of the entire food web. @Lawlor1976 found that character displacement enhanced the stable coexistence of consumers, yet had a small negative effect on the local stability of the food web. 

@Lawlor1976's work gave fundamental insight to the effect of character displacement on ecological stability; however, none of their stability analyses compared food webs with and without a competing consumer. Such comparisons are necessary for inferring the effects of ecological character displacement, a point that has been made clear in the criteria to demonstrate character displacement (@Schluter2000; @Schluter1992). In fact, the first two metrics of stability can only be assessed when both consumers are present because it examines the effect of divergence on coexistence, which requires both consumers to be present. In contrast, local stability can be compared in food webs with and without a competing consumer, and thus provides a useful benchmark for examining the effects of character displacement on food-web stability.   

Below, I plot the results from the same simulations I did previously except now local stability ($-1\times\operatorname{Re}(\lambda_{max})$) is on the y-axis (Fig. \ref{fig:Stability}). In general, I find that resource supression goes hand-in-hand with local stability, a tendency that has been noted by others (@Murdoch2003; @McCann2011). Whenever character displacement results in resource suppression, I observe a decrease in local stability (Fig. \ref{fig:Stability}). This is not simply a consequence of having an additional consumer in the system, but emerges from the eco-evolutionary feedback between character displacement and resource suppression (compare initial (small points) with evolved strategies (large points), Fig. \ref{fig:Stability}). Note that I reach the same fundamental conclusions when I incorporated a more realistic functional response for the consumers (Fig. \ref{fig:Stability_McCann} in Appendix).

```{r Stability, echo=FALSE, fig.cap="\\label{fig:Stability}Effect of character displacement on local stability when consumers can (A) and cannot (B) forage for both resources simultaneously. Small and large points correspond to initial and evolved strategies, respectively."}
Stability_Mac <- cbind.data.frame(tradeoff_df, MacArthur_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=-1*max.Re.eigen, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(MacArthur_displacements, Time=="End"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=5, color="black", show.legend=FALSE) +
  geom_point(data = filter(MacArthur_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=1.5, color="black") +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  ylab(expression(-1%*%"Re"(lambda[max]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Stability_LS <- cbind.data.frame(tradeoff_df, LawlorSmith_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=-1*max.Re.eigen, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(LawlorSmith_displacements, Time=="End"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=5, color="black", show.legend=FALSE) +
  geom_point(data = filter(LawlorSmith_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=1.5, color="black") +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  ylab(expression(-1%*%"Re"(lambda[max]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Stability_plots <- plot_grid(Stability_Mac + theme(legend.position = "none"), Stability_LS + theme( axis.title.y = element_blank()),
                             ncol = 2, labels = "AUTO", rel_widths = c(0.75,1))
Stability_plots
```

I conducted the previous simulations on a scenario where the food web remains locally stable ($\operatorname{Re}(\lambda_{max})<0$). Is it possible that character displacement would ever result in a locally unstable food web? To gain analytical insight to this question, I examined the conditions governing the local stability of the four-species food web when consumers exhibit a more realistic functional response (@McCann2005). I show that the four-species food web will transition from having a locally stable equilibrium to a limit cycle under the following conditions (*Mathematica* file with derivation available upon request):

$$wa_{ii}+(1-w)a_{ij} > \frac{e+hm}{hK(e-hm)}$$

Previously, I showed that character displacement always increases the effective attack rate of consumers ($wa_{ii}+(1-w)a_{ij}$), regardless of the the shape of the tradeoff (Fig. \ref{fig:LS_Resources}A). Thus, character displacement is capable of pushing food webs to a point where they are locally unstable.

## Predictions for threespine stickleback

The scenario where the relationship between character displacement and resource suppression is the strongest is when the tradeoff in attack rates is concave-up and consumers are competing for resources that occur in different habitats (orange points in Fig. \ref{fig:LS_Resources}B and Fig. \ref{fig:McCann_Resources}B). Prior work in threespine stickleback suggests that the evolution of stickleback attack rates are constrained by a concave-up tradeoff (@Schluter1993; @Arnegard2014) and that stickleback ecotypes are competing for resources that occur in different habitats (benthic vs. limnetic, @Schluter1992). Thus, I predict that ecological character displacement in sticklebacks would suppress resource densities and decrease local stability. 

While measuring resource densities is relatively straightforward, measuring stability is notoriously difficult. One of the more easy to acquire empirical metrics of stability is the coefficient of variation ($CV=\frac{\sigma}{\mu}$) as this only requires measurements of resource (or consumer) densities over time. Interestingly, there is a close correspondence between the coefficient of variation and the local stability of a food web (@Gellner2016). <!-- This close correspondence emerges from the fact that stochastic perturbations in resource (or consumer) densities will determine the variability in abundances. And since food webs are constantly buffeted by stochastic processes in the real world, I expect that my predictions using local stability would correspond to the $CV$ of resources (or consumers). -->Thus, I predict that character displacement in threespine stickleback will increase the $CV$ of resource (or consumer) densities.

Consumer and resource densities in these dynamical models can be interpreted from either a population or biomass perspective (@Yodzis1992; @Murdoch2003; @McCann2011). For the stickleback system, you have data on seasonal dynamics of resources in terms of both abundances and biomass. Within a season, I do not expect stickleback abundances to be coupled to the abundances of zooplankton and benthic invertebrates, given that stickleback reproduce annually whereas zooplankton and benthic invertebrates can reproduce many times within a season. Instead, I expect that stickleback biomass will be coupled to the biomass of zooplankton and benthic invertebrates within a season. This is because there will be lots of young stickleback at the beginning of the season, and they will eat a lot of resources and grow in size as the season progresses. If this is true, I also expect to see the largest negative effect of stickleback on resource densities late in the season.   

### Other relevant points

Although I used an Adaptive Dynamics approach here, I expect that these theoretical predictions would apply to models that assumed a different genetic architecture of attack rates (e.g. quantitative genetics). I expect this because, time and time again, models that explicitly include resource dynamics inevitably show that resource competition results in divergent character displacement, regardless of the genetic architecture of traits (see synthesis by @Taper1985). Finally, my conclusions only apply to biological resources that are nutritionally substitutable. It would be interesting to extend these current analyses to non-substitutable resources where convergent character displacement is expected (@Abrams1987; @Fox2008).

## Acknowledgement

The content of this paper was greatly enhanced by numerous conversations with Seth Rudman. Sally Otto provided much help in early analyses of the mathematical model and I would not have been able to take the theory as far as I did without her guidance and her pushing me.

## Appendix: More realistic functional response

```{r McCann_Resources, echo=FALSE, fig.cap="\\label{fig:McCann_Resources}Effect of character displacement on total attack rates (A) and resource densities (B) when consumers exhibit a more realistic functional response."}
McCann_attack <- ggplot(tradeoff_df, aes(x=aii/(aii+aij), y=wii*aii+wij*aij, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements, Time=="End"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=5, color="black") + #, show.legend=FALSE) +
  #geom_point(data = filter(McCann_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=w11*a11+w12*a12, fill=factor(n), shape=Competitor), size=1.5, color="black") +
  ylab(expression(w*a[ii]+(1-w)*a[ij])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

McCann_resources <- cbind.data.frame(tradeoff_df, McCann_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=R1+R2, color = factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements, Time=="End"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=5, color="black") + #, show.legend=FALSE) +
  #geom_point(data = filter(McCann_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=R1+R2, fill=factor(n), shape=Competitor), size=1.5, color="black") +
  ylab(expression(R[i]+R[j])) +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

McCann_plots <- plot_grid(McCann_attack + theme(legend.position = "none"), McCann_resources, 
                          ncol=2, labels = "AUTO", rel_widths = c(0.65,1))
McCann_plots
```


```{r Stability_McCann, echo=FALSE, fig.cap="\\label{fig:Stability_McCann}Effect of character displacement on local stability when consumers exhibit a more realistic functional response."}
Stability_McCann <- cbind.data.frame(tradeoff_df, McCann_2C_2R_tradeoff_dynamics) %>%
  ggplot(., aes(x=aii/(aii+aij), y=-1*max.Re.eigen, color=factor(n))) + 
  geom_line() +
  geom_point(data = filter(McCann_displacements, Time=="End"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=5, color="black", show.legend = FALSE) +
  geom_point(data = filter(McCann_displacements, Time=="Begin"), aes(x = a11/(a11+a12), y=-1*max.Re.eigen, fill=factor(n), shape=Competitor), size=1.5, color="black") +
  xlab(expression(frac(a[ii],a[ii]+a[ij]))) +
  ylab(expression(-1%*%"Re"(lambda[max]))) +
  scale_shape_manual(values=c(24,21))  +
  scale_color_manual(name="Tradeoff (n)", values=cbPalette)  +
  scale_fill_manual(name="Tradeoff (n)", values=cbPalette) +
  guides(fill = guide_legend(override.aes=list(shape=21)))

Stability_McCann
```

