---
title: "Tutorial: Calculating Selection"
output: html_notebook
---


```{r Preliminaries, message=FALSE, warning=FALSE, include=FALSE}
## LOAD REQUIRED LIBRARIES & SET OPTIONS ----
library(tidyverse)
library(cowplot) # pretty default ggplots
library(broom) # for tidying multiple linear models

## LOAD & MANAGE DATASET ----

gall_selection.df <- read_csv("gall_selection_data.csv") %>%
  mutate(Plant_Position = as.character(Plant_Position),
         Gall_Number = as.character(Gall_Number),
         Treatment.focus = as.character(Treatment.focus),
         Treatment = as.character(Treatment),
         Genotype = as.character(Genotype),
         Gall_Letter = as.character(Gall_Letter)) %>%
  unite(Gall_ID, Gall_Number, Gall_Letter, remove = FALSE) %>%
  
  # subset data for analysis
  filter(phenology == "early", Location == "tree",
         platy > 0 | ectos > 0 | pupa > 0) %>%                  # eliminate unknown sources of mortality
  mutate(gall_survival = as.numeric(ifelse(pupa > 0, 1, 0)),
         egg_parasitoid = as.numeric(ifelse(platy > 0, 1, 0))) 

# create a new dataset that compares phenotypic distributions before and after selection
galls_before <- mutate(gall_selection.df, Timing="Before")
galls_after <- filter(gall_selection.df, gall_survival == 1) %>% mutate(Timing = "After")

gall_diffs.df <- bind_rows(galls_before, galls_after)
```

Examine distributions of phenotypes
```{r}
size_means <- gall_selection.df %>%
  group_by(Treatment.focus) %>%
  summarise_at(vars(Gall_Height_mm, gall_survival), funs(mean))
size_means

gall_selection.df %>%
  ggplot(., aes(x=Gall_Height_mm, fill=Treatment.focus)) +
  geom_density(alpha=0.5) +
  geom_vline(data=size_means, aes(xintercept=Gall_Height_mm, color=Treatment.focus), linetype="dotted")

# according to Shapiro-Wilk though, its non-normal (P < 0.05). 
# other transformations don't help, I think the raw distribution looks pretty good though
shapiro.test(gall_selection.df$Gall_Height_mm)
shapiro.test(sqrt(gall_selection.df$Gall_Height_mm))
shapiro.test(log(gall_selection.df$Gall_Height_mm))

## AGGREGATE DATA AT GALL LEVEL ----
# for analyzing the number of individuals per gall

agg_gall.level <- gall_selection.df %>%
  group_by(Treatment.focus, Genotype, Plant_Position, Gall_Number) %>%
  summarise_at(vars(gall_survival, gall_individuals, Gall_Height_mm, Density_per_100_shoots), funs(mean)) %>%
  mutate(log.gall_individuals = log(gall_individuals))

# I added a log-transformed 'gall individuals' because it helps normalize the distribution a bit
shapiro.test(agg_gall.level$gall_individuals)
shapiro.test(sqrt(agg_gall.level$gall_individuals))
shapiro.test(log(agg_gall.level$gall_individuals))

# calculate average number of individuals per gall in each treatment
indiv_means <- agg_gall.level %>%
  group_by(Treatment.focus) %>%
  summarise_at(vars(gall_individuals, log.gall_individuals, gall_survival), funs(mean))
indiv_means

agg_gall.level %>%
  ggplot(., aes(x=gall_individuals, fill=Treatment.focus)) +
  geom_histogram(position='identity', alpha=0.5, binwidth=1) +
  geom_vline(data=indiv_means, aes(xintercept=gall_individuals, color=Treatment.focus), linetype="dotted") +
  scale_x_continuous(breaks=c(1:10))

agg_gall.level %>%
  ggplot(., aes(x=log.gall_individuals, fill=Treatment.focus)) +
  geom_histogram(position='identity', alpha=0.5) +
  geom_vline(data=indiv_means, aes(xintercept=log.gall_individuals, color=Treatment.focus), linetype="dotted")


## AGGREGATE DATA AT TREE LEVEL ----
# for gall density analysis

agg_tree.level <- gall_selection.df %>%
  group_by(Treatment.focus, Genotype, Plant_Position) %>%
  summarise_at(vars(gall_survival, gall_individuals, Gall_Height_mm, Density_per_100_shoots), funs(mean)) %>%
  mutate(sqrt.Density_per_100_shoots = sqrt(Density_per_100_shoots))

# I added a square-root transformation to gall density because it makes the distribution more normal (but not quite)
shapiro.test(agg_tree.level$Density_per_100_shoots)
shapiro.test(sqrt(agg_tree.level$Density_per_100_shoots))
shapiro.test(log(agg_tree.level$Density_per_100_shoots+1))

# calculate the average gall density in each treatment
density_means <- agg_tree.level %>%
  group_by(Treatment.focus) %>%
  summarise_at(vars(Density_per_100_shoots, sqrt.Density_per_100_shoots, gall_survival), funs(mean))
density_means

# plot the distribution of gall density in each treatment
agg_tree.level %>%
  ggplot(., aes(x=Density_per_100_shoots, fill=Treatment.focus)) +
  geom_density(alpha=0.5) +
  geom_vline(data = density_means, aes(xintercept=Density_per_100_shoots, color=Treatment.focus), linetype="dotted")

# plot the distribution of sqrt(gall density) in each treatment
agg_tree.level %>%
  ggplot(., aes(x=sqrt.Density_per_100_shoots, fill=Treatment.focus)) +
  geom_density(alpha=0.5) +
  geom_vline(data = density_means, aes(xintercept=sqrt.Density_per_100_shoots, color=Treatment.focus), linetype="dotted")
```

```{r}
gall_selection.df <- gall_selection.df %>%
  mutate(relative_fitness = ifelse(Treatment.focus=="Control",
                                   gall_survival/filter(size_means, Treatment.focus=="Control")$gall_survival,
                                   gall_survival/filter(size_means, Treatment.focus=="Ectoparasitoid exclusion")$gall_survival))

non_singular <- gall_selection.df %>%
  filter(Plant_Position %in% plants_manygalls) %>%
  group_by(Genotype, Treatment.focus, Plant_Position) %>%
  summarise_at(vars(gall_survival), mean) %>%
  filter(gall_survival > 0 & gall_survival < 1)

size.gradients_plant.level <- gall_selection.df %>%
  filter(Plant_Position %in% non_singular$Plant_Position) %>%
  group_by(Genotype, Treatment.focus, Plant_Position) %>%
  do(model = lm(I(gall_survival/mean(gall_survival)) ~ I(Gall_Height_mm-mean(Gall_Height_mm)), .)) %>%
  tidy(model) %>%
  filter(term != "(Intercept)")

size.gradients_plant.level
summary(lm(estimate ~ Genotype*Treatment.focus, data=size.gradients_plant.level, weights = std.error))
ggplot(size.gradients_plant.level, aes(x=Genotype, y=estimate, fill=Treatment.focus, size=std.error)) +
  geom_point()
```



Understanding the causes of selection in different environments is not straightforward.

The most straightforward way to measure selection is the *selection differential*, which corresponds to the difference in mean phenotype before vs. after selection: $$s=\bar{z}^*-\bar{z}$$.


```{r figure: gall size selection differential, echo=FALSE, message=FALSE, warning=FALSE}
size_means_diffs <- gall_diffs.df %>%
  group_by(Timing, Treatment.focus) %>%
  summarise_at(vars(Gall_Height_mm, gall_survival), funs(mean, var, sd)) 
size_means_diffs

size_differentials <- size_means_diffs %>%
  select(Timing, Treatment.focus, Gall_Height_mm_mean) %>%
  spread(Timing, Gall_Height_mm) %>%
  mutate(selection_differential = After - Before)
size_differentials

gall_diffs.df %>%
  ggplot(., aes(x=Gall_Height_mm, fill=Timing)) +
  geom_density(alpha=0.5) +
  geom_vline(data=size_means_diffs, aes(xintercept=Gall_Height_mm_mean, color=Timing), linetype="dashed") +
  facet_wrap(~Treatment.focus, ncol = 1)
```

We find that the selection differential on control trees ($s=$`r round(filter(size_differentials, Treatment.focus=="Control")$selection_differential,2)`) is 43% larger than on treatment trees ($s=$`r round(filter(size_differentials, Treatment.focus=="Ectoparasitoid exclusion")$selection_differential, 2)`). 

We can also look at selection in another way. Let's plot the relationship between absolute fitness and the phenotype.
```{r figure: gall size linear regression, echo=FALSE, message=FALSE, warning=FALSE}
gall_selection.df %>%
  ggplot(., aes(x=Gall_Height_mm - mean(Gall_Height_mm), y=gall_survival, color=Treatment.focus)) +
  geom_smooth(method="lm") +
  geom_jitter(height=0.05, shape=1) +
  geom_hline(data = size_means, aes(yintercept=gall_survival, color=Treatment.focus), linetype="dotted") +
  geom_vline(xintercept=0, color="grey")
```

That's interesting, the slope of absolute fitness as a function of phenotype doesn't look all that different between treatments, but the differences in mean fitness are:
```{r, echo=FALSE, message=FALSE, warning=FALSE}
size_lm <- lm(gall_survival ~ 
                Treatment.focus + 
                I(Gall_Height_mm - mean(Gall_Height_mm)) +  
                Treatment.focus:I(Gall_Height_mm - mean(Gall_Height_mm)), 
              data = gall_selection.df)
summary(size_lm)

size.gradient_lm <- lm(relative_fitness ~ 
                #Treatment.focus + 
                I(Gall_Height_mm - mean(Gall_Height_mm)) +  
                Treatment.focus:I(Gall_Height_mm - mean(Gall_Height_mm)), 
              data = gall_selection.df)
summary(size.gradient_lm)
```

This suggests that the difference in selection between the control and treatment trees is due to differences in fitness between treatments and NOT the relationship between phenotype and fitness. In case you don't believe me, let me convince you that we can recover the selection differentials from a linear model such as this. Note that another way we can define the selection differential is: $$s=\frac{Cov(W,z)}{\bar{W}}$$

where $$W$$ represents absolute fitness and $$z$$ represents the phenotype. In linear model, the regression coefficient $b$ corresponds to: $$b=\frac{Cov(W,z)}{Var(z)}$$

Thus, $$s=b\cdot\frac{Var(z)}{\bar{W}}$$

`r 0.081308*filter(size_means_diffs, Timing=="Before",Treatment.focus=="Control")$Gall_Height_mm_var/filter(size_means_diffs, Timing=="Before",Treatment.focus=="Control")$gall_survival_mean`

```{r figure: gall size logistic regression, echo=FALSE, message=FALSE, warning=FALSE}
binomial_smooth <- function(...) {
  geom_smooth(method = "glm", method.args = list(family = "binomial"), ...)
}

gall_selection.df %>%
  ggplot(., aes(x=Gall_Height_mm - mean(Gall_Height_mm), y=gall_survival, color=Treatment.focus)) +
  binomial_smooth() +
  geom_jitter(height=0.05, shape=1) +
  geom_hline(data = size_means, aes(yintercept=gall_survival, color=Treatment.focus), linetype="dotted") +
  geom_vline(xintercept=0, color="grey")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
indiv_lm <- lm(gall_survival ~ 
                Treatment.focus + 
                I(gall_individuals - mean(gall_individuals)) +  
                Treatment.focus:I(gall_individuals - mean(gall_individuals)), 
              data = agg_gall.level)
summary(indiv_lm)

agg_gall.level <- agg_gall.level %>%
  mutate(relative_fitness = ifelse(Treatment.focus=="Control",
                                   gall_survival/filter(indiv_means, Treatment.focus=="Control")$gall_survival,
                                   gall_survival/filter(indiv_means, Treatment.focus=="Ectoparasitoid exclusion")$gall_survival))

indiv.gradient_lm <- lm(relative_fitness ~ 
                #Treatment.focus + 
                I(gall_individuals - mean(gall_individuals)) +  
                Treatment.focus:I(gall_individuals - mean(gall_individuals)), 
              data = agg_gall.level)
summary(indiv.gradient_lm)
```

```{r figure: gall individuals logistic regression, echo=FALSE, message=FALSE, warning=FALSE}
agg_gall.level %>%
  ggplot(., aes(x=gall_individuals - mean(gall_individuals), y=gall_survival, color=Treatment.focus)) +
  binomial_smooth() +
  geom_jitter(height=0.05, shape=1) +
  #geom_hline(data = size_means, aes(yintercept=gall_survival, color=Treatment.focus), linetype="dotted") +
  geom_vline(xintercept=0, color="grey")
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
density_lm <- lm(gall_survival ~ 
                Treatment.focus + 
                I(Density_per_100_shoots - mean(Density_per_100_shoots)) +  
                Treatment.focus:I(Density_per_100_shoots - mean(Density_per_100_shoots)), 
              data = agg_tree.level)
summary(density_lm)

agg_tree.level <- agg_tree.level %>%
  mutate(relative_fitness = ifelse(Treatment.focus=="Control",
                                   gall_survival/filter(density_means, Treatment.focus=="Control")$gall_survival,
                                   gall_survival/filter(density_means, Treatment.focus=="Ectoparasitoid exclusion")$gall_survival))

density.gradient_lm <- lm(relative_fitness ~ 
                #Treatment.focus + 
                I(Density_per_100_shoots - mean(Density_per_100_shoots)) +  
                Treatment.focus:I(Density_per_100_shoots - mean(Density_per_100_shoots)), 
              data = agg_tree.level)
summary(density.gradient_lm)
```

```{r figure: gall individuals logistic regression, echo=FALSE, message=FALSE, warning=FALSE}
agg_tree.level %>%
  ggplot(., aes(x=Density_per_100_shoots - mean(Density_per_100_shoots), y=gall_survival, color=Treatment.focus)) +
  binomial_smooth() +
  geom_jitter(height=0.05, shape=1) +
  #geom_hline(data = size_means, aes(yintercept=gall_survival, color=Treatment.focus), linetype="dotted") +
  geom_vline(xintercept=0, color="grey")
```



Visually, we can estimate the selection differentials
```{r}
library(gsg)

# why are these different?
gall_selection.df %>%
  group_by(Treatment.focus) %>%
  do(moments = moments.differentials(z = .$Gall_Height_mm - mean(.$Gall_Height_mm), W = .$gall_survival, standardized = FALSE)) %>%
  tidy(moments)

control.diff <- moments.differentials(
  z = filter(gall_selection.df, Treatment.focus=="Control")$Gall_Height_mm,
  W = filter(gall_selection.df, Treatment.focus=="Control")$gall_survival, 
  standardized = FALSE
)
control.diff

treatment.diff <- moments.differentials(
  z = filter(gall_selection.df, Treatment.focus=="Ectoparasitoid exclusion")$Gall_Height_mm,
  W = filter(gall_selection.df, Treatment.focus=="Ectoparasitoid exclusion")$gall_survival, 
  standardized = FALSE
)
treatment.diff




```




## Calculating selection differentials

```{r}


size_lms <- gall_selection.df %>%
  group_by(Treatment.focus) %>%
  do(model = lm(gall_survival ~ I(Gall_Height_mm - mean(Gall_Height_mm)), .)) %>%
  tidy(model)
size_lms

summary(lm(gall_survival ~ I(Gall_Height_mm-mean(Gall_Height_mm)), data = filter(gall_selection.df, Treatment.focus=="Control")))

#size_vars <- gall_selection.df %>%
#  group_by(Treatment.focus) %>%
#  summarise_at(vars(Gall_Height_mm), funs(var,sd))
#size_vars

size_lms %>%
  select(Treatment.focus, term, estimate) %>%
  spread(term, estimate) %>%
  mutate(selection_differential = `I(Gall_Height_mm - mean(Gall_Height_mm))`/`(Intercept)`)


gall_selection.df %>%
  do(model = lm(gall_survival ~ I(Gall_Height_mm - mean(Gall_Height_mm))*Treatment.focus, .)) %>%
  tidy(model)

## calculating selection gradients
gall_selection.df <- gall_selection.df %>%
  mutate(relative_fitness = ifelse(Treatment.focus == "Control", 
                                   gall_survival/filter(size_means, Treatment.focus=="Control")$gall_survival,
                                   gall_survival/filter(size_means, Treatment.focus=="Ectoparasitoid exclusion")$gall_survival))

gall_selection.df %>%
  ggplot(., aes(x=Gall_Height_mm - mean(Gall_Height_mm), y=relative_fitness, color=Treatment.focus)) +
  geom_jitter(height=0.02) +
  geom_smooth(method="lm") + 
  geom_hline(yintercept=1, color="grey", linetype="dotted") +
  geom_vline(xintercept=0, color="grey")

size_gradients <- gall_selection.df %>%
  group_by(Treatment.focus) %>%
  do(model = lm(relative_fitness ~ I(Gall_Height_mm - mean(Gall_Height_mm)), .)) %>%
  tidy(model)
size_gradients


summary(lm(relative_fitness ~ I(scale(Gall_Height_mm)), data = filter(gall_selection.df, Treatment.focus=="Control")))

# for standardized selection gradients
gall_selection.df %>%
  group_by(Treatment.focus) %>%
  do(model = lm(relative_fitness ~ I((Gall_Height_mm - mean(Gall_Height_mm))/sd(Gall_Height_mm)), .)) %>%
  tidy(model)

cov12 <- with(filter(gall_selection.df, Treatment.focus=="Ectoparasitoid exclusion"), cov(relative_fitness, Gall_Height_mm))
sd1 <- with(filter(gall_selection.df, Treatment.focus=="Ectoparasitoid exclusion"), sd(Gall_Height_mm))
var1 <- with(filter(gall_selection.df, Treatment.focus=="Ectoparasitoid exclusion"), var(Gall_Height_mm))
sd2 <- with(filter(gall_selection.df, Treatment.focus=="Ectoparasitoid exclusion"), sd(relative_fitness))

cov12/var1
```

Unstandardized b coefficient is equal to Cov(x,y)/var(x).

$$b=\frac{Cov(x,y)}{Var(x)}$$

Standardized cofficient (Beta) is equal to Cov(x,y)/var(x)SD(x)/SD(y)

$$\beta=\frac{Cov(x,y)}{SD(x)SD(x)}\cdot\frac{SD(x)}{SD(y)}$$

$$w=\frac{W}{\hat{W}}$$

$$s=Cov(w,z)$$
also

$$s=\frac{Cov(W,z)}{\hat{W}}$$

Selection differentials can be calculated as the covariance between the phenotype and absolute fitness, cov(W,z), divided by mean fitness. If we additionally standardize the scale of the phenotype by dividing by its variance, then we also get the selection gradient.


Calculate the selection differentials (difference in means) before and after selection for each treatment.
```{r}
size_means <- gall_diffs.df %>%
  group_by(Timing, Treatment.focus) %>%
  summarise_at(vars(Gall_Height_mm), funs(mean)) %>%
  ungroup() 
size_means

size_diffs <- size_means %>%
  spread(Timing, Gall_Height_mm) %>%
  mutate(selection_differential = After - Before)
size_diffs

gall_diffs.df %>%
  ggplot(., aes(x=Gall_Height_mm, fill=Timing)) +
  geom_density(alpha=0.5) +
  geom_vline(data = size_means, aes(xintercept=Gall_Height_mm, color=Timing), linetype="dotted") +
  facet_wrap(~Treatment.focus, ncol=1)
```

Calculate selection differentials for scaled and normalized traits
```{r}
sc.sqrt.size_means <- gall_diffs.df %>%
  group_by(Timing, Treatment.focus) %>%
  summarise_at(vars(sc.sqrt.Gall_Height_mm), funs(mean)) %>%
  ungroup() 
sc.sqrt.size_means

sc.sqrt.size_diffs <- sc.sqrt.size_means %>%
  spread(Timing, sc.sqrt.Gall_Height_mm) %>%
  mutate(selection_differential = After - Before)
sc.sqrt.size_diffs

gall_diffs.df %>%
  ggplot(., aes(x=sc.sqrt.Gall_Height_mm, fill=Timing)) +
  geom_density(alpha=0.5) +
  geom_vline(data = sc.sqrt.size_means, aes(xintercept=sc.sqrt.Gall_Height_mm, color=Timing), linetype="dotted") +
  facet_wrap(~Treatment.focus, ncol=1)
```

```{r}

gall_selection.df %>%
  group_by(Treatment.focus) %>%
  summarise(covariance = cov(gall_survival, Gall_Height_mm),
            mean_fitness = mean(gall_survival)) %>%
  mutate(selection_differential = covariance/mean_fitness)

gall_selection.df %>%
  group_by(Treatment.focus) %>%
  summarise(covariance = cov(gall_survival, sc.sqrt.Gall_Height_mm),
            mean_fitness = mean(gall_survival)) %>%
  mutate(selection_differential = covariance/mean_fitness)

summary(lm(gall_survival ~ sc.sqrt.Gall_Height_mm, filter(gall_selection.df, Treatment.focus=="Control")))
summary(lm(gall_survival ~ sc.sqrt.Gall_Height_mm, filter(gall_selection.df, Treatment.focus=="Ectoparasitoid exclusion")))

summary(lm(relative_fitness ~ sc.sqrt.Gall_Height_mm, data=filter(size.rel_fitness.df, Treatment.focus=="Control")))
```

NOTE THAT THE SELECTION DIFFERENTIAL SHOULD CORRESPOND TO THE SELECTION GRADIENT?? (ACCORDING TO HUNTER ET AL 2018, EQN. 4)

Calculate selection gradients acting on gall size
```{r}
size.rel_fitness.df <- gall_selection.df %>%
  mutate(relative_fitness = ifelse(Treatment.focus == "Control", gall_survival/control.mean_fitness, gall_survival/treatment.mean_fitness))

size.rel_fitness.df %>%
  ggplot(., aes(x = Gall_Height_mm, y = relative_fitness, color=Treatment.focus)) +
  geom_jitter(shape=1, height = 0.02) +
  geom_hline(yintercept=1, linetype="dotted") +
  geom_smooth(method = "lm")

size.rel_fitness.df %>%
  ggplot(., aes(x = sc.sqrt.Gall_Height_mm, y = relative_fitness, color=Treatment.focus)) +
  geom_jitter(shape=1, height = 0.02) +
  geom_hline(yintercept=1, linetype="dotted") +
  geom_smooth(method = "lm")

size.rel_fitness.lm <- lm(relative_fitness ~ Gall_Height_mm + Gall_Height_mm:Treatment.focus, data=size.rel_fitness.df)
summary(size.rel_fitness.lm)

sc.sqrt.size.rel_fitness.lm <- lm(relative_fitness ~ sc.sqrt.Gall_Height_mm + sc.sqrt.Gall_Height_mm:Treatment.focus, data=size.rel_fitness.df)
summary(sc.sqrt.size.rel_fitness.lm) 
```

NEED TO CALCULATE SELECTION DIFFERENTIALS AT THE FINEST LEVEL, SINCE THAT IS WHERE SURVIVAL IS ZERO OR 1.

Calculate selection differentials for number of individuals per galls
```{r}
agg_gall.level <- gall_selection.df %>%
  group_by(Treatment.focus, Genotype, Plant_Position, Gall_Number) %>%
  summarise_at(vars(gall_survival, gall_individuals, Gall_Height_mm, Density_per_100_shoots), funs(mean)) %>%
  mutate(sc.log.gall_individuals = as.numeric(scale(log(gall_individuals))))

agg_gall.diffs <- bind_rows(
  mutate(agg_gall.level, Timing = "Before"),
  mutate(filter(agg_gall.level, gall_survival == 1), Timing = "After")
)

indiv_means <- agg_gall.diffs %>%
  group_by(Timing, Treatment.focus) %>%
  summarise_at(vars(gall_individuals, sc.log.gall_individuals), mean, na.rm = TRUE) %>%
  ungroup() 
indiv_means

indiv_diffs <- indiv_means %>%
  select(Timing, Treatment.focus, gall_individuals) %>%
  spread(Timing, gall_individuals) %>%
  mutate(selection_differential = After - Before)
indiv_diffs

sc.log.indiv_diffs <- indiv_means %>%
  select(Timing, Treatment.focus, sc.log.gall_individuals) %>%
  spread(Timing, sc.log.gall_individuals) %>%
  mutate(selection_differential = After - Before)
sc.log.indiv_diffs

agg_gall.diffs %>%
  ggplot(., aes(x=gall_individuals, fill=Timing)) +
  geom_density(alpha=0.5) +
  geom_vline(data = indiv_means, aes(xintercept=gall_individuals, color=Timing), linetype="dotted") +
  facet_wrap(~Treatment.focus, ncol=1)

agg_gall.diffs %>%
  ggplot(., aes(x=sc.log.gall_individuals, fill=Timing)) +
  geom_density(alpha=0.5) +
  geom_vline(data = indiv_means, aes(xintercept=sc.log.gall_individuals, color=Timing), linetype="dotted") +
  facet_wrap(~Treatment.focus, ncol=1)
```


Calculate selection gradients acting on number of individuals per gall
```{r}
agg_gall.control.mean_fit <- mean(filter(agg_gall.level, Treatment.focus=="Control")$gall_survival)
agg_gall.treatment.mean_fit <- mean(filter(agg_gall.level, Treatment.focus=="Ectoparasitoid exclusion")$gall_survival)

agg_gall.level <- agg_gall.level %>%
  mutate(relative_fitness = ifelse(Treatment.focus == "Control", 
                                   gall_survival/agg_gall.control.mean_fit,
                                   gall_survival/agg_gall.treatment.mean_fit))

agg_gall.level %>%
  ggplot(., aes(x = gall_individuals, y = relative_fitness, color=Treatment.focus)) +
  geom_jitter(shape=1, height = 0.02) +
  geom_hline(yintercept=1, linetype="dotted") +
  geom_smooth(method = "lm")

agg_gall.level %>%
  ggplot(., aes(x = sc.log.gall_individuals, y = relative_fitness, color=Treatment.focus)) +
  geom_jitter(shape=1, height = 0.02) +
  geom_hline(yintercept=1, linetype="dotted") +
  geom_smooth(method = "lm")

indiv.gradient.lm <- lm(relative_fitness ~ gall_individuals + gall_individuals:Treatment.focus, agg_gall.level)
summary(indiv.gradient.lm)

sc.log.indiv.gradient.lm <- lm(relative_fitness ~ sc.log.gall_individuals + sc.log.gall_individuals:Treatment.focus, agg_gall.level)
summary(sc.log.indiv.gradient.lm)
```

Calculate selection differentials for gall density
```{r}
agg_tree.level <- gall_selection.df %>%
  group_by(Treatment.focus, Genotype, Plant_Position) %>%
  summarise_at(vars(gall_survival, gall_individuals, Gall_Height_mm, Density_per_100_shoots), funs(mean)) %>%
  mutate(sc.sqrt.Density_per_100_shoots = as.numeric(scale(sqrt(Density_per_100_shoots))))

agg_tree.diffs <- bind_rows(
  mutate(agg_tree.level, Timing = "Before"),
  mutate(filter(agg_tree.level, gall_survival == 1), Timing = "After")
)

density_means <- gall_diffs.df %>%
  distinct(Plant_Position, Timing, Treatment.focus, Density_per_100_shoots) %>%
  group_by(Timing, Treatment.focus) %>%
  summarise_at(vars(Density_per_100_shoots), funs(mean)) %>%
  ungroup() 
density_means

density_diffs <- density_means %>%
  spread(Timing, Density_per_100_shoots) %>%
  mutate(selection_differential = After - Before)
density_diffs

gall_diffs.df %>%
  distinct(Plant_Position, Timing, Treatment.focus, Density_per_100_shoots) %>%
  ggplot(., aes(x=Density_per_100_shoots, fill=Timing)) +
  geom_density(alpha=0.5) +
  geom_vline(data = density_means, aes(xintercept=Density_per_100_shoots, color=Timing), linetype="dotted") +
  facet_wrap(~Treatment.focus, ncol=1)
```

Calculate selection gradients acting on gall density
```{r}
agg_tree.level <- gall_selection.df %>%
  group_by(Treatment.focus, Genotype, Plant_Position) %>%
  summarise_at(vars(gall_survival, gall_individuals, Gall_Height_mm, Density_per_100_shoots), funs(mean)) %>%
  mutate(sc.sqrt.Density_per_100_shoots = as.numeric(scale(sqrt(Density_per_100_shoots)))) 

agg_tree.control.mean_fit <- mean(filter(agg_tree.level, Treatment.focus=="Control")$gall_survival)
agg_tree.treatment.mean_fit <- mean(filter(agg_tree.level, Treatment.focus=="Ectoparasitoid exclusion")$gall_survival)

agg_tree.level <- agg_tree.level %>% 
  mutate(relative_fitness = ifelse(Treatment.focus=="Control", 
                                   gall_survival/agg_tree.control.mean_fit, 
                                   gall_survival/agg_tree.treatment.mean_fit))

agg_tree.level %>%
  ggplot(., aes(x = Density_per_100_shoots, y = relative_fitness, color=Treatment.focus)) +
  geom_jitter(shape=1, height = 0.02) +
  geom_hline(yintercept=1, linetype="dotted") +
  geom_smooth(method = "lm")

agg_tree.level %>%
  ggplot(., aes(x = sc.sqrt.Density_per_100_shoots, y = relative_fitness, color=Treatment.focus)) +
  geom_jitter(shape=1, height = 0.02) +
  geom_hline(yintercept=1, linetype="dotted") +
  geom_smooth(method = "lm")

density.gradient.lm <- lm(relative_fitness ~ Density_per_100_shoots + Density_per_100_shoots:Treatment.focus, agg_tree.level)
summary(density.gradient.lm)

sc.sqrt.density.gradient.lm <- lm(relative_fitness ~ sc.sqrt.Density_per_100_shoots + sc.sqrt.Density_per_100_shoots:Treatment.focus, agg_tree.level)
summary(sc.sqrt.density.gradient.lm)
plot(sc.sqrt.density.gradient.lm) # not too bad
```