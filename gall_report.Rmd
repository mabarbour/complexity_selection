---
title: "Distributions of gall phenotypes"
author: "Matt Barbour"
date: "January 29, 2018"
output:
  html_document: default
  html_notebook: default
---

```{r load libraries, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(cowplot)
library(GGally)
```

```{r, message=FALSE, warning=FALSE, include=FALSE}
# Function to return points and geom_smooth allow for the method to be changed
my_fn <- function(data, mapping, method="lm", ...){
      p <- ggplot(data = data, mapping = mapping) + 
      geom_point(shape = 1) + 
      geom_smooth(method=method, ...)
      p
    }
```


```{r load data, message=FALSE, warning=FALSE, include=FALSE}
gall_selection.df <- read_csv("gall_selection_data.csv") %>%
  mutate(Plant_Position = as.factor(Plant_Position),
         Gall_Number = as.factor(Gall_Number),
         Treatment.focus = as.factor(Treatment.focus),
         Treatment = as.factor(Treatment),
         Location = as.factor(Location),
         phenology = as.factor(phenology),
         Genotype = as.factor(Genotype),
         Gall_Letter = as.factor(Gall_Letter)) %>%
  unite(Gall_ID, Gall_Number, Gall_Letter, remove = FALSE) %>%
  
  # subset data for analysis
  filter(phenology == "early", Location == "tree") %>%
  mutate(gall_survival = ifelse(pupa > 0, 1, 0),
         platy_bin = ifelse(platy > 0, 1,0),
         ectos_bin = ifelse(ectos > 0, 1,0))
```

<br>

Here is what the distributions look like for the three gall phenotypes I measured. Sample size (n) corresponds to independent observations (e.g. individual-level for gall size, gall-level for number of individuals, plant-level for density). Dotted lines correspond to the mean phenotype. I plotted number of individuals as a histogram because its distribution is more discrete.
```{r trait distributions, echo=FALSE, message=FALSE, warning=FALSE}
size <- gall_selection.df %>%
  ggplot(., aes(x=Gall_Height_mm)) + geom_density(fill="grey", alpha=0.5) + 
  geom_vline(xintercept = mean(gall_selection.df$Gall_Height_mm), linetype="dotted") +
  geom_text(x=15, y=0.15, label=paste("n=",length(gall_selection.df$Gall_Height_mm))) +
  xlab("Gall size (mm)")

indiv <- gall_selection.df %>%
  distinct(Gall_Number, gall_individuals) %>%
  ggplot(., aes(x=gall_individuals)) + geom_histogram() + 
  geom_vline(xintercept = mean(distinct(gall_selection.df, Gall_Number, gall_individuals)$gall_individuals), linetype="dotted") + 
  scale_x_continuous(breaks=1:10, labels=1:10) + 
  geom_text(x=5, y=200, label=paste("n=",length(distinct(gall_selection.df, Gall_Number, gall_individuals)$gall_individuals))) +
  xlab("Individuals per gall")

dens <- gall_selection.df %>%
  distinct(Plant_Position, Density_per_100_shoots) %>%
  ggplot(., aes(x=Density_per_100_shoots)) + geom_density(fill="grey", alpha=0.5) + 
  geom_vline(xintercept = mean(distinct(gall_selection.df, Plant_Position, Density_per_100_shoots)$Density_per_100_shoots), linetype="dotted") +
  geom_text(x=50, y=0.02, label=paste("n=",length(distinct(gall_selection.df, Plant_Position, Density_per_100_shoots)$Density_per_100_shoots))) +
  xlab("Density (individuals/100 shoots)")

size
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
indiv
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
dens
```

<br>

Below, I've plotted the correlations among these traits. Note that all data points are at the individual-level (n = 1714). 
```{r phenotypic correlations, echo=FALSE, message=FALSE, warning=FALSE}
gall_selection.df %>% 
  select(Size = Gall_Height_mm, Individuals = gall_individuals, Density = Density_per_100_shoots) %>%
  ggpairs(., lower = list(continuous=wrap(my_fn, method="lm")))
```

<br>

These phenotypes also vary substantially among plant genotypes. The boxplots below show the median (black bar), 25th - 75th percentiles (IQR, box edges), 1.5 x IQR (whiskers), and outliers (points).

```{r phenotypes by genotype, echo=FALSE, message=FALSE, warning=FALSE}
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

size.geno <- gall_selection.df %>%
  ggplot(., aes(x=Genotype, y=Gall_Height_mm, fill=Genotype)) + geom_boxplot(outlier.shape = 1, show.legend = F) +
  scale_fill_manual(values=cbPalette) +
  ylab("Gall size (mm)")

indiv.geno <- gall_selection.df %>%
  distinct(Genotype, Gall_Number, gall_individuals) %>%
  ggplot(., aes(x=Genotype, y=gall_individuals, fill=Genotype)) + geom_boxplot(outlier.shape = 1, show.legend = F) +
  scale_fill_manual(values=cbPalette) +
  ylab("Individuals per gall")

dens.geno <- gall_selection.df %>%
  distinct(Genotype, Plant_Position, Density_per_100_shoots) %>%
  ggplot(., aes(x=Genotype, y=Density_per_100_shoots, fill=Genotype)) + geom_boxplot(outlier.shape = 1, show.legend = F) +
  scale_fill_manual(values=cbPalette) +
  ylab("Density (individuals/100 shoots)")

size.geno

#plot_selection <- bind_rows(mutate(gall_selection.df, Selection = "Before selection"),
#                            mutate(filter(gall_selection.df, gall_survival == 1), Selection = "After selection"))
#plot_selection$Selection <- factor(plot_selection$Selection, levels = c("Before selection", "After selection"))
#plot_selection$Treatment.focus_lab <- factor(plot_selection$Treatment.focus, levels = c("Control", "Ectoparasitoid exclusion"), labels=c("Complex","Simple"))
#selection.summary <- group_by(plot_selection, Treatment.focus_lab, Selection) %>% 
#  summarise_at(vars(Gall_Height_mm, gall_individuals, Density_per_100_shoots), mean, na.rm=TRUE)

#size_plot <- ggplot(plot_selection, aes(x=Gall_Height_mm)) + 
#  geom_density(fill="grey", alpha=0.5) + 
#  geom_vline(data = selection.summary, aes(xintercept = Gall_Height_mm), linetype="dotted") +
#  facet_grid(Selection ~ Treatment.focus_lab)
            
#size.genotype_plot <- ggplot(plot_selection, aes(x=Genotype, y=Gall_Height_mm, fill=Selection)) + geom_boxplot() + #facet_wrap(~Treatment.focus_lab, ncol=1)

#plot_grid(size_plot, size.genotype_plot, ncol = 1)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
indiv.geno
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
dens.geno
```


